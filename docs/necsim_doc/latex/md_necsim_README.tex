Version\+: 1.\+0 This project is released under B\+S\+D-\/3 See file {\bfseries L\+I\+C\+E\+N\+S\+E.\+txt} or go to \href{https://opensource.org/licenses/BSD-3-Clause}{\tt here} for full license details.

\subsection*{C\+O\+N\+T\+E\+N\+TS}


\begin{DoxyItemize}
\item {\bfseries I\+N\+T\+R\+O\+D\+U\+C\+T\+I\+ON}
\item {\bfseries I\+N\+S\+T\+R\+U\+C\+T\+I\+O\+NS}
\item {\bfseries R\+E\+Q\+U\+I\+R\+E\+M\+E\+N\+TS}
\item {\bfseries D\+E\+G\+U\+G\+G\+I\+NG}
\item {\bfseries C\+L\+A\+SS D\+E\+S\+C\+R\+I\+P\+T\+I\+O\+NS}
\item {\bfseries K\+N\+O\+WN B\+U\+GS}
\item {\bfseries F\+A\+QS}
\item {\bfseries C\+O\+N\+T\+A\+C\+TS}
\end{DoxyItemize}

\subsection*{I\+N\+T\+R\+O\+D\+U\+C\+T\+I\+ON}

necsim is a generic spatial coalescence simulator for neutral systems. It applies the model to map objects, which can change over time, for a specific set of supplied parameters, and outputs information for each individual to a S\+QL database.

necsim includes functionality for applying varying speciation rates after simulations are complete. This enables the main simulation to be run with the {\itshape minimum} speciation rate required and afterwards analysis can be completed using different speciation rates.

The recommended method of usage is through the pycoalescence package, using a python interface for installation, simulation setup and running. See \href{http://pycoalescence.readthedocs.io/}{\tt here} for more details.

You are free to modify and distribute the code as per the license specified in {\bfseries L\+I\+C\+E\+N\+C\+E.\+txt} to suit any additional neutral simulation requirements (or any other purpose).

\subsection*{I\+N\+S\+T\+R\+U\+C\+T\+I\+O\+NS}

\subsubsection*{Compiling the program}

See the Requirements section for a full list of the necessary prerequisites. Once these are installed, compiling the program should be relatively easy. N\+E\+C\+Sim requires a linker to the boost libraries, as well as the sqlite3 library. It is recommended to run with the maximum optimisation possible.

Additionally, if support is required for tif files (an alternative to importing csv files), the \href{http://www.gdal.org/}{\tt gdal library} is required. See the online documentation for help compiling gdal for your operating system. When compiling using gdal, use the {\ttfamily -\/D with\+\_\+gdal} compilation flag.

For compilation on High Performance Computing (H\+PC) systems, they will likely use intel compilers. The header files for the sqlite and boost packages may need to be copied in to the working directory to avoid problems with linking to libraries. Check the service providers\textquotesingle{} documentation for whether these libraries are already installed on the H\+PC. for the application of different speciation rates.

\subsubsection*{Running simulations}

The routine relies on supplying command line arguments (see below) for all the major simulation variables. Alternatively, supplying a config .txt file and using the command line arguments {\ttfamily ./necsim -\/c /path/to/config.txt} can be used for parsing command line arguments from the text file.

\paragraph*{Command Line Arguments}

The following command line arguments are required. This list can be accessed by running {\ttfamily “./necsim -\/h”} or {\ttfamily ./necsim -\/help}

The command line options to be specified are\+:


\begin{DoxyEnumerate}
\item the seed for the simulation.
\item the simulation task (for file reference).
\item the map config file.
\item the output directory.
\item the minimum speciation rate.
\item the dispersal sigma value.
\item the dispersal tau value.
\item the deme size.
\item the deme sample size.
\item the maximum simulation time (in seconds).
\item the lambda value for moving through non-\/habitat.
\item the temporal sampling file containing tab-\/separated generation values for sampling points in time (null for only sampling the present)
\item the minimum number of species known to exist. (Currently has no effect).
\item (and onwards) speciation rates to apply after simulation.
\end{DoxyEnumerate}

In this set up, the map config file contains a file on each line, with tab separation between the different variables. The \char`\"{}ref\char`\"{} flag contains the object type, followed by all other parameters. An example is given below.

ref=sample\+\_\+grid path=/path/to/file x=100 y=200 mask=/path/to/mask ref=fine\+\_\+map path=/path/to/file x=100 y=200 x\+\_\+off=10 y\+\_\+off=20 ref=pristine\+\_\+fine path=/path/to/file number=n rate=r time=g

Alternatively, by specifying the -\/f flag, (full mode) as the first argument, the program can read in extended command line arguments, which are as followed.


\begin{DoxyEnumerate}
\item the task\+\_\+iter used for setting the seed.
\item the sample grid x dimension
\item the sample grid y dimension
\item the fine map file relative path.
\item the fine map x dimension
\item the fine map y dimension
\item the fine map x offset
\item the fine map y offset
\item the coarse map file relative path.
\item the coarse map x dimension
\item the coarse map y dimension
\item the coarse map x offset
\item the coarse map y offset
\item the scale of the coarse map compared to the fine (10 means resolution of coarse map = 10 x resolution of fine map)
\item the output directory
\item the speciation rate.
\item the dispersal sigma value.
\item the deme size
\item the deme sample size (as a proportion of deme size)
\item the time to run the simulation (in seconds).
\item lambda -\/ the relative cost of moving through non-\/forest
\item the\+\_\+task -\/ for referencing the specific task later on.
\item the minimum number of species the system is known to contain.
\item the pristine fine map file to use
\item the pristine coarse map file to use
\item the rate of forest change from pristine
\item the time (in generations) since the pristine forest was seen.
\item the dispersal tau value (the width of the kernel.
\item the sample mask, with binary 1\+:0 values for areas that we want to sample from. If this is not provided then this will default to mapping the whole area.
\item the link to the file containing every generation that the list should be expanded. This should be in the format of a list.
\item (and onwards) -\/ speciation rates to apply after the simulation is complete.
\end{DoxyEnumerate}

\paragraph*{Config Files}

The program also accepts a config file, specified by running {\ttfamily ./necsim -\/c /path/to/config.txt}. The format of the config file is 
\begin{DoxyCode}
1 rand\_seed = i
2 sample\_x\_dim = i
3 sample\_y\_dim = i
4 fine\_source = /path/to/fine.csv
5 fine\_x\_dim = i
6 fine\_y\_dim = i
7 fine\_x\_offset = i
8 fine\_y\_offset = i
9 coarse\_source = /path/to/coarse.csv
10 coarse\_x\_dim = i
11 coarse\_y\_dim = i
12 coarse\_x\_offset = i
13 coarse\_y\_offset = i
14 coarse\_scale = i
15 output\_dir = /path/to/outdir
16 spec\_rate = d
17 zfat = f
18 deme\_size = i
19 deme\_sample = d
20 wall\_time = i
21 lambda = 1
22 job\_num = i
23 est\_spec = i
24 pristine\_fine\_source = /path/to/pristine/fine.csv
25 pristine\_coarse\_source = /path/to/pristine/coarse.csv
26 forest\_change = d
27 time\_since = f
28 dispersal = f
29 sampledatamask = /path/to/sample/mask.csv
30 time\_config\_file = /path/to/time/file.txt
31 speciationrate1 = d
32 speciationrate2 = d
33 ...
\end{DoxyCode}
 where {\ttfamily i} represents a positive integer, {\ttfamily d} is a decimal value between 0 and 1, and {\ttfamily f} is any positive number (float). Whilst this does help with readability of the code, the order of the arguments is essential at this stage (i.\+e. don\textquotesingle{}t switch the order of the lines). Future versions may alter the system of reading such that the parameters are set according to their key. Any number of speciation rates (or 0) can be at the end of the file.

\paragraph*{Outputs}

Upon successful completion of a simulation, necsim will produce an S\+Q\+Lite database file in the output directory in an S\+Q\+L\+\_\+data folder. This database contains several tables, which can be accessed using a program like \href{http://sqlitebrowser.org/}{\tt DB Browser for S\+Q\+Lite} or Microsoft Access. Alternatively, most programming languages have an S\+Q\+Lite interface (\href{https://cran.r-project.org/web/packages/RSQLite/index.html}{\tt R\+S\+Qlite}, \href{https://docs.python.org/2/library/sqlite3.html}{\tt python sqlite3})


\begin{DoxyItemize}
\item The main table within the database is the S\+P\+E\+C\+I\+E\+S\+\_\+\+L\+I\+ST table, which is the location and inheritence of every lineage recorded. Several other important data structures (such as whether it is a \char`\"{}tip\char`\"{} of the phylogenetic tree of not) which are used when re-\/constructing the species identity.
\item A secondary output from necims is a S\+I\+M\+U\+L\+A\+T\+I\+O\+N\+\_\+\+P\+A\+R\+A\+M\+E\+T\+E\+RS table for identifying the exact parameters with which the model is run.
\item Speciation\+Counter also produces a S\+P\+E\+C\+I\+E\+S\+\_\+\+A\+B\+U\+N\+D\+A\+N\+C\+ES table containing species abundances across the whole sample map, plus (optionally) a table of S\+P\+E\+C\+I\+E\+S\+\_\+\+L\+O\+C\+A\+T\+I\+O\+NS (containing the x,y location of every individual) and F\+R\+A\+G\+M\+E\+N\+T\+\_\+\+A\+B\+U\+N\+D\+A\+N\+C\+ES (species abundances for each habitat fragment separately).
\end{DoxyItemize}

\subsection*{R\+E\+Q\+U\+I\+R\+E\+M\+E\+N\+TS}


\begin{DoxyItemize}
\item The S\+Q\+Lite library available \href{https://www.sqlite.org/download.html}{\tt here}.
\item The Boost library available \href{http://www.boost.org}{\tt here}.
\item The fast-\/cpp-\/csv-\/parser by Ben Strasser, available \href{https://github.com/ben-strasser/fast-cpp-csv-parser}{\tt here}.
\item C++ compiler (such as G\+NU g++) with C++11 support.
\item Access to the relevant folders for Default simulations (see F\+A\+QS).
\end{DoxyItemize}

\subsection*{C\+L\+A\+SS D\+E\+S\+C\+R\+I\+P\+T\+I\+O\+NS}

A brief description of the important classes is given below. Some classes also contain customised exceptions for better tracing of error handling.


\begin{DoxyItemize}
\item The {\ttfamily \hyperlink{class_tree}{Tree}} class.
\begin{DoxyItemize}
\item The most important class!
\item Contains the main setup, run and data output routines.
\item Setup imports the data files from csv (if necessary) and creates the in-\/memory objects for the storing of the coalescence tree and the spatial grid of active lineages. Setup time mostly depends on the size of the csv file being imported.
\item Run continually loops over sucessive coalesence, move or speciation events until all individuals have speciated or coalesced. This is where the majority of the simulation time will be, and is mostly dependent on the number of individuals, speciation rate and size of the spatial grid.
\item At the end of the simulation, the sql\+Create() routine will generate the in-\/memory S\+Q\+Lite database for storing the coalescent tree. It can run multiple times if multiple speciation rates are required. output\+Data() will then be called to create a small csv file containing important information, and output the S\+Q\+Lite database to file if required.
\end{DoxyItemize}
\item The {\ttfamily \hyperlink{class_tree_node}{Tree\+Node}} class
\begin{DoxyItemize}
\item Contains a single record of a node on the phylogenetic tree, to be used in reassembling the tree structure at the end of the simulation.
\item Operations are mostly basic getters and setters, with functionality called from higher-\/level functions.
\item An array of treenodes makes up the {\ttfamily data} object in {\ttfamily \hyperlink{class_tree}{Tree}}.
\end{DoxyItemize}
\item The {\ttfamily \hyperlink{class_data_point}{Data\+Point}} class
\begin{DoxyItemize}
\item Contains a single record of the location of a lineage.
\item An array of datapoints makes up the {\ttfamily active} object in {\ttfamily \hyperlink{class_tree}{Tree}}.
\item {\ttfamily endactive} refers to the number of lineages currently being simulated. After each coalescence or speciation event this will decrease.
\end{DoxyItemize}
\item The {\ttfamily \hyperlink{class_n_rrand}{N\+Rrand}} class
\begin{DoxyItemize}
\item Contains the random number generator, as written by James Rosindell (\href{mailto:j.rosindell@imperial.ac.uk}{\tt j.\+rosindell@imperial.\+ac.\+uk}).
\end{DoxyItemize}
\item The {\ttfamily \hyperlink{class_landscape}{Landscape}} class
\begin{DoxyItemize}
\item Contains the routines for importing and calling values from the map objects.
\item The {\ttfamily get\+Val()} and {\ttfamily run\+Dispersal()} functions can be modified to produce altered dispersal behaviour, or alterations to the structure of the map.
\end{DoxyItemize}
\item The {\ttfamily \hyperlink{class_matrix}{Matrix}} and {\ttfamily \hyperlink{class_row}{Row}} classes
\begin{DoxyItemize}
\item Based on code written by James Rosindell (\href{mailto:j.rosindell@imperial.ac.uk}{\tt j.\+rosindell@imperial.\+ac.\+uk}).
\item Handles indexing of the 2D object plus importing values from a csv file.
\end{DoxyItemize}
\item The {\ttfamily \hyperlink{class_species_list}{Species\+List}} class
\begin{DoxyItemize}
\item Contains the list of individuals, for application in a matrix, to essentially create a 3D array.
\item Handles the positioning of individuals in space within a grid cell.
\end{DoxyItemize}
\item The {\ttfamily \hyperlink{class_config_option}{Config\+Option}} class
\begin{DoxyItemize}
\item Contains basic functions for importing command line arguments from a config file, providing an alternative way of setting up simulations.
\end{DoxyItemize}
\item The {\ttfamily Tree\+List} class
\begin{DoxyItemize}
\item Provides the routines for applying different speciation rates to a phylogenetic tree, to be used either immediately after simulation within necsim, or at a later time using Speciation\+Counter.\+cpp
\end{DoxyItemize}
\end{DoxyItemize}

\subsection*{K\+N\+O\+WN B\+U\+GS}


\begin{DoxyItemize}
\item Simulations run until completion, rather than aiming for a desired number of species. This is an intentional change. Functions related to this functionality remain but are deprecated.
\item Only continuous rectangular fragments are properly calculated. Other shapes must be calculated by post-\/processing.
\item 3 fragments instead of 2 will be calculated for certain adjacent rectangular patches.
\end{DoxyItemize}

\subsection*{F\+A\+QS (W\+IP)}


\begin{DoxyItemize}
\item {\bfseries How do I get started?}
\begin{DoxyItemize}
\item It is recommended to use the \href{http://pycoalescence.readthedocs.io/}{\tt pycoalescence} package which simplifies installation of necsim, setting up and running simulations. This provides a much easier way to get started with necsim.
\end{DoxyItemize}
\item {\bfseries Why can’t I compile the program?}
\begin{DoxyItemize}
\item This could be due to a number of reasons, most likely that you haven’t compiled with access to the lsqlite3 or boost packages. Installation and compilation differs across different systems; for most U\+N\+IX systems, compiling with the linker arguments -\/lsqlite3 -\/lboost\+\_\+filesystem and -\/lboost\+\_\+system will solve problems with the compiler not finding the sqlite or boost header file.
\item Another option could be the potential lack of access to the fast-\/cpp-\/csv-\/parser by Ben Strasser, available \href{https://github.com/ben-strasser/fast-cpp-csv-parser}{\tt here}. If use\+\_\+csv has been defined at the head of the file, try without use\+\_\+csv or download the csv parser and locate the folder within your working directory at compilation.
\end{DoxyItemize}
\item {\bfseries Every time the program runs I get error code X\+XX.}
\begin{DoxyItemize}
\item Check the E\+R\+R\+O\+R\+\_\+\+R\+E\+F.\+txt file for descriptions of the files. Try running in debug mode by compiling with {\ttfamily -\/\+D\+D\+E\+B\+UG} to gain more information on the problem. Check the log output in /logs. It is most likely a problem with the set up of the map data (error checking is not yet properly implemented here).
\end{DoxyItemize}
\end{DoxyItemize}

\subsection*{C\+O\+N\+T\+A\+C\+TS}

Author\+: {\bfseries Samuel Thompson}

Contact\+: \href{mailto:samuelthompson14@imperial.ac.uk}{\tt samuelthompson14@imperial.\+ac.\+uk} -\/ \href{mailto:thompsonsed@gmail.com}{\tt thompsonsed@gmail.\+com}

Institution\+: Imperial College London and National University of Singapore

Based heavily on code by {\bfseries James Rosindell}

Contact\+: \href{mailto:j.rosindell@imperial.ac.uk}{\tt j.\+rosindell@imperial.\+ac.\+uk}

Institution\+: Imperial College London 