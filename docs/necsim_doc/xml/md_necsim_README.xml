<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.11">
  <compounddef id="md_necsim_README" kind="page">
    <compoundname>md_necsim_README</compoundname>
    <title>necsim</title>
    <detaileddescription>
<para>Version: 1.0 This project is released under BSD-3 See file <bold>LICENSE.txt</bold> or go to <ulink url="https://opensource.org/licenses/BSD-3-Clause">here</ulink> for full license details.</para><para><heading level="2">CONTENTS</heading>
</para><para><itemizedlist>
<listitem><para><bold>INTRODUCTION</bold></para></listitem><listitem><para><bold>INSTRUCTIONS</bold></para></listitem><listitem><para><bold>REQUIREMENTS</bold></para></listitem><listitem><para><bold>DEGUGGING</bold></para></listitem><listitem><para><bold>CLASS DESCRIPTIONS</bold></para></listitem><listitem><para><bold>KNOWN BUGS</bold></para></listitem><listitem><para><bold>FAQS</bold></para></listitem><listitem><para><bold>CONTACTS</bold></para></listitem></itemizedlist>
</para><para><heading level="2">INTRODUCTION</heading>
</para><para>necsim is a generic spatial coalescence simulator for neutral systems. It applies the model to map objects, which can change over time, for a specific set of supplied parameters, and outputs information for each individual to a SQL database.</para><para>necsim includes functionality for applying varying speciation rates after simulations are complete. This enables the main simulation to be run with the <emphasis>minimum</emphasis> speciation rate required and afterwards analysis can be completed using different speciation rates.</para><para>The recommended method of usage is through the pycoalescence package, using a python interface for installation, simulation setup and running. See <ulink url="http://pycoalescence.readthedocs.io/">here</ulink> for more details.</para><para>You are free to modify and distribute the code as per the license specified in <bold>LICENCE.txt</bold> to suit any additional neutral simulation requirements (or any other purpose).</para><para><heading level="2">INSTRUCTIONS</heading>
</para><para><heading level="3">Compiling the program</heading>
</para><para>See the Requirements section for a full list of the necessary prerequisites. Once these are installed, compiling the program should be relatively easy. NECSim requires a linker to the boost libraries, as well as the sqlite3 library. It is recommended to run with the maximum optimisation possible.</para><para>Additionally, if support is required for tif files (an alternative to importing csv files), the <ulink url="http://www.gdal.org/">gdal library</ulink> is required. See the online documentation for help compiling gdal for your operating system. When compiling using gdal, use the <computeroutput>-D with_gdal</computeroutput> compilation flag.</para><para>For compilation on High Performance Computing (HPC) systems, they will likely use intel compilers. The header files for the sqlite and boost packages may need to be copied in to the working directory to avoid problems with linking to libraries. Check the service providers&apos; documentation for whether these libraries are already installed on the HPC. for the application of different speciation rates.</para><para><heading level="3">Running simulations</heading>
</para><para>The routine relies on supplying command line arguments (see below) for all the major simulation variables. Alternatively, supplying a config .txt file and using the command line arguments <computeroutput>./necsim -c /path/to/config.txt</computeroutput> can be used for parsing command line arguments from the text file.</para><para><heading level="4">Command Line Arguments</heading>
</para><para>The following command line arguments are required. This list can be accessed by running <computeroutput>“./necsim -h”</computeroutput> or <computeroutput>./necsim -help</computeroutput></para><para>The command line options to be specified are:</para><para><orderedlist>
<listitem><para>the seed for the simulation.</para></listitem><listitem><para>the simulation task (for file reference).</para></listitem><listitem><para>the map config file.</para></listitem><listitem><para>the output directory.</para></listitem><listitem><para>the minimum speciation rate.</para></listitem><listitem><para>the dispersal sigma value.</para></listitem><listitem><para>the dispersal tau value.</para></listitem><listitem><para>the deme size.</para></listitem><listitem><para>the deme sample size.</para></listitem><listitem><para>the maximum simulation time (in seconds).</para></listitem><listitem><para>the lambda value for moving through non-habitat.</para></listitem><listitem><para>the temporal sampling file containing tab-separated generation values for sampling points in time (null for only sampling the present)</para></listitem><listitem><para>the minimum number of species known to exist. (Currently has no effect).</para></listitem><listitem><para>(and onwards) speciation rates to apply after simulation.</para></listitem></orderedlist>
</para><para>In this set up, the map config file contains a file on each line, with tab separation between the different variables. The &quot;ref&quot; flag contains the object type, followed by all other parameters. An example is given below.</para><para>ref=sample_grid path=/path/to/file x=100 y=200 mask=/path/to/mask ref=fine_map path=/path/to/file x=100 y=200 x_off=10 y_off=20 ref=pristine_fine path=/path/to/file number=n rate=r time=g</para><para>Alternatively, by specifying the -f flag, (full mode) as the first argument, the program can read in extended command line arguments, which are as followed.</para><para><orderedlist>
<listitem><para>the task_iter used for setting the seed.</para></listitem><listitem><para>the sample grid x dimension</para></listitem><listitem><para>the sample grid y dimension</para></listitem><listitem><para>the fine map file relative path.</para></listitem><listitem><para>the fine map x dimension</para></listitem><listitem><para>the fine map y dimension</para></listitem><listitem><para>the fine map x offset</para></listitem><listitem><para>the fine map y offset</para></listitem><listitem><para>the coarse map file relative path.</para></listitem><listitem><para>the coarse map x dimension</para></listitem><listitem><para>the coarse map y dimension</para></listitem><listitem><para>the coarse map x offset</para></listitem><listitem><para>the coarse map y offset</para></listitem><listitem><para>the scale of the coarse map compared to the fine (10 means resolution of coarse map = 10 x resolution of fine map)</para></listitem><listitem><para>the output directory</para></listitem><listitem><para>the speciation rate.</para></listitem><listitem><para>the dispersal sigma value.</para></listitem><listitem><para>the deme size</para></listitem><listitem><para>the deme sample size (as a proportion of deme size)</para></listitem><listitem><para>the time to run the simulation (in seconds).</para></listitem><listitem><para>lambda - the relative cost of moving through non-forest</para></listitem><listitem><para>the_task - for referencing the specific task later on.</para></listitem><listitem><para>the minimum number of species the system is known to contain.</para></listitem><listitem><para>the pristine fine map file to use</para></listitem><listitem><para>the pristine coarse map file to use</para></listitem><listitem><para>the rate of forest change from pristine</para></listitem><listitem><para>the time (in generations) since the pristine forest was seen.</para></listitem><listitem><para>the dispersal tau value (the width of the kernel.</para></listitem><listitem><para>the sample mask, with binary 1:0 values for areas that we want to sample from. If this is not provided then this will default to mapping the whole area.</para></listitem><listitem><para>the link to the file containing every generation that the list should be expanded. This should be in the format of a list.</para></listitem><listitem><para>(and onwards) - speciation rates to apply after the simulation is complete.</para></listitem></orderedlist>
</para><para><heading level="4">Config Files</heading>
</para><para>The program also accepts a config file, specified by running <computeroutput>./necsim -c /path/to/config.txt</computeroutput>. The format of the config file is <programlisting><codeline><highlight class="normal">rand_seed<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">sample_x_dim<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">sample_y_dim<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">fine_source<sp/>=<sp/>/path/to/fine.csv</highlight></codeline>
<codeline><highlight class="normal">fine_x_dim<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">fine_y_dim<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">fine_x_offset<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">fine_y_offset<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">coarse_source<sp/>=<sp/>/path/to/coarse.csv</highlight></codeline>
<codeline><highlight class="normal">coarse_x_dim<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">coarse_y_dim<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">coarse_x_offset<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">coarse_y_offset<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">coarse_scale<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">output_dir<sp/>=<sp/>/path/to/outdir</highlight></codeline>
<codeline><highlight class="normal">spec_rate<sp/>=<sp/>d</highlight></codeline>
<codeline><highlight class="normal">zfat<sp/>=<sp/>f</highlight></codeline>
<codeline><highlight class="normal">deme_size<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">deme_sample<sp/>=<sp/>d</highlight></codeline>
<codeline><highlight class="normal">wall_time<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">lambda<sp/>=<sp/>1</highlight></codeline>
<codeline><highlight class="normal">job_num<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">est_spec<sp/>=<sp/>i</highlight></codeline>
<codeline><highlight class="normal">pristine_fine_source<sp/>=<sp/>/path/to/pristine/fine.csv</highlight></codeline>
<codeline><highlight class="normal">pristine_coarse_source<sp/>=<sp/>/path/to/pristine/coarse.csv</highlight></codeline>
<codeline><highlight class="normal">forest_change<sp/>=<sp/>d</highlight></codeline>
<codeline><highlight class="normal">time_since<sp/>=<sp/>f</highlight></codeline>
<codeline><highlight class="normal">dispersal<sp/>=<sp/>f</highlight></codeline>
<codeline><highlight class="normal">sampledatamask<sp/>=<sp/>/path/to/sample/mask.csv</highlight></codeline>
<codeline><highlight class="normal">time_config_file<sp/>=<sp/>/path/to/time/file.txt</highlight></codeline>
<codeline><highlight class="normal">speciationrate1<sp/>=<sp/>d</highlight></codeline>
<codeline><highlight class="normal">speciationrate2<sp/>=<sp/>d</highlight></codeline>
<codeline><highlight class="normal">...</highlight></codeline>
</programlisting> where <computeroutput>i</computeroutput> represents a positive integer, <computeroutput>d</computeroutput> is a decimal value between 0 and 1, and <computeroutput>f</computeroutput> is any positive number (float). Whilst this does help with readability of the code, the order of the arguments is essential at this stage (i.e. don&apos;t switch the order of the lines). Future versions may alter the system of reading such that the parameters are set according to their key. Any number of speciation rates (or 0) can be at the end of the file.</para><para><heading level="4">Outputs</heading>
</para><para>Upon successful completion of a simulation, necsim will produce an SQLite database file in the output directory in an SQL_data folder. This database contains several tables, which can be accessed using a program like <ulink url="http://sqlitebrowser.org/">DB Browser for SQLite</ulink> or Microsoft Access. Alternatively, most programming languages have an SQLite interface (<ulink url="https://cran.r-project.org/web/packages/RSQLite/index.html">RSQlite</ulink>, <ulink url="https://docs.python.org/2/library/sqlite3.html">python sqlite3</ulink>)</para><para><itemizedlist>
<listitem><para>The main table within the database is the SPECIES_LIST table, which is the location and inheritence of every lineage recorded. Several other important data structures (such as whether it is a &quot;tip&quot; of the phylogenetic tree of not) which are used when re-constructing the species identity.</para></listitem><listitem><para>A secondary output from necims is a SIMULATION_PARAMETERS table for identifying the exact parameters with which the model is run.</para></listitem><listitem><para>SpeciationCounter also produces a SPECIES_ABUNDANCES table containing species abundances across the whole sample map, plus (optionally) a table of SPECIES_LOCATIONS (containing the x,y location of every individual) and FRAGMENT_ABUNDANCES (species abundances for each habitat fragment separately).</para></listitem></itemizedlist>
</para><para><heading level="2">REQUIREMENTS</heading>
</para><para><itemizedlist>
<listitem><para>The SQLite library available <ulink url="https://www.sqlite.org/download.html">here</ulink>.</para></listitem><listitem><para>The Boost library available <ulink url="http://www.boost.org">here</ulink>.</para></listitem><listitem><para>The fast-cpp-csv-parser by Ben Strasser, available <ulink url="https://github.com/ben-strasser/fast-cpp-csv-parser">here</ulink>.</para></listitem><listitem><para>C++ compiler (such as GNU g++) with C++11 support.</para></listitem><listitem><para>Access to the relevant folders for Default simulations (see FAQS).</para></listitem></itemizedlist>
</para><para><heading level="2">CLASS DESCRIPTIONS</heading>
</para><para>A brief description of the important classes is given below. Some classes also contain customised exceptions for better tracing of error handling.</para><para><itemizedlist>
<listitem><para>The <computeroutput><ref refid="class_tree" kindref="compound">Tree</ref></computeroutput> class.<itemizedlist>
<listitem><para>The most important class!</para></listitem><listitem><para>Contains the main setup, run and data output routines.</para></listitem><listitem><para>Setup imports the data files from csv (if necessary) and creates the in-memory objects for the storing of the coalescence tree and the spatial grid of active lineages. Setup time mostly depends on the size of the csv file being imported.</para></listitem><listitem><para>Run continually loops over sucessive coalesence, move or speciation events until all individuals have speciated or coalesced. This is where the majority of the simulation time will be, and is mostly dependent on the number of individuals, speciation rate and size of the spatial grid.</para></listitem><listitem><para>At the end of the simulation, the sqlCreate() routine will generate the in-memory SQLite database for storing the coalescent tree. It can run multiple times if multiple speciation rates are required. outputData() will then be called to create a small csv file containing important information, and output the SQLite database to file if required.</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput><ref refid="class_tree_node" kindref="compound">TreeNode</ref></computeroutput> class<itemizedlist>
<listitem><para>Contains a single record of a node on the phylogenetic tree, to be used in reassembling the tree structure at the end of the simulation.</para></listitem><listitem><para>Operations are mostly basic getters and setters, with functionality called from higher-level functions.</para></listitem><listitem><para>An array of treenodes makes up the <computeroutput>data</computeroutput> object in <computeroutput><ref refid="class_tree" kindref="compound">Tree</ref></computeroutput>.</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput><ref refid="class_data_point" kindref="compound">DataPoint</ref></computeroutput> class<itemizedlist>
<listitem><para>Contains a single record of the location of a lineage.</para></listitem><listitem><para>An array of datapoints makes up the <computeroutput>active</computeroutput> object in <computeroutput><ref refid="class_tree" kindref="compound">Tree</ref></computeroutput>.</para></listitem><listitem><para><computeroutput>endactive</computeroutput> refers to the number of lineages currently being simulated. After each coalescence or speciation event this will decrease.</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput><ref refid="class_n_rrand" kindref="compound">NRrand</ref></computeroutput> class<itemizedlist>
<listitem><para>Contains the random number generator, as written by James Rosindell (<ulink url="mailto:j.rosindell@imperial.ac.uk">j.rosindell@imperial.ac.uk</ulink>).</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput><ref refid="class_map" kindref="compound">Map</ref></computeroutput> class<itemizedlist>
<listitem><para>Contains the routines for importing and calling values from the map objects.</para></listitem><listitem><para>The <computeroutput>getVal()</computeroutput> and <computeroutput>runDispersal()</computeroutput> functions can be modified to produce altered dispersal behaviour, or alterations to the structure of the map.</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput><ref refid="class_matrix" kindref="compound">Matrix</ref></computeroutput> and <computeroutput><ref refid="class_row" kindref="compound">Row</ref></computeroutput> classes<itemizedlist>
<listitem><para>Based on code written by James Rosindell (<ulink url="mailto:j.rosindell@imperial.ac.uk">j.rosindell@imperial.ac.uk</ulink>).</para></listitem><listitem><para>Handles indexing of the 2D object plus importing values from a csv file.</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput><ref refid="class_species_list" kindref="compound">SpeciesList</ref></computeroutput> class<itemizedlist>
<listitem><para>Contains the list of individuals, for application in a matrix, to essentially create a 3D array.</para></listitem><listitem><para>Handles the positioning of individuals in space within a grid cell.</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput><ref refid="class_config_option" kindref="compound">ConfigOption</ref></computeroutput> class<itemizedlist>
<listitem><para>Contains basic functions for importing command line arguments from a config file, providing an alternative way of setting up simulations.</para></listitem></itemizedlist>
</para></listitem><listitem><para>The <computeroutput>TreeList</computeroutput> class<itemizedlist>
<listitem><para>Provides the routines for applying different speciation rates to a phylogenetic tree, to be used either immediately after simulation within necsim, or at a later time using SpeciationCounter.cpp</para></listitem></itemizedlist>
</para></listitem></itemizedlist>
</para><para><heading level="2">KNOWN BUGS</heading>
</para><para><itemizedlist>
<listitem><para>Simulations run until completion, rather than aiming for a desired number of species. This is an intentional change. Functions related to this functionality remain but are deprecated.</para></listitem><listitem><para>Only continuous rectangular fragments are properly calculated. Other shapes must be calculated by post-processing.</para></listitem><listitem><para>3 fragments instead of 2 will be calculated for certain adjacent rectangular patches.</para></listitem></itemizedlist>
</para><para><heading level="2">FAQS (WIP)</heading>
</para><para><itemizedlist>
<listitem><para><bold>How do I get started?</bold><itemizedlist>
<listitem><para>It is recommended to use the <ulink url="http://pycoalescence.readthedocs.io/">pycoalescence</ulink> package which simplifies installation of necsim, setting up and running simulations. This provides a much easier way to get started with necsim.</para></listitem></itemizedlist>
</para></listitem><listitem><para><bold>Why can’t I compile the program?</bold><itemizedlist>
<listitem><para>This could be due to a number of reasons, most likely that you haven’t compiled with access to the lsqlite3 or boost packages. Installation and compilation differs across different systems; for most UNIX systems, compiling with the linker arguments -lsqlite3 -lboost_filesystem and -lboost_system will solve problems with the compiler not finding the sqlite or boost header file.</para></listitem><listitem><para>Another option could be the potential lack of access to the fast-cpp-csv-parser by Ben Strasser, available <ulink url="https://github.com/ben-strasser/fast-cpp-csv-parser">here</ulink>. If use_csv has been defined at the head of the file, try without use_csv or download the csv parser and locate the folder within your working directory at compilation.</para></listitem></itemizedlist>
</para></listitem><listitem><para><bold>Every time the program runs I get error code XXX.</bold><itemizedlist>
<listitem><para>Check the ERROR_REF.txt file for descriptions of the files. Try running in debug mode by compiling with <computeroutput>-DDEBUG</computeroutput> to gain more information on the problem. Check the log output in /logs. It is most likely a problem with the set up of the map data (error checking is not yet properly implemented here).</para></listitem></itemizedlist>
</para></listitem></itemizedlist>
</para><para><heading level="2">CONTACTS</heading>
</para><para>Author: <bold>Samuel Thompson</bold></para><para>Contact: <ulink url="mailto:samuelthompson14@imperial.ac.uk">samuelthompson14@imperial.ac.uk</ulink> - <ulink url="mailto:thompsonsed@gmail.com">thompsonsed@gmail.com</ulink></para><para>Institution: Imperial College London and National University of Singapore</para><para>Based heavily on code by <bold>James Rosindell</bold></para><para>Contact: <ulink url="mailto:j.rosindell@imperial.ac.uk">j.rosindell@imperial.ac.uk</ulink></para><para>Institution: Imperial College London </para>    </detaileddescription>
  </compounddef>
</doxygen>
