<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pycoalescence.simulation &#8212; pycoalescence 1.2.6 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.2.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
    <script type="text/javascript" src="../../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <link rel="shortcut icon" href="../../_static/PyCoal_favicon_large.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pycoalescence 1.2.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pycoalescence.simulation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Run spatially-explicit neutral simulations on provided landscapes with support for a wide range of scenarios and</span>
<span class="sd">parameters. Detailed :ref:`here &lt;performing_simulations&gt;`.</span>

<span class="sd">The main class is :class:`.Simulation`, which contains routines for setting up and running simulations, plus basic tree</span>
<span class="sd">generation after simulations have been completed.</span>

<span class="sd">:input:</span>
<span class="sd">	- Simulation parameters (such as dispersal kernel, speciation rate)</span>
<span class="sd">	- Map files representing density over space</span>
<span class="sd">	- [optional] map files representing relative reproductive ability</span>
<span class="sd">	- [optional] map files representing dispersal potential</span>
<span class="sd">	- [optional] historical density map files</span>

<span class="sd">:output:</span>
<span class="sd">	- Database containing generated coalescence tree, simulation parameters and basic biodiversity metrics.</span>
<span class="sd">	- If the simulation does not complete, will instead generate a set of Dump_*.csv files for resuming simulations</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.future_except</span> <span class="kn">import</span> <span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">FileExistsError</span>
<span class="kn">from</span> <span class="nn">.landscape</span> <span class="kn">import</span> <span class="n">Landscape</span>
<span class="kn">from</span> <span class="nn">.map</span> <span class="kn">import</span> <span class="n">Map</span>
<span class="kn">from</span> <span class="nn">.system_operations</span> <span class="kn">import</span> <span class="n">write_to_log</span><span class="p">,</span> <span class="n">check_parent</span>

<span class="k">global</span> <span class="n">sqlite_import</span><span class="p">,</span> <span class="n">config_success</span>
<span class="k">try</span><span class="p">:</span>
	<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
		<span class="kn">import</span> <span class="nn">configparser</span> <span class="kn">as</span> <span class="nn">ConfigParser</span>
		<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="kn">import</span> <span class="nn">ConfigParser</span>
		<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

		<span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="o">.</span><span class="n">read_file</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="o">.</span><span class="n">read</span>
	<span class="n">config_success</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="n">ConfigParser</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not import ConfigParser. Config options disabled.&quot;</span><span class="p">)</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>
	<span class="n">config_success</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">try</span><span class="p">:</span>
	<span class="n">NumberTypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">LongType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FloatType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ComplexType</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
	<span class="c1"># No support for complex numbers compile</span>
	<span class="n">NumberTypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="kn">import</span> <span class="nn">gdal</span>
	<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
		<span class="n">gdal</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Problem importing  (gdal) modules. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">sqlite3</span>

	<span class="n">sqlite_import</span> <span class="o">=</span> <span class="bp">True</span>
	<span class="kn">from</span> <span class="nn">.coalescence_tree</span> <span class="kn">import</span> <span class="n">CoalescenceTree</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="n">sqlite_import</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="n">CoalescenceTree</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">sqlite3</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Problem importing sqlite module &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">build</span> <span class="kn">import</span> <span class="n">necsimmodule</span><span class="p">,</span> <span class="n">NECSimError</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ime</span><span class="p">:</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ime</span><span class="p">))</span>
	<span class="kn">from</span> <span class="nn">.build</span> <span class="kn">import</span> <span class="n">necsimmodule</span><span class="p">,</span> <span class="n">NECSimError</span>


<div class="viewcode-block" id="Simulation"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation">[docs]</a><span class="k">class</span> <span class="nc">Simulation</span><span class="p">(</span><span class="n">Landscape</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A class containing routines to set up and run simulations, including detecting map dimensions from tif files.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logging_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
				 <span class="n">log_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets up the simulation object, setting the logging object and assigning default variables.</span>

<span class="sd">		:param int logging_level: the minimal level of logging to display</span>
<span class="sd">		:param string log_output: a file to output log data to. Use None for writing to console.</span>
<span class="sd">		:param kwargs: additional keyword arguments to supply to logging.basicConfig()</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># All the parameters used for the simulation</span>
		<span class="n">Landscape</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="c1"># Contains the C object for performing simulations</span>
		<span class="c1"># This will be set depending on the simulation type</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="c1"># Create the logging object and pass on the required arguments for its creation</span>
		<span class="n">passedKwards</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;stream&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;pycoalescence.simulation&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">passedKwards</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_create_logger</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">log_output</span><span class="p">,</span> <span class="n">logging_level</span><span class="o">=</span><span class="n">logging_level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pause_directory</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config_string</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="mi">100</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># the relative cost of moving through non-matrix</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="c1"># the optional parameters specifying the location (i.e. where in the world the simulation is of</span>
		<span class="c1"># and the compute node (such as NUS_HPC or LOCAL_MACBOOK)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sim_location</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sim_compute_node</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="c1"># parameters for the application of speciation rates</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_speciation</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">record_spatial</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">record_fragments</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="c1"># The output database location</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_database</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">m_prob</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="c1"># The protracted variables</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">protracted</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="c1"># This variable stores whether a new config file has been opened or not</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config_open</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="c1"># Grid dimensions sizing</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="c1"># Dispersal map data</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span> <span class="o">=</span> <span class="bp">True</span><span class="p">;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uses_spatial_sampling</span> <span class="o">=</span> <span class="bp">False</span>

	<span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Safely destroys the logger and the c++ objects.&quot;&quot;&quot;</span>
		<span class="n">handlers</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
			<span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="Simulation.setup_necsim"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.setup_necsim">[docs]</a>	<span class="k">def</span> <span class="nf">setup_necsim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the logging function and the logger object for the necsim object. Enforcing this function is always called</span>
<span class="sd">		ensures no seg faults occur.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">set_log_function</span><span class="p">(</span><span class="n">write_to_log</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.add_sample_time"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.add_sample_time">[docs]</a>	<span class="k">def</span> <span class="nf">add_sample_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Adds an extra sample time to the list of times.</span>

<span class="sd">		This allows for multiple temporal sample points from within the same simulation.</span>

<span class="sd">		:param time: the sample time to add</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">add_sample_time</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">time</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.set_config_file"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.set_config_file">[docs]</a>	<span class="k">def</span> <span class="nf">set_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the config file to the output, over-writing any existing config file that has been stored.</span>

<span class="sd">		:param output_file: path to config file to output to</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">and</span> <span class="n">output_file</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">and</span> <span class="n">output_file</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Config file has already been set to {}, changing to {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">,</span>
																								 <span class="n">output_file</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">=</span> <span class="n">output_file</span></div>

<div class="viewcode-block" id="Simulation.load_config"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.load_config">[docs]</a>	<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Loads the config file by reading the lines in order.</span>

<span class="sd">		:param str config_file: the config file to read in.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># New method using ConfigParser</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">config_success</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Failure to import ConfigParser: cannot load config file&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;job_type&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;output_directory&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_spec_rate&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;deme&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_size&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_species&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;spec_rate&quot;</span><span class="p">):</span>
				<span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s2">&quot;spec_rate&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;spec_rate&quot;</span><span class="p">,</span> <span class="n">each</span><span class="p">))</span></div>

<div class="viewcode-block" id="Simulation.write_config"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.write_config">[docs]</a>	<span class="k">def</span> <span class="nf">write_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Writes the config to the config file provided, overwriting any existing config files.</span>

<span class="sd">		:param config_file: the config file to write out to</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">check_parent</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_open</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config_open</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">=</span> <span class="n">config_file</span></div>

<div class="viewcode-block" id="Simulation.create_temporal_sampling_config"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.create_temporal_sampling_config">[docs]</a>	<span class="k">def</span> <span class="nf">create_temporal_sampling_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates the time-sampling config file.</span>

<span class="sd">		Function is called automatically when creating a config file, and should not be manually called.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;times&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">))):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;times&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.create_map_config"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.create_map_config">[docs]</a>	<span class="k">def</span> <span class="nf">create_map_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Generates the map config file from reading the spatial structure of each of the provided files.</span>

<span class="sd">		:param str output_file: the file to output configuration data to (the map config file)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_config_file</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
				<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">get_x_y</span><span class="p">())</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;uses_spatial_sampling&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_spatial_sampling</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
				<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">get_x_y</span><span class="p">())</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
					<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">get_x_y</span><span class="p">())</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_scale</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sort_historical_maps</span><span class="p">()</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historical_coarse_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">):</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">tmp_fine</span> <span class="o">=</span> <span class="s2">&quot;historical_fine{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
							<span class="n">tmp_coarse</span> <span class="o">=</span> <span class="s2">&quot;historical_coarse{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_coarse_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
						<span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
								<span class="s1">&#39;Discrepancy between historical file list, time list or rate list. Check inputs: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>
							<span class="k">break</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;grid_map&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;grid_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;grid_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">))</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;reproduction&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;reproduction&quot;</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;m_probability&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_prob</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;cutoff&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">))</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span><span class="p">:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">):</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;restrict_self&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span><span class="p">)))</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">landscape_type</span> <span class="o">!=</span> <span class="s2">&quot;closed&quot;</span><span class="p">:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">):</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;landscape_type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">landscape_type</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">]:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">):</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;dispersal_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot generate map config file without setting up map variables&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.create_config"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.create_config">[docs]</a>	<span class="k">def</span> <span class="nf">create_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Generates the configuration. This will be written out either by providing an output file here, or by calling</span>
<span class="sd">		write_config();</span>

<span class="sd">		:param str output_file: the file to generate the config option. Must be a path to a .txt file.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_config_file</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">config_success</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;ConfigParser import was unsuccessful: cannot create config file.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Path {} does not exist for writing &#39;</span>
								 <span class="s1">&#39;output to, creating.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)))</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_open</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">:</span>
			<span class="c1"># New method using ConfigParser</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;job_type&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;output_directory&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_spec_rate&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;dispersal_relative_cost&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;deme&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deme</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_size&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_species&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">,</span> <span class="s2">&quot;has_protracted&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">,</span> <span class="s2">&quot;min_speciation_gen&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">,</span> <span class="s2">&quot;max_speciation_gen&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span><span class="p">)))</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;spec_rates&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">])):</span>
					<span class="n">spec_rate</span> <span class="o">=</span> <span class="s2">&quot;spec_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spec_rates&quot;</span><span class="p">,</span> <span class="n">spec_rate</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Setup has not been completed, cannot create config file&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">create_temporal_sampling_config</span><span class="p">()</span></div>

<div class="viewcode-block" id="Simulation.run_simple"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.run_simple">[docs]</a>	<span class="k">def</span> <span class="nf">run_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Runs a simple coalescence simulation on a square infinite landscape with the provided parameters.</span>
<span class="sd">		This requires a separate compilation of the inf_land version of the coalescence simulator.</span>

<span class="sd">		Note that this function returns richness=0 for failure to read from the file. It is assumed that there will</span>
<span class="sd">		be at least one species in the simulation.</span>

<span class="sd">		Note that the maximum time for this function is set as 10 hours (36000 seconds) and will raise an exception if</span>
<span class="sd">		the simulation does not complete in this time).</span>

<span class="sd">		:raises RuntimeError: if the simulation didn&#39;t complete in time.</span>

<span class="sd">		:param seed: the simulation seed</span>
<span class="sd">		:param task: the task (for file naming)</span>
<span class="sd">		:param output: the output directory</span>
<span class="sd">		:param alpha: the speciation rate</span>
<span class="sd">		:param sigma: the normal distribution sigma value for dispersal</span>
<span class="sd">		:param size: the size of the world (so there will be size^2 individuals simulated)</span>

<span class="sd">		:return: the species richness in the simulation</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_simulation_params</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">output_directory</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">min_speciation_rate</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
								   <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deme</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_time</span><span class="o">=</span><span class="mi">36000</span><span class="p">,</span>
								   <span class="n">dispersal_relative_cost</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
								   <span class="n">min_num_species</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">habitat_change_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">gen_since_historical</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_map_parameters</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span>
								<span class="s2">&quot;null&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_speciation_rates</span><span class="p">([</span><span class="n">alpha</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
		<span class="c1"># Now read the species richness from the database</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">richness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_richness</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">richness</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Richness is 0, error in program. This should never be the case for a complete &quot;</span>
									 <span class="s2">&quot;sim.&quot;</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">richness</span>
		<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation didn&#39;t complete in 10 hours (maximum time for run_simple). Try running a &quot;</span>
							   <span class="s2">&quot;custom simulation instead.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.get_richness"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.get_richness">[docs]</a>	<span class="k">def</span> <span class="nf">get_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calls coal_analyse.get_richness() with the supplied variables.</span>

<span class="sd">		Requires successful import of coal_analyse and sqlite3.</span>

<span class="sd">		:param speciation_rate: the speciation rate to extract system richness from.</span>
<span class="sd">		:param time: the time to extract system richness from</span>

<span class="sd">		:return: the species richness.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">sqlite_import</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;sqlite3 module required for obtaining richness from database files.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
			<span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_database</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">CoalescenceTree</span><span class="p">()</span>
			<span class="n">t</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">get_richness</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.get_protracted"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.get_protracted">[docs]</a>	<span class="k">def</span> <span class="nf">get_protracted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets whether the simulation pointed to by this object is a protracted simulation or not.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_database</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">CoalescenceTree</span><span class="p">()</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">t</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
				<span class="c1"># Catches errors thrown if the simulation is paused</span>
				<span class="k">pass</span>
			<span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">is_protracted</span><span class="p">()</span></div>

<div class="viewcode-block" id="Simulation.set_map_files"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.set_map_files">[docs]</a>	<span class="k">def</span> <span class="nf">set_map_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_file</span><span class="p">,</span> <span class="n">fine_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">coarse_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">historical_fine_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
					  <span class="n">historical_coarse_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dispersal_map</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reproduction_map</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the map files (or to null, if none specified). It then calls detect_map_dimensions() to correctly read in</span>
<span class="sd">		the specified dimensions.</span>

<span class="sd">		If sample_file is &quot;null&quot;, dimension values will remain at 0.</span>
<span class="sd">		If coarse_file is &quot;null&quot;, it will default to the size of fine_file with zero offset.</span>
<span class="sd">		If the coarse file is &quot;none&quot;, it will not be used.</span>
<span class="sd">		If the historical fine or coarse files are &quot;none&quot;, they will not be used.</span>

<span class="sd">		.. note:: the dispersal map should be of dimensions xy by xy where x, y are the fine map dimensions. Dispersal</span>
<span class="sd">				  probabilities should sum to 1 across each row, and each row/column index represents dispersal from the</span>
<span class="sd">				  row index to the column index according to index = x+(y*xdim), where x,y are the coordinates of the</span>
<span class="sd">				  cell and xdim is the x dimension of the fine map. See the</span>
<span class="sd">				  :class:`PatchedLandscape class &lt;pycoalescence.patched_landscape.PatchedLandscape&gt;` for routines for</span>
<span class="sd">				  generating these landscapes.</span>

<span class="sd">		:param str sample_file: the sample map file. Provide &quot;null&quot; if on samplemask is required</span>
<span class="sd">		:param str fine_file: the fine map file. Defaults to &quot;null&quot; if none provided</span>
<span class="sd">		:param str coarse_file: the coarse map file. Defaults to &quot;none&quot; if none provided</span>
<span class="sd">		:param str historical_fine_file: the historical fine map file. Defaults to &quot;none&quot; if none provided</span>
<span class="sd">		:param str historical_coarse_file: the historical coarse map file. Defaults to &quot;none&quot; if none provided</span>
<span class="sd">		:param str dispersal_map: the dispersal map for reading dispersal values. Default to &quot;none&quot; if none provided</span>
<span class="sd">		:param str reproduction_map: a map of relative reproduction probabilities, at the scale of the fine map</span>

<span class="sd">		:rtype: None</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">dispersal_map</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">dispersal_map</span>
		<span class="k">if</span> <span class="n">reproduction_map</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">reproduction_map</span>
		<span class="n">Landscape</span><span class="o">.</span><span class="n">set_map_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_file</span><span class="p">,</span> <span class="n">fine_file</span><span class="p">,</span> <span class="n">coarse_file</span><span class="p">,</span> <span class="n">historical_fine_file</span><span class="p">,</span> <span class="n">historical_coarse_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.detect_map_dimensions"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.detect_map_dimensions">[docs]</a>	<span class="k">def</span> <span class="nf">detect_map_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Detects all the map dimensions for the provided files (where possible) and sets the respective values.</span>
<span class="sd">		This is intended to be run after set_map_files()</span>

<span class="sd">		:raises TypeError: if a dispersal map or reproduction map is specified, we must have a fine map specified, but</span>
<span class="sd">						   not a coarse map.</span>

<span class="sd">		:raises IOError: if one of the required maps does not exist</span>
<span class="sd">		</span>
<span class="sd">		:raises ValueError: if the dimensions of the dispersal map do not make sense when used with the fine map</span>
<span class="sd">							provided</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">Landscape</span><span class="o">.</span><span class="n">detect_map_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="c1"># Now do detection for dispersal map</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">}:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="ow">or</span> \
					<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dimensions of dispersal map do not match dimensions of fine map. This is currently&quot;</span>
								 <span class="s2">&quot; unsupported.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">}:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">has_equal_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="p">):</span>
				<span class="c1"># if the sizes match, then proceed with a warning</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">and</span> \
						<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Coordinates of reproduction map did not match fine map.&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">x_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_res</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">y_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_res</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dimensions of the reproduction map do not match the fine map. This is currently &quot;</span>
									 <span class="s2">&quot;unsupported.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_maps</span><span class="p">()</span></div>

<div class="viewcode-block" id="Simulation.set_simulation_params"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.set_simulation_params">[docs]</a>	<span class="k">def</span> <span class="nf">set_simulation_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">,</span> <span class="n">min_speciation_rate</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">deme</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
							  <span class="n">sample_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_time</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">dispersal_method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
							  <span class="n">dispersal_relative_cost</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_num_species</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">habitat_change_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
							  <span class="n">gen_since_historical</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">restrict_self</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">landscape_type</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
							  <span class="n">protracted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">min_speciation_gen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_speciation_gen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
							  <span class="n">spatial</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">uses_spatial_sampling</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Set all the simulation parameters apart from the map objects.</span>

<span class="sd">		:param int seed: the unique job number for this simulation set</span>
<span class="sd">		:param int job_type: the job type (used for easy file identification after simulations are complete)</span>
<span class="sd">		:param str output_directory: the output directory to store the SQL database</span>
<span class="sd">		:param float min_speciation_rate: the minimum speciation rate to simulate</span>
<span class="sd">		:param float sigma: the dispersal sigma value</span>
<span class="sd">		:param float tau: the fat-tailed dispersal tau value</span>
<span class="sd">		:param int deme: the deme size (in individuals per cell)</span>
<span class="sd">		:param float sample_size: the sample size of the deme (decimal 0-1)</span>
<span class="sd">		:param float max_time: the maximum allowed simulation time (in seconds)</span>
<span class="sd">		:param str dispersal_method: the dispersal kernel method. Should be one of [normal, fat-tail, norm-uniform]</span>
<span class="sd">		:param float m_prob: the probability of drawing from the uniform dispersal. Only relevant for uniform dispersals</span>
<span class="sd">		:param float cutoff: the maximum value for the uniform dispersal. Only relevant for uniform dispersals.</span>
<span class="sd">		:param float dispersal_relative_cost: the relative cost of travelling through non-habitat (defaults to 1)</span>
<span class="sd">		:param int min_num_species: the minimum number of species known to exist (defaults to 1</span>
<span class="sd">		:param float habitat_change_rate: the rate of habitat change over time</span>
<span class="sd">		:param float gen_since_historical: the time in generations since a historical state was achieved</span>
<span class="sd">		:param bool restrict_self: if true, restricts dispersal from own cell</span>
<span class="sd">		:param bool/str landscape_type: if false or &quot;closed&quot;, restricts dispersal to the provided maps, otherwise</span>
<span class="sd">										can be &quot;infinite&quot;, or a tiled landscape using &quot;tiled_coarse&quot; or &quot;tiled_fine&quot;.</span>
<span class="sd">		:param bool protracted: if true, uses protracted speciation application</span>
<span class="sd">		:param float min_speciation_gen: the minimum amount of time a lineage must exist before speciation occurs.</span>
<span class="sd">		:param float max_speciation_gen: the maximum amount of time a lineage can exist before speciating.</span>
<span class="sd">		:param bool spatial: if true, means that the simulation is spatial</span>
<span class="sd">		:param bool uses_spatial_sampling: if true, the sample mask is interpreted as a proportional sampling mask,</span>
<span class="sd">										   where the number of individuals sampled in the cell is equal to the</span>
<span class="sd">										   density * deme_sample * cell sampling proportion</span>
<span class="sd">		:param list times: list of temporal sampling points to apply (in generations)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">output_directory</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span> <span class="o">=</span> <span class="n">min_speciation_rate</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">=</span> <span class="n">deme</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span> <span class="o">=</span> <span class="n">dispersal_relative_cost</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span> <span class="o">=</span> <span class="n">min_num_species</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">habitat_change_rate</span> <span class="o">=</span> <span class="n">habitat_change_rate</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">gen_since_historical</span> <span class="o">=</span> <span class="n">gen_since_historical</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span> <span class="o">=</span> <span class="n">dispersal_method</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">m_prob</span> <span class="o">=</span> <span class="n">m_prob</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span> <span class="o">=</span> <span class="n">restrict_self</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span> <span class="o">=</span> <span class="n">spatial</span>
			<span class="k">if</span> <span class="n">uses_spatial_sampling</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spatial</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must use a spatial simulation to define spatial samplign regime.&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">uses_spatial_sampling</span> <span class="o">=</span> <span class="n">uses_spatial_sampling</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">spatial</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="k">if</span> <span class="n">landscape_type</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">}:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">landscape_type</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
			<span class="k">elif</span> <span class="n">landscape_type</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">True</span><span class="p">,</span> <span class="s2">&quot;infinite&quot;</span><span class="p">}:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">landscape_type</span> <span class="o">=</span> <span class="s2">&quot;infinite&quot;</span>
			<span class="k">elif</span> <span class="n">landscape_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;tiled_coarse&quot;</span><span class="p">,</span> <span class="s2">&quot;tiled_fine&quot;</span><span class="p">}:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">landscape_type</span> <span class="o">=</span> <span class="n">landscape_type</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supplied landscape type is not recognised: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">landscape_type</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">protracted</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">protracted</span> <span class="o">=</span> <span class="bp">True</span>
				<span class="k">if</span> <span class="n">max_speciation_gen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using protracted speciation, but no maximum speciation generation supplied.&quot;</span>
										<span class="s2">&quot; Default to 10^100&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">100</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span> <span class="o">=</span> <span class="n">max_speciation_gen</span>
				<span class="k">if</span> <span class="n">min_speciation_gen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using protracted speciation, but no minimum speciation generation supplied.&quot;</span>
										<span class="s2">&quot; Default to 0.0&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span> <span class="o">=</span> <span class="n">min_speciation_gen</span>
			<span class="k">if</span> <span class="n">times</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">times</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Parameters already set up.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.check_simulation_params"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.check_simulation_params">[docs]</a>	<span class="k">def</span> <span class="nf">check_simulation_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks that simulation parameters have been correctly set and the program is ready for running.</span>
<span class="sd">		Note that these checks have not been fully tested and are probably unnecessary in a large number of cases.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation parameters have not been set.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">}:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Output directory not set.&#39;</span><span class="p">)</span>
		<span class="n">check_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">check_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.resume_coalescence"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.resume_coalescence">[docs]</a>	<span class="k">def</span> <span class="nf">resume_coalescence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pause_directory</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">max_time</span><span class="p">,</span> <span class="n">out_directory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
						   <span class="n">protracted</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">spatial</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Resumes the simulation from the specified directory, looking for the simulation with the specified seed and task</span>
<span class="sd">		referencing.</span>

<span class="sd">		:param pause_directory: the directory to search for the paused simulation</span>
<span class="sd">		:param seed: the seed of the paused simulation</span>
<span class="sd">		:param job_type: the task of the paused simulation</span>
<span class="sd">		:param max_time: the maximum time to run simulations for</span>
<span class="sd">		:param out_directory: optionally provide an alternative output location. Defaults to same location as</span>
<span class="sd">		pause_directory</span>
<span class="sd">		:param bool protracted: protractedness of the simulation</span>
<span class="sd">		:param bool spatial: if the simulation is to be run with spatial complexity</span>

<span class="sd">		.. note: A max time of 0 uses the previous simulation maximum time.</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">protracted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">protracted</span> <span class="o">=</span> <span class="n">protracted</span>
		<span class="k">if</span> <span class="n">spatial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span> <span class="o">=</span> <span class="n">spatial</span>
		<span class="k">if</span> <span class="n">out_directory</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">out_directory</span> <span class="o">=</span> <span class="n">pause_directory</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">out_directory</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pause_directory</span> <span class="o">=</span> <span class="n">pause_directory</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
		<span class="n">file_path</span> <span class="o">=</span> <span class="p">[</span>
			<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pause_directory</span><span class="p">,</span> <span class="s2">&quot;Pause&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;Dump_&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
			<span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">]]</span>
		<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">file_path</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">each</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
					<span class="s2">&quot;Paused file &quot;</span> <span class="o">+</span> <span class="n">each</span> <span class="o">+</span> <span class="s2">&quot; not found. Ensure pause directory is correct and is accessible.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setupNECSim</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span><span class="o">.</span><span class="n">setup_resume</span><span class="p">(</span><span class="n">pause_directory</span><span class="p">,</span> <span class="n">out_directory</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">max_time</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_run_and_output</span><span class="p">()</span></div>

<div class="viewcode-block" id="Simulation.persistent_ram_usage"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.persistent_ram_usage">[docs]</a>	<span class="k">def</span> <span class="nf">persistent_ram_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		This is the persistent RAM usage which cannot be optimised by the program for a particular set of maps</span>
<span class="sd">		:return: the total persistent RAM usage in bytes</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">total_ram</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="c1"># First add the maps</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_map_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_coarse_map_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historical_coarse_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">8</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">8</span>
		<span class="c1"># Now add the other large memory objects</span>
		<span class="c1"># The data object</span>
		<span class="n">total_ram</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_individuals</span><span class="p">()</span> <span class="o">*</span> <span class="mi">91</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
		<span class="c1"># The active object</span>
		<span class="n">total_ram</span> <span class="o">+=</span> <span class="mi">72</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_individuals</span><span class="p">()</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">total_ram</span></div>

<div class="viewcode-block" id="Simulation.estimate_ram_usage"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.estimate_ram_usage">[docs]</a>	<span class="k">def</span> <span class="nf">estimate_ram_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_individuals</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Estimates the RAM usage for the program with the current parameters.</span>

<span class="sd">		Note this estimates the upper bound of memory usage and is likely inaccurate, especially for simulations with</span>
<span class="sd">		multiple time sampling points.</span>

<span class="sd">		:param grid_individuals: the number of individuals existing on the grid</span>

<span class="sd">		:return: the estimated RAM usage in bytes</span>

<span class="sd">		:rtype: float</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">total_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent_ram_usage</span><span class="p">()</span>
		<span class="c1"># The grid object</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span><span class="p">))</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">grid_individuals</span></div>

<div class="viewcode-block" id="Simulation.count_individuals"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.count_individuals">[docs]</a>	<span class="k">def</span> <span class="nf">count_individuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Estimates the number of individuals to be simulated. This may be inaccurate if using multiple time points and</span>
<span class="sd">		historical maps.</span>

<span class="sd">		:return: a count of the number of individuals to be simulated</span>

<span class="sd">		:rtype: float</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
				<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">())</span> <span class="o">*</span> \
							   <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">)</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span></div>

<div class="viewcode-block" id="Simulation.import_fine_map_array"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.import_fine_map_array">[docs]</a>	<span class="k">def</span> <span class="nf">import_fine_map_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Imports the fine map array to the in-memory object, subsetted to the same size as the sample grid.</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span>
																  <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span>
																  <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span>
																  <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Simulation.import_sample_map_array"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.import_sample_map_array">[docs]</a>	<span class="k">def</span> <span class="nf">import_sample_map_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Imports the sample map array to the in-memory object.</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">ds2</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds2</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
			<span class="n">ds2</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Simulation.grid_density_estimate"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.grid_density_estimate">[docs]</a>	<span class="k">def</span> <span class="nf">grid_density_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_off</span><span class="p">,</span> <span class="n">y_off</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Counts the density total for a subset of the grid by sampling from the fine map</span>

<span class="sd">		:note: This is an approximation (based on the average density of the fine map) and does not produce</span>
<span class="sd">		       a perfect value. This is done for performance reasons. The actual value can be obtained with</span>
<span class="sd">		       grid_density_actual().</span>

<span class="sd">		:param x_off: the x offset of the grid map subset</span>
<span class="sd">		:param y_off: the y offset of the grid map subset</span>
<span class="sd">		:param x_dim: the x dimension of the grid map subset</span>
<span class="sd">		:param y_dim: the y dimension of the grid map subset</span>

<span class="sd">		:return: an estimate of the total individuals that exist in the subset.</span>

<span class="sd">		:rtype: int</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">import_fine_map_array</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="ow">and</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">import_sample_map_array</span><span class="p">()</span>
			<span class="c1"># Less accurate, but faster way.</span>
			<span class="n">arr_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">]</span>
			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">arr_subset</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Simulation.grid_density_actual"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.grid_density_actual">[docs]</a>	<span class="k">def</span> <span class="nf">grid_density_actual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_off</span><span class="p">,</span> <span class="n">y_off</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Counts the density total for a subset of the grid by sampling from the fine map.</span>

<span class="sd">		Note that for large maps this can take a very long time.</span>

<span class="sd">		:param x_off: the x offset of the grid map subset</span>
<span class="sd">		:param y_off: the y offset of the grid map subset</span>
<span class="sd">		:param x_dim: the x dimension of the grid map subset</span>
<span class="sd">		:param y_dim: the y dimension of the grid map subset</span>

<span class="sd">		:return: the total individuals that exist in the subset.</span>

<span class="sd">		:rtype: int</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">import_fine_map_array</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="ow">and</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">import_sample_map_array</span><span class="p">()</span>
			<span class="c1"># Less accurate, but faster way.</span>
			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">],</span>
												   <span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">])</span> <span class="o">*</span>
									   <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">]</span> <span class="o">*</span>
									   <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Simulation.get_average_density"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.get_average_density">[docs]</a>	<span class="k">def</span> <span class="nf">get_average_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the average density across the fine map, subsetted for the sample grid.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">import_fine_map_array</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span></div>

<div class="viewcode-block" id="Simulation.check_sample_map_equals_sample_grid"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.check_sample_map_equals_sample_grid">[docs]</a>	<span class="k">def</span> <span class="nf">check_sample_map_equals_sample_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks if the grid and sample map are the same size and offset (in which case, future operations can be</span>
<span class="sd">		simplified).</span>

<span class="sd">		:return: true if the grid and sample map dimensions and offsets are equal</span>
<span class="sd">		:rtype: bool</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">and</span> \
			   <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">==</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Simulation.optimise_ram"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.optimise_ram">[docs]</a>	<span class="k">def</span> <span class="nf">optimise_ram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ram_limit</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Optimises the maps for a specific RAM usage.</span>

<span class="sd">		If ram_limit is None, this function does nothing.</span>

<span class="sd">		:note: Assumes that the c++ compiler has sizeof(long) = 8 bytes for calculating space usage.</span>

<span class="sd">		:note: Only optimises RAM for a square area of the map. For rectangular shapes, will use the shortest length as</span>
<span class="sd">			   a maximum size.</span>

<span class="sd">		:param ram_limit: the desired amount of RAM to limit to, in GB</span>

<span class="sd">		:raises MemoryError: if the desired simulation cannot be compressed into available RAM</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sample size is 0, or deme is 0. set_simulation_params() before optimising RAM.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="p">)</span>
		<span class="c1"># Over-estimate static usage slightly</span>
		<span class="n">static_usage</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent_ram_usage</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span>
		<span class="k">if</span> <span class="n">static_usage</span> <span class="o">&gt;</span> <span class="n">ram_limit</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span>
				<span class="s2">&quot;Cannot achieve RAM limit: minimum requirements are {}GB.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">static_usage</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="n">remaining_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">ram_limit</span> <span class="o">-</span> <span class="n">static_usage</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Remaining space is {}GB.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">remaining_space</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="c1"># Rough calculation of number of cells we have remaining (aim for 75% to be sure)</span>
		<span class="n">average_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span>
		<span class="c1"># This is the size of the grid object in memory</span>
		<span class="n">tmp_space</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">remaining_space</span> <span class="o">/</span> <span class="p">((</span><span class="mi">16</span> <span class="o">*</span> <span class="n">average_density</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">tmp_space</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
				<span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s2">&quot;Could not find square grid to achieve RAM limit. Please set this manually.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory limit high enough for full spatial simulation. No optimisation necessary.&quot;</span><span class="p">)</span>
			<span class="n">max_attained</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="c1"># Now loop over every square of the required size on the grid, until we find one with the maximum density</span>
			<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">:</span>
				<span class="n">printing</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">printing</span> <span class="o">=</span> <span class="bp">False</span>
			<span class="n">end_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Extremely small grid size: {}. Disabling maximum density checking.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
				<span class="n">max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">max_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">max_attained</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)))):</span>
					<span class="k">if</span> <span class="n">printing</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Checking {} / {} : {}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end_x</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">end_x</span><span class="p">)))</span>
					<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)))):</span>
						<span class="c1"># print(&quot;x, y: {}, {}&quot;.format(x, y))</span>
						<span class="n">tmp_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density_actual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">tmp_total</span> <span class="o">&gt;</span> <span class="n">max_attained</span><span class="p">:</span>
							<span class="n">max_x</span> <span class="o">=</span> <span class="n">x</span>
							<span class="n">max_y</span> <span class="o">=</span> <span class="n">y</span>
							<span class="n">max_attained</span> <span class="o">=</span> <span class="n">tmp_total</span>
				<span class="k">if</span> <span class="n">printing</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Checking complete               </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">max_attained</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c1"># Now do one last check for consistency</span>
				<span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_check</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">printing</span><span class="p">:</span>
						<span class="n">printing</span> <span class="o">=</span> <span class="bp">False</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shrinking due to high densities in sample zone.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
					<span class="c1"># Brute-force dividing by 2 each time</span>
					<span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
				<span class="k">if</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">or</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Max x,y: {}, {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Size: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fine map size: {}, {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span>
																	 <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sample map size: {}, {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span>
																	   <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">))</span>
					<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Incorrect dimension setting - please report this bug&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">=</span> <span class="n">size</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span> <span class="o">=</span> <span class="n">size</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">max_x</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">max_y</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;set&quot;</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_sample_map_equals_sample_grid</span><span class="p">():</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s2">&quot;Could not optimise maps for desired memory usage. &quot;</span>
								  <span class="s2">&quot;Attempted grid size of {} and achived max of {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">max_attained</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_wipe_objects</span><span class="p">()</span></div>

<div class="viewcode-block" id="Simulation.get_optimised_solution"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.get_optimised_solution">[docs]</a>	<span class="k">def</span> <span class="nf">get_optimised_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the optimised solution as a dictionary containing the important optimised variables.</span>
<span class="sd">		This can be read back in with set_optimised_solution</span>

<span class="sd">		:return: dict containing the important optimised variables</span>
<span class="sd">		:rtype: dict</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="p">{</span><span class="s2">&quot;grid_x_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span>
				<span class="s2">&quot;grid_y_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span>
				<span class="s2">&quot;sample_x_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span>
				<span class="s2">&quot;sample_y_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span>
				<span class="s2">&quot;grid_file_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span><span class="p">}</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="Simulation.set_optimised_solution"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.set_optimised_solution">[docs]</a>	<span class="k">def</span> <span class="nf">set_optimised_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_in</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the optimised RAM solution from the variables in the provided dictionary.</span>
<span class="sd">		This should contain the grid_x_size, grid_y_size, grid_file_name, sample_x_offset and sample_y_offset.</span>

<span class="sd">		:param dict dict_in: the dictionary containing the optimised RAM solution variables</span>
<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;grid_x_size&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;grid_y_size&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;sample_x_offset&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;sample_y_offset&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;grid_file_name&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Simulation.finalise_setup"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.finalise_setup">[docs]</a>	<span class="k">def</span> <span class="nf">finalise_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Runs all setup routines to provide a complete simulation. Should be called immediately before run_coalescence()</span>
<span class="sd">		to ensure the simulation setup is complete.</span>

<span class="sd">		:param ignore_errors: if true, any FileNotFoundError and FileExistsError raised by checking the output database</span>
<span class="sd">							  are ignored</span>
<span class="sd">		:param expected: set to true if we expect the output file to exist</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_simulation_params</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">run_checks</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>
		<span class="k">except</span> <span class="p">(</span><span class="n">FileExistsError</span><span class="p">,</span> <span class="n">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">err</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="c1"># Now check if config files need to be written.</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_map_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_list</span> <span class="ow">and</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_map_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_historical_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historical_fine_map_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_coarse_map_file</span><span class="p">,</span>
									<span class="bp">self</span><span class="o">.</span><span class="n">gen_since_historical</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">habitat_change_rate</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">create_config</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">create_map_config</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setupNECSim</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span><span class="o">.</span><span class="n">import_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_string</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span><span class="o">.</span><span class="n">import_from_config_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_string</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Simulation.setupNECSim"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.setupNECSim">[docs]</a>	<span class="k">def</span> <span class="nf">setupNECSim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the type of the simulation (spatial/non-spatial, protracted/non-protracted) and sets the c object</span>
<span class="sd">		appropriately.</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span> <span class="o">=</span> <span class="n">necsimmodule</span><span class="o">.</span><span class="n">CPSpatialSimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">write_to_log</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span> <span class="o">=</span> <span class="n">necsimmodule</span><span class="o">.</span><span class="n">CPNSESimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">write_to_log</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span> <span class="o">=</span> <span class="n">necsimmodule</span><span class="o">.</span><span class="n">CSpatialSimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">write_to_log</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span> <span class="o">=</span> <span class="n">necsimmodule</span><span class="o">.</span><span class="n">CNSESimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">write_to_log</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.set_speciation_rates"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.set_speciation_rates">[docs]</a>	<span class="k">def</span> <span class="nf">set_speciation_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_rates</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Add speciation rates for analysis at the end of the simulation. This is optional</span>

<span class="sd">		:param list speciation_rates: a list of speciation rates to apply at the end of the simulation</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">speciation_rates</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.calculate_sql_database"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.calculate_sql_database">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_sql_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Saves the output database location to self.output_database.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;data_{}_{}.db&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">),</span>
																						  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Simulation.check_sql_database"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.check_sql_database">[docs]</a>	<span class="k">def</span> <span class="nf">check_sql_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks whether the output database exists. If the existance does not match the expected variable, raises an</span>
<span class="sd">		error.</span>

<span class="sd">		:raises FileExistsError: if the file already exists when it&#39;s not expected to</span>
<span class="sd">		:raises FileNotExistsError: if the file does not exist when we expect it to</span>

<span class="sd">		:param expected: boolean for expected existance of the output file</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">t</span> <span class="o">=</span> <span class="n">CoalescenceTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
					<span class="k">pass</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">FileExistsError</span><span class="p">(</span><span class="s2">&quot;Output sql database already exists.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Output sql database {} not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">))</span></div>

<div class="viewcode-block" id="Simulation.check_maps"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.check_maps">[docs]</a>	<span class="k">def</span> <span class="nf">check_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks that the maps all exist and that the file structure makes sense.</span>

<span class="sd">		:raises TypeError: if a dispersal map or reproduction map is specified, we must have a fine map specified, but</span>
<span class="sd">			not a coarse map.</span>

<span class="sd">		:raises IOError: if one of the required maps does not exist</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spatial</span><span class="p">:</span>
			<span class="n">Landscape</span><span class="o">.</span><span class="n">check_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span> <span class="ow">and</span> \
					<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">or</span> \
					<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Grid is not within the sample map - please check offsets of sample map.&quot;</span><span class="p">)</span>
			<span class="c1"># Now check our combination of dispersal map, reproduction map and infinite landscape with our fine/coarse maps</span>
			<span class="c1"># makes sense</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">}:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">}:</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot use a coarse map if using a dispersal map. &quot;</span>
									<span class="s2">&quot;This feature is currently unsupported.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">}:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">}:</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot use a coarse map if using a reproduction map. &quot;</span>
									<span class="s2">&quot;This feature is currently unsupported.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.run_checks"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.run_checks">[docs]</a>	<span class="k">def</span> <span class="nf">run_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Check that the simulation is correctly set up and that all the required files exist.</span>

<span class="sd">		:param expected: set to true if we expect the output file to already exist</span>

<span class="sd">		:raises RuntimeError: if previous set-up routines are not complete</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">check_maps</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Set up is incomplete.&quot;</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_sql_database</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.run"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.run">[docs]</a>	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Convenience function which completes setp, runs the simulation and calculates the coalescence tree for the set</span>
<span class="sd">		speciation rates in one step.</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">finalise_setup</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_run_and_output</span><span class="p">()</span></div>

	<span class="k">def</span> <span class="nf">_run_and_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Runs the simulation and outputs to the database. Should only be called internally.</span>

<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_coalescence</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">apply_speciation_rates</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Simulation did not complete in time specified.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Resume with extra time to continue.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Simulation.run_coalescence"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.run_coalescence">[docs]</a>	<span class="k">def</span> <span class="nf">run_coalescence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Attempt to run the simulation with the given simulation set-up.</span>
<span class="sd">		This is the main routine performing the actual simulation which will take a considerable amount of time.</span>

<span class="sd">		:return: True if the simulation completes successfully, False if the simulation pauses.</span>

<span class="sd">		:rtype: bool</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span><span class="p">:</span>
			<span class="c1"># Make the output directory if it doesn&#39;t yet exist</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">):</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
			<span class="c1"># Call the c++ object and run the simulation</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Set up is incomplete.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.apply_speciation_rates"><a class="viewcode-back" href="../../pycoalescence.html#pycoalescence.simulation.Simulation.apply_speciation_rates">[docs]</a>	<span class="k">def</span> <span class="nf">apply_speciation_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_rates</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Applies the speciation rates to the coalescence tree and outputs to the database.</span>

<span class="sd">		:param speciation_rates: a list of speciation rates to apply</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">speciation_rates</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">speciation_rates</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">)]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">c_simulation</span><span class="o">.</span><span class="n">apply_speciation_rates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">)</span></div>

	<span class="k">def</span> <span class="nf">_wipe_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Clears the arrays from memory</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">def</span> <span class="nf">_fine_map_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks the total number of individuals in a subset from the fine map is less than the average density multiplied</span>
<span class="sd">		by the size of the square.</span>

<span class="sd">		:param max_x: the x value to start subsetting from</span>
<span class="sd">		:param max_y: the y value to start subsetting from</span>
<span class="sd">		:param size: the size of the square</span>
<span class="sd">		:return: bool true if it is smaller</span>
<span class="sd">		:rtype: bool</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density_actual</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">*</span> <span class="n">size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/PyCoal_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pycoalescence 1.2.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright Copyright 2016, pycoalescence.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>