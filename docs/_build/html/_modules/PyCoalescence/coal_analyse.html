
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PyCoalescence.coal_analyse &#8212; PyCoalescence 1.2.5 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.2.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
    <script type="text/javascript" src="../../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <link rel="shortcut icon" href="../../_static/PyCoal_favicon_large.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyCoalescence 1.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyCoalescence.coal_analyse</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the operations for performing basic analysis on the output of a PyCoalescence simulation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
	<span class="c1"># Python 3 compatibility</span>
	<span class="kn">import</span> <span class="nn">sqlite</span> <span class="kn">as</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isclose</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
	<span class="c1"># Python 2 compatibility</span>
	<span class="k">def</span> <span class="nf">isclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-09</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:param a: value 1</span>
<span class="sd">		:param b: value 2</span>
<span class="sd">		:param rel_tol: percentage relative to larger value</span>
<span class="sd">		:param abs_tol: absolute value for similarity</span>
<span class="sd">		:return: true for significantly different a and b, false otherwise</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rel_tol</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span> <span class="n">abs_tol</span><span class="p">)</span>
<span class="n">e_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="kn">from</span> <span class="nn">.build</span> <span class="kn">import</span> <span class="n">applyspecmodule</span>
	<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
		<span class="n">e_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span>
		<span class="kn">from</span> <span class="nn">build</span> <span class="kn">import</span> <span class="n">applyspecmodule</span>
	<span class="n">ApplySpecError</span> <span class="o">=</span> <span class="n">applyspecmodule</span><span class="o">.</span><span class="n">ApplySpecError</span>
	<span class="n">applyspec_import</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not import the apply speciation module. Using deprecated mode.&quot;</span><span class="p">)</span>
	<span class="n">e_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">e_list</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">))</span>
	<span class="n">applyspecmodule</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">applyspec_import</span> <span class="o">=</span> <span class="bp">False</span>

	<span class="c1"># Empty class for exception handling</span>
	<span class="k">class</span> <span class="nc">ApplySpecError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
		<span class="k">pass</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="c1"># import pdb</span>

<span class="kn">from</span> <span class="nn">.system_operations</span> <span class="kn">import</span> <span class="n">execute_log_info</span><span class="p">,</span> <span class="n">mod_directory</span><span class="p">,</span> <span class="n">create_logger</span><span class="p">,</span> <span class="n">write_to_log</span>
<span class="kn">import</span> <span class="nn">PyCoalescence</span>
<span class="c1"># Reads the parameter descriptions from the json file.</span>
<span class="k">try</span><span class="p">:</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mod_directory</span><span class="p">,</span> <span class="s2">&quot;reference&quot;</span><span class="p">,</span> <span class="s2">&quot;parameter_descriptions.json&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">_parameter_descriptions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find parameter dictionary. Check install is complete.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="get_parameter_description"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.get_parameter_description">[docs]</a><span class="k">def</span> <span class="nf">get_parameter_description</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Gets the parameter descriptions for the supplied key. If the key is None, returns all keys.</span>

<span class="sd">	:param key: the simulation parameter</span>

<span class="sd">	:return: string containing the parameter description or a dict containing all values if no key is supplied</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">_parameter_descriptions</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">_parameter_descriptions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Key {} was not found in parameter dictionary. Use key=None to show the whole dictionary&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="checkSqlTableExists"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.checkSqlTableExists">[docs]</a><span class="k">def</span> <span class="nf">check_sql_table_exist</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Checks that the supplied table exists in the supplied database.</span>

<span class="sd">	:param database: the database to check existence in</span>
<span class="sd">	:param table_name: the table name to check for</span>

<span class="sd">	:return: boolean of whether the table exists</span>
<span class="sd">	:rtype: bool</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39; AND name=&#39;?&#39;&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span></div>


<div class="viewcode-block" id="Tree"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree">[docs]</a><span class="k">class</span> <span class="nc">Tree</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Contains the coalescence tree and performs various calculations of different biodiversity metrics, which are then</span>
<span class="sd">	stored in the SQLite database.</span>

<span class="sd">	The general process is</span>

<span class="sd">	* Import the database (:py:meth:`~set_database`) and import the comparison data,</span>
<span class="sd">	  if required (:py:meth:`~import_comparison_data`)</span>

<span class="sd">	* Apply additional speciation rates (if required) using :py:meth:`~set_speciation_params` and</span>
<span class="sd">	  :py:meth:`~apply_speciation`</span>

<span class="sd">	* Calculate required metrics (such as :py:meth:`~calculate_fragment_richness`)</span>
<span class="sd">	* Optionally, calculate the goodness of fit (:py:meth:`~calculate_goodness_of_fit`)</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">log_output</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Initiates the Tree object. By default, links to the SpeciationCounter program stored in</span>
<span class="sd">		build/default/SpeciationCounter, but optionally takes speciation_program as a path to an alternative program.</span>

<span class="sd">		:param database: optionally specify the path to call :py:meth:`~set_database` to</span>
<span class="sd">		:param logging_level: the level from the logging module for desired terminal outputs</span>
<span class="sd">		:param log_output: optionally provide a file to output information to instead</span>
<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># speciation objects</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">equalised</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_speciation</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">record_spatial</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">record_fragments</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_simulator</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">applied_speciation_rates_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="c1"># Other objects</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">total_individuals</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances_whole</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">comparison_data</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="c1"># Support for deprecated methods</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">apply_spec_module</span> <span class="o">=</span> <span class="n">applyspecmodule</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;applyspeclogger&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging_level</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_create_logger</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">log_output</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">applyspec_import</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mod_directory</span><span class="p">,</span> <span class="s2">&quot;build/default/SpeciationCounter&quot;</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Closes the database connection.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
			<span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_create_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logging_level</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates the logger for use with applying speciation rates to a simulation.</span>
<span class="sd">		This function should only be run during :py:meth:`~__init__`</span>

<span class="sd">		.. tip:: Supply your own logger by over-riding :attr:`~import_comparison_data`.</span>

<span class="sd">		:param file: file to write output to. If None, outputs to terminal</span>
<span class="sd">		:param logging_level: the logging level to use (defaults to INFO)</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">logging_level</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">logging_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">logging_level</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_check_fragment_numbers_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks that the numbers of individuals match between the comparison_abundances object and the simulation</span>
<span class="sd">		database for each fragment</span>

<span class="sd">		:return: boolean, true if the numbers match</span>
<span class="sd">		:rtype: bool</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_fragment_abundances</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">import_comparison_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot check matched numbers before importing comparison database.&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">]):</span>
			<span class="n">sum_simulated</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fragment</span> <span class="ow">and</span>
								 <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
								 <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]])</span>
			<span class="k">if</span>  <span class="n">sum_simulated</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fragment</span><span class="p">]):</span>
				<span class="k">return</span> <span class="bp">False</span>
		<span class="k">return</span> <span class="bp">True</span>

	<span class="k">def</span> <span class="nf">_equalise_fragment_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Equalises the number of individuals in the provided fragment, altering comparison_abundances and fragments so</span>
<span class="sd">		that the numbers are equal between the two.</span>

<span class="sd">		:param fragment: the fragment to alter</span>
<span class="sd">		:param speciation_rate: the speciation rate to equalise for</span>
<span class="sd">		:param time: the time to equalise at</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">total_fragments</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fragment</span> <span class="ow">and</span>
							   <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">speciation_rate</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">total_fragments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No individuals found in simulated data for fragment {}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fragment</span><span class="p">))</span>
		<span class="n">total_comparison</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fragment</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">total_comparison</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No individuals found in comparison data for fragment {}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fragment</span><span class="p">))</span>
		<span class="n">difference</span> <span class="o">=</span> <span class="n">total_fragments</span> <span class="o">-</span> <span class="n">total_comparison</span>
		<span class="k">if</span> <span class="n">difference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="c1"># need to remove individuals from fragments</span>
			<span class="k">while</span> <span class="n">difference</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c1"># pick a random individual</span>
				<span class="n">rand_individual</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_fragments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">tmp_total</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fragment</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">speciation_rate</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span><span class="p">:</span>
						<span class="n">tmp_total</span> <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">tmp_total</span> <span class="o">&gt;</span> <span class="n">rand_individual</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
								<span class="n">difference</span> <span class="o">-=</span> <span class="mi">1</span>
								<span class="n">total_fragments</span> <span class="o">-=</span> <span class="mi">1</span>
								<span class="k">break</span>
		<span class="k">elif</span> <span class="n">difference</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="c1"># need to remove individuals from comparison_abundances</span>
			<span class="k">while</span> <span class="n">difference</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c1"># pick a random individual</span>
				<span class="n">rand_individual</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_comparison</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">tmp_total</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fragment</span><span class="p">:</span>
						<span class="n">tmp_total</span> <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">tmp_total</span> <span class="o">&gt;</span> <span class="n">rand_individual</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
								<span class="n">difference</span> <span class="o">+=</span> <span class="mi">1</span>
								<span class="n">total_comparison</span> <span class="o">-=</span> <span class="mi">1</span>
								<span class="k">break</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>



	<span class="k">def</span> <span class="nf">_equalise_all_fragment_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Equalises the numbers in the fragments, removing individuals randomly from either the comparison_abundances or</span>
<span class="sd">		fragments objects so that the numbers are preserved.</span>

<span class="sd">		This is called automatically during importing the data for calculating comparison octaves, and should be called</span>
<span class="sd">		after importing all data, and before performing and goodness-of-fits.</span>

<span class="sd">		:return: None</span>
<span class="sd">		:rtype: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalised</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot equalise fragment numbers if comparison or simulation data is missing.&quot;</span><span class="p">)</span>
		<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_simulation_parameters</span><span class="p">()[</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">]):</span>
			<span class="k">for</span> <span class="n">speciation_rate</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">]):</span>
				<span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">]):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_equalise_fragment_number</span><span class="p">(</span><span class="n">fragment</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
		<span class="c1"># now double check numbers match</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragment_numbers_match</span><span class="p">():</span>
			<span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span><span class="s2">&quot;Failure attempting to equalise fragment numbers.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">equalise</span> <span class="o">=</span> <span class="bp">True</span>



<div class="viewcode-block" id="Tree.setup"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.setup">[docs]</a>	<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_program</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mod_directory</span><span class="p">,</span> <span class="s2">&quot;build/default/SpeciationCounter&quot;</span><span class="p">)):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets up the link to the SpeciationCounter program. Defaults to the build/default/SpeciationCounter</span>
<span class="sd">		:param speciation_program: optionally provide a path to an alternative SpeciationCounter program.</span>

<span class="sd">		.. deprecated:: 1.2.4</span>
<span class="sd">			Deprecated due to movement towards using python API for applying speciation rates.</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_simulator</span> <span class="o">=</span> <span class="n">speciation_program</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speciation_simulator</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Speciation simulator &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_simulator</span> <span class="o">+</span>
						  <span class="s2">&quot; not found. Check file path and access.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tree.set_database"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.set_database">[docs]</a>	<span class="k">def</span> <span class="nf">set_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the database to the specified file and opens the sqlite connection.</span>

<span class="sd">		This must be done before any other operations can be performed and the</span>
<span class="sd">		file must exist.</span>

<span class="sd">		:raises IOError: if the simulation is not complete, as analysis can only be performed on complete simulations.</span>
<span class="sd">		 However, the database WILL be set before the error is thrown, allowing for analysis of</span>
<span class="sd">		 incomplete simulations if the error is handled correctly.</span>

<span class="sd">		:param filename: the SQLite database file to import</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">PyCoalescence</span><span class="o">.</span><span class="n">coalescence</span><span class="o">.</span><span class="n">Coalescence</span><span class="p">):</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">output_database</span>
			<span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Coalescence object does has not been set up properly and does not contain an output&quot;</span>
								   <span class="s2">&quot; database location.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">filename</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
				<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
					<span class="k">pass</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">None</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error opening SQLite database: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
			<span class="c1"># Now make sure that the simulation has been completed</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
				<span class="n">sql_fetch</span> <span class="o">=</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT sim_complete, time_config_file FROM SIMULATION_PARAMETERS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
				<span class="c1"># print(sql_fetch)</span>
				<span class="n">complete</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sql_fetch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">if</span> <span class="n">sql_fetch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sql_fetch</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">complete</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span> <span class="o">=</span> <span class="bp">False</span>
					<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot; is not a complete simulation. Please finish &quot;</span> \
											 <span class="s2">&quot;simulation before performing analysis.&quot;</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">soe</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
				<span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Error checking simulation was complete: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">soe</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;File &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot; does not exist.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tree.set_speciation_params"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.set_speciation_params">[docs]</a>	<span class="k">def</span> <span class="nf">set_speciation_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_spatial</span><span class="p">,</span> <span class="n">record_fragments</span><span class="p">,</span> <span class="n">speciation_rates</span><span class="p">,</span> <span class="n">sample_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
							  <span class="n">time_config_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">		Set the parameters for the application of speciation rates. If no config files or time_config files are provided,</span>
<span class="sd">		they will be taken from the main coalescence simulation.</span>

<span class="sd">		:rtype: None</span>
<span class="sd">		:param bool, str record_spatial: a boolean of whether to record spatial data</span>
<span class="sd">		:param bool, str record_fragments: either a csv file containing fragment data, or T/F for whether fragments should be</span>
<span class="sd">			calculated from squares of continuous habitat.</span>
<span class="sd">		:param list speciation_rates: a list of speciation rates to apply</span>
<span class="sd">		:param str sample_file: a sample tif or csv specifying the sampling mask</span>
<span class="sd">		:param str time_config_file: a configuration file of temporal sampling points</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record_fragments</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">record_fragments</span><span class="p">:</span>
				<span class="n">record_fragments</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">record_fragments</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span>
		<span class="k">if</span> <span class="n">record_fragments</span> <span class="ow">is</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
			<span class="n">record_fragments</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
		<span class="k">if</span> <span class="n">speciation_rates</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No speciation rates supplied: requires at least 1 for analysis.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">record_spatial</span> <span class="ow">is</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
			<span class="n">record_spatial</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">elif</span> <span class="n">record_spatial</span> <span class="ow">is</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span>
			<span class="n">record_spatial</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record_spatial</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;record_spatial must be a boolean.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_speciation</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">record_spatial</span> <span class="o">=</span> <span class="n">record_spatial</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">record_fragments</span> <span class="o">=</span> <span class="n">record_fragments</span>
			<span class="k">if</span> <span class="n">sample_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sample file provided, defaulting to null.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span> <span class="o">=</span> <span class="n">sample_file</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">time_config_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No time config file provided, defaulting to null.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="n">time_config_file</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">applied_speciation_rates_list</span> <span class="o">=</span> <span class="n">speciation_rates</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Speciation parameters already set.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_fragments</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify a null samplemask and expect automatic fragment detection; &quot;</span>
							 <span class="s2">&quot;provide a samplemask or set record_fragments=False.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tree.apply_speciation"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.apply_speciation">[docs]</a>	<span class="k">def</span> <span class="nf">apply_speciation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates the list of speciation options and performs the speciation analysis by calling SpeciationCounter.</span>
<span class="sd">		This must be run after the main coalescence simulations are complete.</span>
<span class="sd">		It will create additional fields and tables in the SQLite database which contains the requested data.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># Check file exists</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;Check file existance for &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">+</span>
							  <span class="s2">&quot;. Potential lack of access (verify that definition is a relative path).&quot;</span><span class="p">),</span>
						  <span class="ne">RuntimeWarning</span><span class="p">)</span>
		<span class="c1"># Convert fragment file to null if it is true</span>
		<span class="c1"># Log warning if sample file is null and record fragments is true</span>
		<span class="k">if</span> <span class="n">applyspec_import</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">apply_spec_module</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">apply_spec_module</span><span class="o">.</span><span class="n">set_log_function</span><span class="p">(</span><span class="n">write_to_log</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">apply_spec_module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_spatial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span><span class="p">,</span>
									  <span class="bp">self</span><span class="o">.</span><span class="n">record_fragments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">applied_speciation_rates_list</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">ApplySpecError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using deprecated speciation application method.&quot;</span><span class="p">)</span>
			<span class="n">sim_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">speciation_simulator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_spatial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_file</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_fragments</span><span class="p">]</span>
			<span class="n">sim_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">applied_speciation_rates_list</span><span class="p">])</span>
			<span class="n">sim_list_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sim_list</span><span class="p">]</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">execute_log_info</span><span class="p">(</span><span class="n">sim_list_str</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">cpe</span><span class="p">:</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;CalledProcessError while applying speciation rates: &quot;</span> <span class="o">+</span>
							  <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sim_list_str</span><span class="p">]))</span>
				<span class="k">raise</span> <span class="n">cpe</span></div>

<div class="viewcode-block" id="Tree.get_richness"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_richness">[docs]</a>	<span class="k">def</span> <span class="nf">get_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the system richness for the supplied speciation rate and time.</span>

<span class="sd">		.. note::</span>

<span class="sd">			Richness of 0 is returned if there has been some problem; it is assumed that species richness</span>
<span class="sd">			will be above 0 for any simulation.</span>

<span class="sd">		.. note:: Values generated by this method should be identical to those produced by self.get_landscape_richness()</span>

<span class="sd">		:param speciation_rate: the required speciation rate</span>
<span class="sd">		:param time: the required time</span>
<span class="sd">		:return: the system species richness</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database not set: cannot import richness.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;SELECT species_id, speciation_rate FROM SPECIES_ABUNDANCES WHERE no_individuals &gt; 0&quot;</span>
				<span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
					<span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot; AND generation == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
				<span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]))</span>
				<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">speciation_rate</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)]))</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">oe</span><span class="p">:</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oe</span><span class="p">))</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not find SPECIES_ABUNDANCES table in database &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Tree.get_octaves"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_octaves">[docs]</a>	<span class="k">def</span> <span class="nf">get_octaves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the pre-calculated octave data for the specified speciation rate and time.</span>
<span class="sd">		This will call self.calculate_octaves() if it hasn&#39;t been called previously.</span>

<span class="sd">		Returns are of form [id, &#39;whole&#39;, time, speciation rate, octave class, number of species]</span>

<span class="sd">		:param speciation_rate: the desired speciation rate</span>
<span class="sd">		:param time: the desired generation time (defaults to 0.0)</span>
<span class="sd">		:return: output from FRAGMENT_OCTAVES on the whole landscape for the selected variables</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">check_sql_table_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;FRAGMENT_OCTAVES&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_octaves</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_octaves</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="s2">&quot;whole&quot;</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="n">speciation_rate</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tree.check_biodiversity_table_exists"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.check_biodiversity_table_exists">[docs]</a>	<span class="k">def</span> <span class="nf">check_biodiversity_table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks whether the biodiversity table exists and creates the table if required.</span>
<span class="sd">		</span>
<span class="sd">		:return: the max reference value currently existing</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t read database.&quot;</span><span class="p">)</span>

		<span class="n">tmp_create</span> <span class="o">=</span> <span class="s2">&quot;CREATE TABLE BIODIVERSITY_METRICS (ref INT PRIMARY KEY NOT NULL,metric TEXT NOT NULL,&quot;</span> \
					 <span class="s2">&quot; fragment TEXT NOT NULL, time FLOAT NOT NULL,&quot;</span> \
					 <span class="s2">&quot;speciation_rate FLOAT NOT NULL, value FLOAT NOT NULL, simulated FLOAT, actual FLOAT)&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">check_sql_table_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;BIODIVERSITY_METRICS&quot;</span><span class="p">):</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tmp_create</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Error creating biodiversity metric table: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">maxval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT MAX(ref) FROM BIODIVERSITY_METRICS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">maxval</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">return</span> <span class="mi">0</span>
			<span class="k">return</span> <span class="n">maxval</span></div>

<div class="viewcode-block" id="Tree.calculate_richness"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_richness">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the landscape richness from across all fragments and stores result in a new table in</span>
<span class="sd">		SPECIES_RICHNESS</span>
<span class="sd">		Stores a separate result for each speciation rate and time.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="n">spec_abundances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM SPECIES_ABUNDANCES WHERE no_individuals&gt;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="n">tmp_create</span> <span class="o">=</span> <span class="s2">&quot;CREATE TABLE SPECIES_RICHNESS (ref INT PRIMARY KEY NOT NULL, speciation_rate FLOAT NOT NULL,&quot;</span> \
					 <span class="s2">&quot;time FLOAT NOT NULL, richness INT NOT NULL)&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">check_sql_table_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;SPECIES_RICHNESS&quot;</span><span class="p">):</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tmp_create</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Error creating SPECIES_RICHNESS table: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
				<span class="k">raise</span> <span class="n">e</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(ref) FROM SPECIES_RICHNESS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">spec_rates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spec_abundances</span><span class="p">])</span>
		<span class="n">times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spec_abundances</span><span class="p">])</span>
		<span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="n">spec_rates</span><span class="p">:</span>
				<span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spec_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">sr</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span>
				<span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ref</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">)])</span>
				<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span>
		<span class="n">bio_output</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
			<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref</span><span class="p">,</span> <span class="s2">&quot;fragment_richness&quot;</span><span class="p">,</span> <span class="s2">&quot;whole&quot;</span><span class="p">]</span>
			<span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
			<span class="n">bio_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO BIODIVERSITY_METRICS VALUES (?, ?, ?, ?, ?, ?, NULL, NULL)&quot;</span><span class="p">,</span> <span class="n">bio_output</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO SPECIES_RICHNESS VALUES(?,?,?,?)&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.get_landscape_richness"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_landscape_richness">[docs]</a>	<span class="k">def</span> <span class="nf">get_landscape_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Reads the landscape richness from the SPECIES_RICHNESS table in the database. Returns the richness for</span>
<span class="sd">		each speciation rate and time.</span>

<span class="sd">		.. note:: This should produce the same result as get_richness(sr, t) with the corresponding sr and t.</span>

<span class="sd">		.. note::</span>

<span class="sd">			Return type of this function changes based on whether speciation rates and times were supplied.</span>
<span class="sd">			If they were, returns a single integer. Otherwise, returns a list of all species richnesses.</span>

<span class="sd">		:param speciation_rate: the required speciation rate (optional)</span>
<span class="sd">		:param time: the required time</span>

<span class="sd">		:return: either a list containing the speciation_rate, time, richness OR (if specific speciation rate and time</span>
<span class="sd">		 provided), the species richness at that time and speciation rate.</span>

<span class="sd">		:rtype: int, list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;SELECT speciation_rate, time, richness FROM SPECIES_RICHNESS&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">richness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">oe</span><span class="p">:</span>
			<span class="n">oe</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Could not get SPECIES_RICHNESS table: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">oe</span><span class="p">))</span>
			<span class="k">raise</span> <span class="n">oe</span>
		<span class="k">if</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="c1"># pdb.set_trace()</span>
				<span class="c1"># print([x[2] for x in richness if round(x[0],8) == round(speciation_rate, 5) and x[1] == time][0])</span>
				<span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">richness</span> <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">speciation_rate</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
				<span class="k">return</span> <span class="mi">0</span>
		<span class="k">return</span> <span class="n">richness</span></div>

<div class="viewcode-block" id="Tree.calculate_fragment_abundances"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_fragment_abundances">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_fragment_abundances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the fragment abundances, including equalising with the comparison database, if it has already been</span>
<span class="sd">		set.</span>

<span class="sd">		Sets fragment_abundances object.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
										 <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT fragment, species_id,&quot;</span>
															 <span class="s2">&quot; no_individuals, speciation_rate,&quot;</span>
															 <span class="s2">&quot; generation FROM FRAGMENT_ABUNDANCES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_equalise_all_fragment_numbers</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Fragment abundances already imported.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tree.calculate_fragment_richness"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_fragment_richness">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_fragment_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the fragment richness and stores it in a new table called FRAGMENT_RICHNESS. Also adds the record to</span>
<span class="sd">		BIODIVERSITY METRICS for</span>
<span class="sd">		If the table already exists, it will simply be returned. Each time point and speciation rate combination will be</span>
<span class="sd">		recorded as a new variable.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="n">tmp_create</span> <span class="o">=</span> <span class="s2">&quot;CREATE TABLE FRAGMENT_RICHNESS (ref INT PRIMARY KEY NOT NULL, fragment TEXT NOT NULL,&quot;</span> \
					 <span class="s2">&quot; time FLOAT NOT NULL, speciation_rate FLOAT NOT NULL, richness INT NOT NULL)&quot;</span>
		<span class="c1"># First check the FRAGMENT_ABUNDANCES TABLE EXISTS</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_fragment_abundances</span><span class="p">()</span>
		<span class="c1"># Now try and create FRAGMENT_RICHNESS</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">check_sql_table_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;FRAGMENT_RICHNESS&quot;</span><span class="p">):</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tmp_create</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Could not create FRAGMENT_RICHNESS table&quot;</span><span class="p">)</span>
			<span class="n">fragment_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">fa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">]))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">fa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">]))</span>
			<span class="c1"># self.fragments.extend(([]*len(times)-1))</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">fragment_names</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">:</span>
						<span class="n">selection</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">each</span> <span class="ow">and</span>
									 <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">sr</span><span class="p">]</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ref</span><span class="p">,</span> <span class="n">each</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)])</span>
						<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO FRAGMENT_RICHNESS VALUES(?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT fragment, time, speciation_rate, richness&quot;</span>
											 <span class="s2">&quot; FROM FRAGMENT_RICHNESS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
		<span class="c1"># Move fragment richnesses into BIODIVERSITY METRICS</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span>
		<span class="n">tmp_fragments</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
			<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref</span><span class="p">,</span> <span class="s2">&quot;fragment_richness&quot;</span><span class="p">]</span>
			<span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
			<span class="n">tmp_fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO BIODIVERSITY_METRICS VALUES(?,?,?,?,?,?, NULL, NULL)&quot;</span><span class="p">,</span> <span class="n">tmp_fragments</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculate_richness</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.generate_biodiversity_metrics"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.generate_biodiversity_metrics">[docs]</a>	<span class="k">def</span> <span class="nf">generate_biodiversity_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Generates the biodiversity metrics table, adding in any calculations from the tables FRAGMENT_RICHNESS and</span>
<span class="sd">		FRAGMENT_OCTAVES.</span>

<span class="sd">		.. note:: Calls calculate_octaves_error() and calculate_fragment_richness() when required.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># TODO finish this implementation or remove</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">calculate_fragment_richness</span><span class="p">()</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping fragments as no fragment abundances could be found.&quot;</span><span class="p">)</span>
		<span class="c1"># First check that the biodiversity table exists</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="c1"># Need to check again to see if calculate_fragment_richness() was successful</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
			<span class="c1"># Move fragment richnesses into BIODIVERSITY METRICS</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="c1"># self.cursor.execute()</span>
			<span class="n">tmp_fragments</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">tmp_fragments</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ref</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)]</span>
			<span class="c1"># print(tmp_fragments)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO BIODIVERSITY_METRICS VALUES(?,?,?,?,?,?, NULL, NULL)&quot;</span><span class="p">,</span> <span class="n">tmp_fragments</span><span class="p">)</span>
		<span class="c1"># Now check if fragment octaves errors have been calculated.</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_octaves_error</span><span class="p">()</span>
		<span class="k">except</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping fragment octaves as no fragment octaves could be calculated&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.import_comparison_data"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.import_comparison_data">[docs]</a>	<span class="k">def</span> <span class="nf">import_comparison_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Imports the SQL database that contains the biodiversity metrics that we want to compare against.</span>

<span class="sd">		This can either be real data (for comparing simulated data) or other simulated data (for comparing between models).</span>

<span class="sd">		If the SQL database does not contain the relevant biodiversity metrics, they will be calculated (if possible) or skipped.</span>

<span class="sd">		The expected form of the database is the same as the BIODIVERSITY_METRICS table, except without any speciation</span>
<span class="sd">		rates or time references, and a new column containing the number of individuals involved in each metric.</span>

<span class="sd">		.. note::</span>

<span class="sd">			This also equalises the comparison data, so that the number of individuals is equal between the simulated</span>
<span class="sd">			and comparison datasets.</span>

<span class="sd">		:param str filename: the file containing the comparison biodiversity metrics.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
		<span class="n">tmp_cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Comparison data has already been imported.&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">comparison_data</span> <span class="o">=</span> <span class="n">tmp_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM BIODIVERSITY_METRICS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
					<span class="s2">&quot;SELECT Plot, Mnemonic, Abund FROM FRAGMENT_ABUNDANCES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances_whole</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
					<span class="s2">&quot;SELECT SpeciesID, Abund FROM SPECIES_ABUNDANCES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">oe</span><span class="p">:</span>
				<span class="n">oe</span><span class="o">.</span><span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Problem executing fetches from comparison data: &quot;</span>
				<span class="k">raise</span> <span class="n">oe</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span> <span class="o">=</span> <span class="n">filename</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">oe</span><span class="p">:</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oe</span><span class="p">))</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not import from comparison data.&quot;</span><span class="p">)</span>
		<span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragment_numbers_match</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_equalise_all_fragment_numbers</span><span class="p">()</span></div>
		<span class="c1"># print(self.comparison_data)</span>
		<span class="c1"># exit(0)</span>

<div class="viewcode-block" id="Tree.calculate_comparison_octaves"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_comparison_octaves">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_comparison_octaves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the octave classes for the comparison data and for fragments (if required).</span>
<span class="sd">		If the octaves exist in the FRAGMENT_OCTAVES table in the comparison database, the data will be imported</span>
<span class="sd">		instead of being re-calculated.</span>

<span class="sd">		Stores the new octave classes in self.comparison_octaves.</span>

<span class="sd">		.. note::</span>

<span class="sd">		 	If store is True, will store an EDITED version of the comparison octaves, such that the number of</span>
<span class="sd">			individuals is equal between the comparison and simulated data.</span>

<span class="sd">		:param store: if True, stores within the comparison database.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="c1"># If comparison_octaves has not been calculated, then do that now.</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
					<span class="s2">&quot;Comparison abundances not yet imported, or FRAGMENT_ABUNDANCES does not exist in comparison file.&quot;</span><span class="p">)</span>
			<span class="c1"># Check whether the FRAGMENT_OCTAVES table exists, if it is, just stored that in self.comparison_octaves</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="c1"># read the data from the database</span>
				<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span><span class="p">)</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">check_sql_table_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;FRAGMENT_OCTAVES&quot;</span><span class="p">):</span>
					<span class="n">tmp_list</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT fragment, octave, num_species FROM FRAGMENT_OCTAVES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="o">=</span> <span class="n">tmp_list</span>
						<span class="n">store</span> <span class="o">=</span> <span class="bp">False</span>
			<span class="c1"># Need to calculate again if the fragment numbers don&#39;t match</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragment_numbers_match</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="c1"># Otherwise, if comparison abundances exists, we can calculate the comparison octaves manually</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fragment_numbers_match</span><span class="p">():</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_equalise_fragment_numbers</span><span class="p">()</span>
				<span class="c1"># now calculate octaves</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="n">fragments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span><span class="p">])</span>
				<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">:</span>
					<span class="n">octaves</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
					<span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
					<span class="n">octaves</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
					<span class="n">abundances</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
					<span class="c1"># print(abundances)</span>
					<span class="c1"># exit(0)</span>
					<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">:</span>
						<span class="n">this_octave</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
						<span class="k">if</span> <span class="n">this_octave</span> <span class="ow">in</span> <span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
							<span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">this_octave</span><span class="p">]</span>
							<span class="c1"># print(octaves)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span><span class="p">[</span><span class="n">octaves</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">this_octave</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
							<span class="c1"># print(self.comparison_octaves)</span>
							<span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_octave</span><span class="p">)</span>
							<span class="n">octaves</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
							<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="c1"># print(len(self.comparison_octaves)-1)</span>
				<span class="n">octaves</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
				<span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="n">octaves</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="n">abundances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_abundances_whole</span>
				<span class="c1"># print(abundances)</span>
				<span class="c1"># exit(0)</span>
				<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">:</span>
					<span class="n">this_octave</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
					<span class="k">if</span> <span class="n">this_octave</span> <span class="ow">in</span> <span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
						<span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">this_octave</span><span class="p">]</span>
						<span class="c1"># print(octaves)</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span><span class="p">[</span><span class="n">octaves</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;whole&quot;</span><span class="p">,</span> <span class="n">this_octave</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
						<span class="c1"># print(self.comparison_octaves)</span>
						<span class="n">octaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_octave</span><span class="p">)</span>
						<span class="n">octaves</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
						<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="c1"># now sort the list</span>
			<span class="c1"># If we want to store the comparison octaves, overwrite the original FRAGMENT_OCTAVES table (if it exists</span>
			<span class="c1"># with the new calculated data</span>
			<span class="k">if</span> <span class="n">store</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Comparison file has not been imported yet, and therefore cannot be written to.&quot;</span><span class="p">)</span>
				<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span><span class="p">)</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
				<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS FRAGMENT_OCTAVES&quot;</span><span class="p">)</span>
				<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
					<span class="s2">&quot;CREATE TABLE FRAGMENT_OCTAVES (ref INT PRIMARY KEY NOT NULL, fragment TEXT NOT NULL, &quot;</span>
					<span class="s2">&quot;octave INT NOT NULL, num_species INT NOT NULL)&quot;</span><span class="p">)</span>
				<span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO FRAGMENT_OCTAVES values(?,?,?,?)&quot;</span><span class="p">,</span>
								   <span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span><span class="p">)])</span>
				<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Tree.calculate_octaves"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_octaves">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_octaves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the octave classes for the landscape. Outputs the calculated richness into the SQL database within a</span>
<span class="sd">		FRAGMENT_OCTAVES table.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
			<span class="s2">&quot;CREATE TABLE IF NOT EXISTS FRAGMENT_OCTAVES (ref INT PRIMARY KEY NOT NULL, fragment TEXT NOT NULL, &quot;</span>
			<span class="s2">&quot;time FLOAT NOT NULL, speciation_rate FLOAT NOT NULL, octave INT NOT NULL, &quot;</span>
			<span class="s2">&quot;number INT NOT NULL)&quot;</span><span class="p">)</span>
		<span class="n">abundances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM SPECIES_ABUNDANCES WHERE no_individuals&gt;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="n">spec_rates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">])</span>
		<span class="n">times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">])</span>
		<span class="c1"># Check what the maximum reference is in FRAGMENT_OCTAVES</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT max(ref) FROM FRAGMENT_OCTAVES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="k">except</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
			<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec_rates</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
				<span class="n">select_abundances</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">abundances</span> <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span>
				<span class="n">log_select</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">select_abundances</span><span class="p">]</span>
				<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">log_select</span><span class="p">)),</span> <span class="mi">1</span><span class="p">):</span>
						<span class="n">tot</span> <span class="o">=</span> <span class="n">log_select</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
						<span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;whole&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tot</span><span class="p">])</span>
						<span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">ve</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO FRAGMENT_OCTAVES values (?,?,?,?,?,?)&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
				<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">oe</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Could not insert into FRAGMENT_OCTAVES.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">oe</span><span class="p">))</span></div>

<div class="viewcode-block" id="Tree.calculate_fragment_octaves"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_fragment_octaves">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_fragment_octaves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the octave classes for each fragment. Outputs the calculated richness into the SQL database within a</span>
<span class="sd">		FRAGMENT_OCTAVES table</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
			<span class="s2">&quot;CREATE TABLE IF NOT EXISTS FRAGMENT_OCTAVES (ref INT PRIMARY KEY NOT NULL, fragment TEXT NOT NULL, &quot;</span>
			<span class="s2">&quot;time FLOAT NOT NULL, speciation_rate FLOAT NOT NULL, octave INT NOT NULL, &quot;</span>
			<span class="s2">&quot;number INT NOT NULL)&quot;</span><span class="p">)</span>
		<span class="n">exist_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM FRAGMENT_OCTAVES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">exist_check</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;FRAGMENT_OCTAVES already exists&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_fragment_abundances</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fragments not imported correctly&quot;</span><span class="p">)</span>
		<span class="n">fragments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">])</span>
		<span class="n">spec_rates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">])</span>
		<span class="n">times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span><span class="p">])</span>
		<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec_rates</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
					<span class="n">select_abundances</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_abundances</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span> <span class="ow">and</span>
										 <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_abundances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not calculate fragment octaves for {}, with s = {}, t = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
					<span class="n">log_select</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">select_abundances</span><span class="p">]</span>
					<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">log_select</span><span class="p">)),</span> <span class="mi">1</span><span class="p">):</span>
						<span class="n">tot</span> <span class="o">=</span> <span class="n">log_select</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
						<span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tot</span><span class="p">])</span>
						<span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO FRAGMENT_OCTAVES values (?,?,?,?,?,?)&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
					<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">oe</span><span class="p">:</span>
						<span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Could not insert into FRAGMENT_OCTAVES.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">oe</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculate_octaves</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.get_fragment_richness"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_fragment_richness">[docs]</a>	<span class="k">def</span> <span class="nf">get_fragment_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the fragment richness for each speciation rate and time for the specified simulation. If the fragment</span>
<span class="sd">		richness has not yet been calculated, it tries to calculate the fragment richness,</span>


<span class="sd">		:param fragment: the desired fragment (defaults to None)</span>
<span class="sd">		:param speciation_rate: the desired speciation rate (defaults to None)</span>
<span class="sd">		:param time: the desired generation time (defaults to 0.0)</span>

<span class="sd">		:raises: sqlite3.OperationalError if no table FRAGMENT_ABUNDANCES exists</span>
<span class="sd">		:raises: RuntimeError if no data for the specified fragment, speciation rate and time exists.</span>

<span class="sd">		:return: A list containing the fragment richness</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">fragment</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">calculate_fragment_richness</span><span class="p">()</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span>
		<span class="k">elif</span> <span class="n">fragment</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Only one of fragment or speciation rate supplied: must supply both, or neither.&quot;</span><span class="p">)</span>
		<span class="n">select_statement</span> <span class="o">=</span> <span class="s2">&quot;SELECT fragment, time, speciation_rate, richness FROM FRAGMENT_RICHNESS WHERE time == &quot;</span> <span class="o">+</span>\
						   <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and fragment == &#39;&quot;</span> <span class="o">+</span> <span class="n">fragment</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
		<span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select_statement</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No output while fetching fragment data: &quot;</span> <span class="o">+</span> <span class="n">select_statement</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">fragment_richness</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">speciation_rate</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">fragment_richness</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Tree.get_fragment_octaves"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_fragment_octaves">[docs]</a>	<span class="k">def</span> <span class="nf">get_fragment_octaves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the pre-calculated octave data for the specified fragment, speciation rate and time. If fragment and</span>
<span class="sd">		speciation_rate are None, returns the entire FRAGMENT_OCTAVES object</span>
<span class="sd">		This requires self.calculate_fragment_octaves() to have been run successfully at some point previously.</span>

<span class="sd">		Returns are of form [id, fragment, time, speciation rate, octave class, number of species]</span>

<span class="sd">		:param fragment: the desired fragment (defaults to None)</span>
<span class="sd">		:param speciation_rate: the desired speciation rate (defaults to None)</span>
<span class="sd">		:param time: the desired generation time (defaults to 0.0)</span>

<span class="sd">		:return: output from FRAGMENT_OCTAVES for the selected variables</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">fragment</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM FRAGMENT_OCTAVES&quot;</span><span class="p">)]</span>
		<span class="k">elif</span> <span class="n">fragment</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Only one of fragment or speciation rate supplied: must supply both, or neither.&quot;</span><span class="p">)</span>
		<span class="n">select_statement</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM FRAGMENT_OCTAVES WHERE time == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> \
						   <span class="s2">&quot; and fragment == &#39;&quot;</span> <span class="o">+</span> <span class="n">fragment</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
		<span class="c1">## Hacky way to get around SQL&#39;s float-rounding issues.</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select_statement</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No output while fetching fragment data: &quot;</span> <span class="o">+</span> <span class="n">select_statement</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">speciation_rate</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)]</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">oe</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Failure whilst fetching fragment octave data.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">oe</span><span class="p">))</span>
		<span class="n">output</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="Tree.get_species_abundances"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_species_abundances">[docs]</a>	<span class="k">def</span> <span class="nf">get_species_abundances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the species abundance for a particular fragment, speciation rate and time. If fragment is None, returns the</span>
<span class="sd">		whole landscape species abundances.</span>

<span class="sd">		:param fragment: the fragment to obtain the species abundance of. If None, returns landscape abundances.</span>
<span class="sd">		:param speciation_rate: speciation rate to obtain abundances for</span>
<span class="sd">		:param time: the time to obtain abundances for</span>

<span class="sd">		:return: list of species abundances [reference, species ID, speciation rate, number of individuals, generation]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not been set - cannot get species abundances&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">fragment</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">to_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM SPECIES_ABUNDANCES WHERE generation == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">to_ret</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">to_ret</span> <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">speciation_rate</span><span class="p">)]</span>
		<span class="k">elif</span> <span class="n">speciation_rate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Must specify a speciation rate to get a fragment species abundance&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">to_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM FRAGMENT_ABUNDANCES WHERE fragment == &#39;&quot;</span> <span class="o">+</span> <span class="n">fragment</span> <span class="o">+</span> <span class="s2">&quot;&#39; AND &quot;</span> <span class="o">+</span>
										 <span class="s2">&quot;generation == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">to_ret</span> <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">speciation_rate</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Tree.calculate_octaves_error"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_octaves_error">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_octaves_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the error in octaves classes between the simulated data and the comparison data.</span>
<span class="sd">		Stores each error value as a new entry in BIODIVERSITY_METRICS under fragment_octaves.</span>
<span class="sd">		Calculates the error by comparing each octave class and summing the relative difference.</span>
<span class="sd">		Octaves are then averaged for each fragment.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># TODO write test cases for this, it looks a mess</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">calculate_comparison_octaves</span><span class="p">()</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
				<span class="k">print</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Comparison octaves has not been generated. Check calculate_comparison_octaves&quot;</span>
								   <span class="s2">&quot; has been successful.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not yet been successfully imported. Can&#39;t perform calculations.&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT fragment, time, speciation_rate FROM FRAGMENT_OCTAVES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_fragment_octaves</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">calculate_fragment_octaves</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE FRAGMENT_OCTAVES ADD COLUMN comparison float&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE FRAGMENT_OCTAVES ADD COLUMN error float&quot;</span><span class="p">)</span>
			<span class="n">col_add</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">soe</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;Could not alter FRAGMENT_OCTAVES table: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">soe</span><span class="p">))</span>
		<span class="n">fragments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
		<span class="n">times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
		<span class="n">spec_rates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
		<span class="n">fragment_errors</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span>
		<span class="n">fragment_sql</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">frag_ref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec_rates</span><span class="p">:</span>
					<span class="n">octaves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_octaves</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
					<span class="n">comparison_octaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_octaves</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">maxval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">octaves</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">comparison_octaves</span><span class="p">]))</span>
					<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">maxval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">comparison_octaves</span><span class="p">])</span>
						<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
							<span class="k">try</span><span class="p">:</span>
								<span class="n">maxval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">octaves</span><span class="p">])</span>
							<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
								<span class="n">maxval</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="n">difference</span> <span class="o">=</span> <span class="p">[]</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">oct_val</span><span class="p">,</span> <span class="n">ref_val</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">octaves</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
						<span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
							<span class="n">difference</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
							<span class="k">continue</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">comp_val</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">comparison_octaves</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
						<span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
							<span class="n">difference</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="c1">## The error is calculated as</span>
							<span class="n">difference</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
								<span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">oct_val</span><span class="p">,</span> <span class="n">comp_val</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">oct_val</span><span class="p">,</span> <span class="n">comp_val</span><span class="p">))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">comp_val</span><span class="p">,</span> <span class="n">oct_val</span><span class="p">))</span>
						<span class="k">if</span> <span class="n">col_add</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
								<span class="s2">&quot;UPDATE FRAGMENT_OCTAVES SET comparison = {0}, error = {1} WHERE ref == {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
									<span class="nb">str</span><span class="p">(</span><span class="n">comp_val</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">difference</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_val</span><span class="p">)))</span>
					<span class="c1"># now average the errors</span>
					<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">fragment_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
						<span class="p">[</span><span class="n">ref</span><span class="p">,</span> <span class="s2">&quot;fragment_octaves&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">difference</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">difference</span><span class="p">)))])</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO BIODIVERSITY_METRICS VALUES(?,?,?,?,?,?, NULL, NULL)&quot;</span><span class="p">,</span> <span class="n">fragment_errors</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.calculate_goodness_of_fit"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.calculate_goodness_of_fit">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_goodness_of_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the goodness-of-fit measure based on the calculated biodiversity metrics, scaling each metric by the</span>
<span class="sd">		number of individuals involved in the metric.</span>

<span class="sd">		This requires that import_comparison_data() has already been successfully run.</span>

<span class="sd">		.. note::</span>

<span class="sd">			This doesn&#39;t calculate anything for values which have not yet been written to the SQL database -</span>
<span class="sd">			make sure that the relevant save functions have been run already.</span>

<span class="sd">		The resulting value will then be written to the BIODIVERSITY_METRICS table in the SQL database.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">## check that the comparison data has already been imported.</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Comparison data not yet imported.&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="n">bio_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
			<span class="s2">&quot;SELECT * FROM BIODIVERSITY_METRICS WHERE metric != &#39;goodness_of_fit&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">total_individuals</span> <span class="o">=</span> \
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(tip) FROM SPECIES_LIST WHERE tip==1 AND gen_added==0.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
		<span class="c1"># print(self.total_individuals)</span>
		<span class="c1"># exit(1)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE FRAGMENT_OCTAVES ADD COLUMN comparison float&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE FRAGMENT_OCTAVES ADD COLUMN error float&quot;</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
			<span class="k">pass</span>

		<span class="c1"># Remove the extra goodness of fit values</span>
		<span class="n">bio_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bio_metrics</span> <span class="k">if</span> <span class="s1">&#39;goodness_of_fit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
		<span class="c1"># this will contain: metric, fragment, time, spec, relative_goodness_of_fit, num_individuals, simulated, actual</span>
		<span class="n">goodness_of_fit</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="c1"># generate the connection for the plot data</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_file</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="n">plot_data</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT fragment, plotID, number_individuals FROM PLOT_DATA&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">bio_metrics</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;fragment_octaves&quot;</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">comparison</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_data</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">each</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not find comparable metric for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
					<span class="k">continue</span>
				<span class="n">scaled_fit</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">fragment</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
					<span class="s2">&quot;UPDATE BIODIVERSITY_METRICS SET simulated = {0}, actual = {1}, value={2} WHERE ref == {3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
						<span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">scaled_fit</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
			<span class="c1"># sim = &quot;NULL&quot;</span>
			<span class="c1"># actual = &quot;NULL&quot;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">comparison</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">plot_data</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">each</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">comparison</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">]</span>
					<span class="n">comparison</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
					<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fragment_octaves&quot;</span>
					<span class="n">fragment</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="c1"># sim = &quot;NULL&quot;</span>
				<span class="c1"># actual = &quot;NULL&quot;</span>
				<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
					<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Could not find reference metric for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
					<span class="k">continue</span>
				<span class="n">scaled_fit</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
			<span class="c1"># print(each)</span>
			<span class="c1"># print(comparison)</span>
			<span class="c1">## Each metric will later be scaled so that the value is proportional to the number of individuals involved</span>

			<span class="n">goodness_of_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
				<span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">each</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">scaled_fit</span><span class="p">,</span> <span class="n">comparison</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">comparison</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
		<span class="c1"># Sum the fit values</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bio_metrics</span><span class="p">]))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bio_metrics</span><span class="p">]))</span>
		<span class="n">sum_fits</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="c1"># Also get the fits for each category</span>
		<span class="n">categories</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">goodness_of_fit</span><span class="p">]))</span>
		<span class="c1"># print(categories)</span>
		<span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
					<span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">g</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">goodness_of_fit</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span> <span class="ow">and</span> <span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">sr</span> <span class="ow">and</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">])</span>
					<span class="n">sum_fits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">time</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">total</span><span class="p">])</span>
		<span class="c1"># Find the relative goodness of fits for each metric</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">each</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">goodness_of_fit</span><span class="p">):</span>
			<span class="c1"># print(each)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sum_fits</span> <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">each</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">each</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">goodness_of_fit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">each</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span>
		<span class="c1"># pdb.set_trace()</span>
		<span class="n">goodness_SQL</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">:</span>
				<span class="c1">## 1- value so that we get a value range with perfect fitting at 1.</span>
				<span class="c1"># value = 1 - sum([g[4] for g in goodness_of_fit if g[2] == time and g[3] == sr])</span>
				<span class="c1"># ref += 1</span>
				<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
					<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">goodness_of_fit</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span> <span class="ow">and</span>
							  <span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">sr</span> <span class="ow">and</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
					<span class="c1"># print(values)</span>
					<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>
					<span class="c1"># simulated = values[0][1]</span>
					<span class="c1"># actual = values[0][2]</span>
					<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;goodness_of_fit_&quot;</span> <span class="o">+</span> <span class="n">c</span>
					<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">goodness_SQL</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ref</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;whole&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">g</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">goodness_SQL</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span> <span class="ow">and</span> <span class="n">g</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">sr</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span>
				<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="n">goodness_SQL</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ref</span><span class="p">,</span> <span class="s2">&quot;goodness_of_fit&quot;</span><span class="p">,</span> <span class="s2">&quot;whole&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO BIODIVERSITY_METRICS values(?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="n">goodness_SQL</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.get_species_list"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_species_list">[docs]</a>	<span class="k">def</span> <span class="nf">get_species_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the entirety of the SPECIES_LIST table, returning a tuple with an entry for each row. This can be used to</span>
<span class="sd">		construct custom analyses of the coalescence tree.</span>

<span class="sd">		.. note:: The species list will be produced in an unprocessed format</span>

<span class="sd">		:return: a list of each coalescence and speciation event, with locations, performed in the simulation</span>

<span class="sd">		:rtype: tuple</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database has not been set: &quot;</span> <span class="o">+</span> <span class="n">ae</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM SPECIES_LIST&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.get_goodness_of_fit"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_goodness_of_fit">[docs]</a>	<span class="k">def</span> <span class="nf">get_goodness_of_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the goodness of fit from the file.</span>

<span class="sd">		:return: the full output from the SQL query</span>

<span class="sd">		:rtype: list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Biodiversity table does not contain any values.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
				<span class="s2">&quot;SELECT * FROM BIODIVERSITY_METRICS WHERE fragment==&#39;whole&#39; and metric==&#39;goodness_of_fit&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Biodiversity table does not contain goodness-of-fit values.&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Tree.get_goodness_of_fit_fragment_richness"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_goodness_of_fit_fragment_richness">[docs]</a>	<span class="k">def</span> <span class="nf">get_goodness_of_fit_fragment_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the goodness of fit for fragment richness from the file.</span>

<span class="sd">		:raises ValueError: if BIODIVERSITY_METRICS table does not exist.</span>

<span class="sd">		:return: the full output from the SQL query</span>

<span class="sd">		:rtype: list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Biodiversity table does not contain any values.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM BIODIVERSITY_METRICS WHERE fragment==&#39;whole&#39; and &quot;</span>
									  <span class="s2">&quot;metric==&#39;goodness_of_fit_fragment_richness&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Tree.get_goodness_of_fit_fragment_octaves"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_goodness_of_fit_fragment_octaves">[docs]</a>	<span class="k">def</span> <span class="nf">get_goodness_of_fit_fragment_octaves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the goodness of fit for fragment octaves from the file.</span>

<span class="sd">		:raises ValueError: if BIODIVERSITY_METRICS table does not exist.</span>

<span class="sd">		:return: the full output from the SQL query</span>

<span class="sd">		:rtype: list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_biodiversity_table_exists</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Biodiversity table does not contain any values.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
				<span class="s2">&quot;SELECT * FROM BIODIVERSITY_METRICS WHERE fragment==&#39;whole&#39; and metric==&quot;</span>
				<span class="s2">&quot;&#39;goodness_of_fit_fragment_octaves&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Tree.dispersal_parameters"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.dispersal_parameters">[docs]</a>	<span class="k">def</span> <span class="nf">dispersal_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Reads the dispersal parameters from the database and returns them.</span>

<span class="sd">		:return: a list of the dispersal parameters [sigma, tau, m_probability, cutoff]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_simulation_parameters</span><span class="p">()</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">ret</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;tau&quot;</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;m_probability&quot;</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;cutoff&quot;</span><span class="p">]]</span></div>

<div class="viewcode-block" id="Tree.get_job"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_job">[docs]</a>	<span class="k">def</span> <span class="nf">get_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the job number (the seed) and the job type (the task identifier).</span>

<span class="sd">		:return: list containing [seed, job_type (the task identifier)]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_simulation_parameters</span><span class="p">()</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">ret</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">],</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;job_type&quot;</span><span class="p">]]</span></div>

<div class="viewcode-block" id="Tree.get_simulation_parameters"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_simulation_parameters">[docs]</a>	<span class="k">def</span> <span class="nf">get_simulation_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Reads the simulation parameters from the database and returns them.</span>

<span class="sd">		:return: a dictionary mapping names to values for seed, job_type, output_dir, spec_rate, sigma, L_value, deme,</span>
<span class="sd">		sample_size, maxtime, dispersal_relative_cost, min_spec, forest_change_rate, time_since_pristine, time_config,</span>
<span class="sd">		coarse_map vars, fine map vars, sample_file, gridx, gridy, pristine coarse map, pristine fine map, sim_complete,</span>
<span class="sd">		dispersal_method, m_probability, cutoff, infinite_landscape, protracted, min_speciation_gen, max_speciation_gen,</span>
<span class="sd">		dispersal_map</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT seed, job_type, output_dir, spec_rate, sigma, tau, deme, sample_size, &quot;</span>
								<span class="s2">&quot;max_time, dispersal_relative_cost, min_num_species, forest_change_rate, time_since_pristine, &quot;</span>
								<span class="s2">&quot;time_config_file, coarse_map_file, coarse_map_x, coarse_map_y, coarse_map_x_offset, &quot;</span>
								<span class="s2">&quot;coarse_map_y_offset, coarse_map_scale, fine_map_file, fine_map_x, fine_map_y, &quot;</span>
								<span class="s2">&quot;fine_map_x_offset, fine_map_y_offset, sample_file, grid_x, grid_y, sample_x, sample_y, &quot;</span>
								<span class="s2">&quot;sample_x_offset, sample_y_offset, pristine_coarse_map, &quot;</span>
								<span class="s2">&quot; pristine_fine_map, sim_complete, dispersal_method, m_probability, cutoff,&quot;</span>
								<span class="s2">&quot; infinite_landscape,  protracted, min_speciation_gen, max_speciation_gen, dispersal_map&quot;</span>
								<span class="s2">&quot; FROM SIMULATION_PARAMETERS&quot;</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failure to get SIMULATION_PARAMETERS table from database. Check table exists.&quot;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">e</span>
		<span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
		<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()]</span>
		<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">each</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">each</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
					<span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
		<span class="c1"># Now convert it into a dictionary</span>
		<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span></div>

<div class="viewcode-block" id="Tree.get_community_references"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_community_references">[docs]</a>	<span class="k">def</span> <span class="nf">get_community_references</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets a list of all the commuity references already calculated for the simulation.</span>

<span class="sd">		:return: list of all calculated community references</span>

<span class="sd">		:rtype: list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT reference FROM COMMUNITY_PARAMETERS&quot;</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failure to fetch references from COMMUNITY_PARAMETERS table in database.&quot;</span>
							  <span class="s2">&quot; Check table exists.&quot;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">e</span>
		<span class="n">references</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
		<span class="k">return</span> <span class="n">references</span></div>



<div class="viewcode-block" id="Tree.get_community_parameters"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_community_parameters">[docs]</a>	<span class="k">def</span> <span class="nf">get_community_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns a dictionary containing the parameters for the calculated community.</span>

<span class="sd">		:param reference: the reference key for the calculated parameters. (default is 1)</span>
<span class="sd">		:return: dictionary containing the speciation_rate, time, fragments and metacommunity_reference</span>
<span class="sd">		:rtype: dict</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT speciation_rate, time, fragments, metacommunity_reference &quot;</span>
								<span class="s2">&quot;FROM COMMUNITY_PARAMETERS WHERE reference== ?&quot;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failure to fetch COMMUNITY_PARAMETERS table from database. Check table exists.&quot;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">e</span>
		<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()]</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No community parameters found for reference of {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span>
		<span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">each</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">each</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
					<span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
		<span class="c1"># Now convert it into a dictionary</span>
		<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span></div>


<div class="viewcode-block" id="Tree.get_metacommunity_references"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_metacommunity_references">[docs]</a>	<span class="k">def</span> <span class="nf">get_metacommunity_references</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets a list of all the metacommuity references already calculated for the simulation.</span>

<span class="sd">		.. note:: Returns an empty list and logs an error message if the METACOMMUNITY_PARAMETERS table does not exist.</span>

<span class="sd">		:return: list of all calculated metacommunity references</span>

<span class="sd">		:rtype: list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">check_sql_table_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;METACOMMUNITY_PARAMETERS&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No table METACOMMUNITY_PARAMETERS exists in database {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">[]</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT reference FROM METACOMMUNITY_PARAMETERS&quot;</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failure to fetch references from METACOMMUNITY_PARAMETERS table in database.&quot;</span>
							  <span class="s2">&quot; Check table exists.&quot;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">e</span>
		<span class="n">references</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
		<span class="k">return</span> <span class="n">references</span></div>

<div class="viewcode-block" id="Tree.get_metacommunity_parameters"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_metacommunity_parameters">[docs]</a>	<span class="k">def</span> <span class="nf">get_metacommunity_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns a dictionary containing the parameters for the calculated community.</span>

<span class="sd">		:param reference: the reference key for the calculated parameters. (default is 1)</span>
<span class="sd">		:return: dictionary containing the speciation_rate, time, fragments and metacommunity_reference</span>
<span class="sd">		:rtype: dict</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT speciation_rate, metacommunity_size, fragments FROM&quot;</span>
								<span class="s2">&quot; METACOMMUNITY_PARAMETER  WHERE reference== ?&quot;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failure to fetch METACOMMUNITY_PARAMETERS table from database. Check table exists.&quot;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">e</span>
		<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()]</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No metacommunity parameters found for reference of {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span>
		<span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">each</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">each</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
					<span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
		<span class="c1"># Now convert it into a dictionary</span>
		<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span></div>

<div class="viewcode-block" id="Tree.get_parameter_description"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.get_parameter_description">[docs]</a>	<span class="k">def</span> <span class="nf">get_parameter_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the description of the parameter matching the key from those contained in SIMULATION_PARAMETERS</span>

<span class="sd">		Simply accesses the _parameter_descriptions data stored in parameter_descriptions.json</span>

<span class="sd">		:return: string containing the parameter description or a dict containing all values if no key is supplied</span>

<span class="sd">		:rtype: str</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">get_parameter_description</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tree.is_completed"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.is_completed">[docs]</a>	<span class="k">def</span> <span class="nf">is_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Indicates whether the simulation has been performed to completion, or if the simulation has been paused and</span>
<span class="sd">		needs to be completed before analysis can be performed.</span>

<span class="sd">		:return: bool: true if simulation is complete</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span></div>

<div class="viewcode-block" id="Tree.is_protracted"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.is_protracted">[docs]</a>	<span class="k">def</span> <span class="nf">is_protracted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Indicates whether the simulation is a protracted simulation or not. This is read from the completed database file.</span>

<span class="sd">		:return: boolean, true if the simulation was performed with protracted speciation.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_simulation_parameters</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span></div>

<div class="viewcode-block" id="Tree.clear_calculations"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.clear_calculations">[docs]</a>	<span class="k">def</span> <span class="nf">clear_calculations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Removes the BIODIVERSITY_METRICS and FRAGMENT_OCTAVES tables completely.</span>
<span class="sd">		.. note:: that this cannot be undone (other than re-running the calculations).</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS BIODIVERSITY_METRICS&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS FRAGMENT_OCTAVES&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS FRAGMENT_RICHNESS&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS PLOT_DATA&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS SPECIES_RICHNESS&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tree.wipe_data"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.Tree.wipe_data">[docs]</a>	<span class="k">def</span> <span class="nf">wipe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Wipes all calculated data apart from the original, unformatted coalescence tree.</span>
<span class="sd">		The Speciation_Counter program will have to be re-run to perform any analyses.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS FRAGMENT_ABUNDANCES&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS SPECIES_ABUNDANCES&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS SPECIES_LOCATIONS&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS BIODIVERSITY_METRICS&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS FRAGMENT_OCTAVES&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS FRAGMENT_RICHNESS&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>




<div class="viewcode-block" id="collate_fits"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coal_analyse.collate_fits">[docs]</a><span class="k">def</span> <span class="nf">collate_fits</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Collated_fits.db&quot;</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Collates the goodness of fit values from every file in the specified directory and places them in one new file.</span>

<span class="sd">	.. note:: Files with &#39;collated&#39; in the name will be ignored.</span>

<span class="sd">	.. note:: If the output file exists, it will be deleted.</span>

<span class="sd">	Creates three separate tables in the output file, one for overall goodness of fit, one for fragment richness fits,</span>
<span class="sd">	and one for fragment octaves fits.</span>

<span class="sd">	:param file_dir: the file directory to examine</span>
<span class="sd">	:param filename: [optional] the output file name.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;Collated_fits.db&quot;</span><span class="p">:</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="n">database</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error opening SQLite database: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
	<span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE GOODNESS_FIT (ref INT PRIMARY KEY NOT NULL, task INT NOT NULL, seed INT NOT NULL, &quot;</span>
					 <span class="s2">&quot;sigma FLOAT NOT NULL, tau FLOAT NOT NULL, m_probability FLOAT NOT NULL, cutoff FLOAT NOT NULL,&quot;</span> \
					 <span class="s2">&quot;time FLOAT NOT NULL, speciation_rate FLOAT NOT NULL, value FLOAT NOT NULL)&quot;</span><span class="p">)</span>
	<span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
		<span class="s2">&quot;CREATE TABLE GOODNESS_FIT_FRAGMENT_RICHNESS (ref INT PRIMARY KEY NOT NULL, task INT NOT NULL, seed INT NOT NULL, &quot;</span>
		<span class="s2">&quot;sigma FLOAT NOT NULL, tau FLOAT NOT NULL, m_probability FLOAT NOT NULL, cutoff FLOAT NOT NULL,&quot;</span> \
		<span class="s2">&quot;time FLOAT NOT NULL, speciation_rate FLOAT NOT NULL, value FLOAT NOT NULL)&quot;</span><span class="p">)</span>
	<span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
		<span class="s2">&quot;CREATE TABLE GOODNESS_FIT_FRAGMENT_OCTAVES (ref INT PRIMARY KEY NOT NULL, task INT NOT NULL, seed INT NOT NULL, &quot;</span>
		<span class="s2">&quot;sigma FLOAT NOT NULL, tau FLOAT NOT NULL, m_probability FLOAT NOT NULL, cutoff FLOAT NOT NULL,&quot;</span> \
		<span class="s2">&quot;time FLOAT NOT NULL, speciation_rate FLOAT NOT NULL, value FLOAT NOT NULL)&quot;</span><span class="p">)</span>
	<span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">ref_richness</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">ref_octaves</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">out_richness</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">out_octaves</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
		<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span> <span class="o">==</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s2">&quot;Collated&quot;</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">elif</span> <span class="s2">&quot;.db&quot;</span> <span class="ow">in</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="nb">file</span><span class="p">)):</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">temp</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="nb">file</span><span class="p">))</span>
				<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
					<span class="n">temp</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Database {} is not complete or does not exist.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">file</span><span class="p">))</span>
					<span class="k">continue</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">gof</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">get_goodness_of_fit</span><span class="p">()</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;File: &quot;</span> <span class="o">+</span> <span class="nb">file</span><span class="p">)</span>
				<span class="n">gof_octaves</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">get_goodness_of_fit_fragment_octaves</span><span class="p">()</span>
				<span class="n">gof_richness</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">get_goodness_of_fit_fragment_richness</span><span class="p">()</span>
				<span class="n">disp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">dispersal_parameters</span><span class="p">()</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">get_job</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">gof</span><span class="p">:</span>
					<span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ref</span><span class="p">,</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
					<span class="n">ref</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">gof_richness</span><span class="p">:</span>
					<span class="n">out_richness</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ref_richness</span><span class="p">,</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
					<span class="n">ref_richness</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">gof_octaves</span><span class="p">:</span>
					<span class="n">out_octaves</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ref_octaves</span><span class="p">,</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">disp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
					<span class="n">ref_octaves</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="n">database</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO GOODNESS_FIT values(?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
		<span class="n">database</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO GOODNESS_FIT_FRAGMENT_RICHNESS values(?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span> <span class="n">out_richness</span><span class="p">)</span>
		<span class="n">database</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">&quot;INSERT INTO GOODNESS_FIT_FRAGMENT_OCTAVES values(?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span> <span class="n">out_octaves</span><span class="p">)</span>
		<span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Specified file directory &quot;</span> <span class="o">+</span> <span class="n">file_dir</span> <span class="o">+</span> <span class="s2">&quot; does not exist&quot;</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/PyCoal_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyCoalescence 1.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Samuel Thompson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.4.
    </div>
  </body>
</html>