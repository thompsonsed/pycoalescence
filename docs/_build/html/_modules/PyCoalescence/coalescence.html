
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PyCoalescence.coalescence &#8212; PyCoalescence 1.2.5 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.2.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
    <script type="text/javascript" src="../../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <link rel="shortcut icon" href="../../_static/PyCoal_favicon_large.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyCoalescence 1.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyCoalescence.coalescence</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the Coalescence and Map classes as part of the PyCoalescence Project.</span>

<span class="sd">Operations involve setting up and running simulations, plus basic tree generation after simulations have been completed.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">.system_operations</span> <span class="kn">import</span> <span class="n">execute_log_info</span><span class="p">,</span> <span class="n">mod_directory</span><span class="p">,</span> <span class="n">create_logger</span><span class="p">,</span> <span class="n">write_to_log</span>
<span class="kn">from</span> <span class="nn">.fragments</span> <span class="kn">import</span> <span class="n">FragmentedLandscape</span>

<span class="k">global</span> <span class="n">sqlite_import</span><span class="p">,</span> <span class="n">config_success</span>
<span class="k">try</span><span class="p">:</span>
	<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
		<span class="kn">import</span> <span class="nn">configparser</span> <span class="kn">as</span> <span class="nn">ConfigParser</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="kn">import</span> <span class="nn">ConfigParser</span>

		<span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="o">.</span><span class="n">read_file</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="o">.</span><span class="n">read</span>


		<span class="k">class</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
			<span class="k">pass</span>


		<span class="k">class</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
			<span class="k">pass</span>

	<span class="n">config_success</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="n">ConfigParser</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not import ConfigParser. Config options disabled.&quot;</span><span class="p">)</span>
	<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>
	<span class="n">config_success</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">try</span><span class="p">:</span>
	<span class="n">NumberTypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">LongType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FloatType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ComplexType</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
	<span class="c1"># No support for complex numbers compile</span>
	<span class="n">NumberTypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="n">gdal</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Problem importing  (gdal) modules. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>

<span class="k">try</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="kn">import</span> <span class="nn">sqlite3</span>
	<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
		<span class="c1"># Python 3 compatibility</span>
		<span class="kn">import</span> <span class="nn">sqlite</span> <span class="kn">as</span> <span class="nn">sqlite3</span>
	<span class="n">sqlite_import</span> <span class="o">=</span> <span class="bp">True</span>
	<span class="kn">from</span> <span class="nn">.coal_analyse</span> <span class="kn">import</span> <span class="n">Tree</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="n">sqlite_import</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="n">Tree</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">sqlite3</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Problem importing sqlite module &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>

<span class="n">necsim_import_success</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">import_warnings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
	<span class="c1"># Python 2</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="kn">from</span> <span class="nn">build</span> <span class="kn">import</span> <span class="n">necsimmodule</span><span class="p">,</span> <span class="n">Dispersal</span>
	<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ime</span><span class="p">:</span>
		<span class="n">import_warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ime</span><span class="p">)</span>
		<span class="kn">from</span> <span class="nn">.build</span> <span class="kn">import</span> <span class="n">necsimmodule</span><span class="p">,</span> <span class="n">Dispersal</span>
	<span class="n">NECSimError</span> <span class="o">=</span> <span class="n">necsimmodule</span><span class="o">.</span><span class="n">NECSimError</span>
	<span class="n">DispersalError</span> <span class="o">=</span> <span class="n">Dispersal</span><span class="o">.</span><span class="n">DispersalError</span>
	<span class="n">necsim_import_success</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not import necsim shared objects. Check compilation has been successfully completed under &quot;</span>
					<span class="s2">&quot;same python version.&quot;</span><span class="p">)</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">import_warnings</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
	<span class="n">necsim_import_success</span> <span class="o">=</span> <span class="bp">False</span>


	<span class="c1"># Create the empty classes if the import fails</span>
	<span class="k">class</span> <span class="nc">NECSimError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
		<span class="k">pass</span>


	<span class="k">class</span> <span class="nc">DispersalError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
		<span class="k">pass</span>


<div class="viewcode-block" id="check_file_exists"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.check_file_exists">[docs]</a><span class="k">def</span> <span class="nf">check_file_exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Checks that the specified filename exists, if it is not &quot;null&quot; or &quot;none&quot;.</span>

<span class="sd">	:param file_name: file path to check for</span>

<span class="sd">	:return: None</span>

<span class="sd">	:raises: IOError if no file exists</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">}:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Map file &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; does not exist. Check that this is an absolute path or disable map &quot;</span> \
										<span class="s2">&quot;file check&quot;</span>
		<span class="ne">IOError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>


<div class="viewcode-block" id="Map"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map">[docs]</a><span class="k">class</span> <span class="nc">Map</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;A class for the map object, containing the file name and the variables associated with this map object.&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_sample</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logging_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">dispersal_db</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Constructor for the Map class, optionally setting the sample map, the logging level and the dispersal database</span>
<span class="sd">		location (if a dispersal simulation has already been run).</span>

<span class="sd">		:param file: sets the filename for reading tif files.</span>
<span class="sd">		:param is_sample: sets the sample mask to true, if it is a sampled file</span>
<span class="sd">		:param logging_level: the level of logging to output during dispersal simulations</span>
<span class="sd">		:param dispersal_db: path to a complete dispersal simulation database. Can also be a Map object containing the</span>
<span class="sd">		completed simulation</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_cached_array</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="nb">file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">x_size</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y_size</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">x_res</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y_res</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dimensions_set</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_sample</span> <span class="o">=</span> <span class="n">is_sample</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging_level</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;maplogger&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_create_logger</span><span class="p">()</span>
		<span class="c1"># The dispersal simulation data</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dispersal_db</span><span class="p">,</span> <span class="n">Map</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span> <span class="o">=</span> <span class="n">dispersal_db</span><span class="o">.</span><span class="n">dispersal_database</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span> <span class="o">=</span> <span class="n">dispersal_db</span>

	<span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Overriding the destructor for proper destruction of the logger object</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
				<span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Overriding the default deep copy operator to ignore copying the logger object</span>
<span class="sd">		:param memo: the memorised key values</span>
<span class="sd">		:return: the copy of the Map object</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
		<span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
		<span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;logger&quot;</span><span class="p">:</span>
				<span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="Map.set_dimensions"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.set_dimensions">[docs]</a>	<span class="k">def</span> <span class="nf">set_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">x_offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y_offset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Sets the dimensions and file for the Map object</span>

<span class="sd">		:param str file_name: the location of the map object (a csv or tif file). If None, required that file_name is already provided.</span>
<span class="sd">		:param int x_size: the x dimension</span>
<span class="sd">		:param int y_size: the y dimension</span>
<span class="sd">		:param int x_offset: the x offset from the north-west corner</span>
<span class="sd">		:param int y_offset: the y offset from the north-west corner</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No file name provided when trying to set dimensions.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">y_size</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">x_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x_size</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">y_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
				<span class="s2">&quot;Attempt to specify size, but x_size or y_size not provided. Trying to read dimensions from file.&quot;</span><span class="p">,</span>
				<span class="ne">RuntimeWarning</span><span class="p">)</span>
			<span class="n">x_size</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="n">y_size</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">if</span> <span class="n">x_size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimensions</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dimensions_set</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">x_size</span> <span class="o">=</span> <span class="n">x_size</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">y_size</span> <span class="o">=</span> <span class="n">y_size</span>
			<span class="c1"># Make sure the x_offsets are set if not none, otherwise default to 0</span>
			<span class="k">if</span> <span class="n">x_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">x_offset</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">if</span> <span class="n">y_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">y_offset</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dimensions_set</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Map.set_sample"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.set_sample">[docs]</a>	<span class="k">def</span> <span class="nf">set_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_sample</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Set the is_sample attribute to true if this is a sample mask rather than an offset map</span>

<span class="sd">		:param bool is_sample: indicates this is a sample mask rather than offset map</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">is_sample</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_sample</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Map.check_map"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.check_map">[docs]</a>	<span class="k">def</span> <span class="nf">check_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Checks that the dimensions for the map have been set and that the map file exists&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="n">NumberTypes</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span> <span class="n">NumberTypes</span><span class="p">)</span> <span class="ow">and</span>
					<span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">NumberTypes</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span> <span class="n">NumberTypes</span><span class="p">)</span> <span class="ow">and</span>
					<span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_res</span><span class="p">,</span> <span class="n">NumberTypes</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_res</span><span class="p">,</span> <span class="n">NumberTypes</span><span class="p">)):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
				<span class="s2">&quot;values not set as numbers in &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_size</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span> <span class="o">+</span>
				<span class="s2">&quot; | &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">)</span> <span class="o">+</span>
				<span class="s2">&quot; | &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_res</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_res</span><span class="p">))</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions_set</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Dimensions for map file &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; not set.&quot;</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">check_file_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Map.read_dimensions"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.read_dimensions">[docs]</a>	<span class="k">def</span> <span class="nf">read_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a list containing the geospatial coordinate system for the file.</span>

<span class="sd">		:return: a list containing [0] x, [1] y, [2] upper left x, [3] upper left y, [4] x resolution, [5] y resolution</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">gdal</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Gdal module not imported correctly: cannot read tif files&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="s2">&quot;.tif&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;tif file not detected - dimensions cannot be read: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
				<span class="s2">&quot;File &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; does not exist or is not accessible. Check read/write access.&quot;</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span>
		<span class="n">ulx</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">xskew</span><span class="p">,</span> <span class="n">uly</span><span class="p">,</span> <span class="n">yskew</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ulx</span><span class="p">,</span> <span class="n">uly</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">]</span></div>

<div class="viewcode-block" id="Map.get_dimensions"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.get_dimensions">[docs]</a>	<span class="k">def</span> <span class="nf">get_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calls read_dimensions() if dimensions have not been read, or reads stored information.</span>

<span class="sd">		:return: a list containing [0] x, [1] y, [2] upper left x, [3] upper left y, [4] x resolution, [5] y resolution</span>
<span class="sd">		.. note:: the returned list will contain the x and y offset values instead of the ulx and uly values if the</span>
<span class="sd">				  dimensions have already been set (i.e. self.x_size != 0 and self.y_size != 0)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimensions</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_res</span><span class="p">]</span></div>

<div class="viewcode-block" id="Map.get_cached_subset"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.get_cached_subset">[docs]</a>	<span class="k">def</span> <span class="nf">get_cached_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets a subset of the map file, BUT rounds all numbers to integers to save RAM and keeps the entire array in</span>
<span class="sd">		memory to speed up fetches.</span>

<span class="sd">		:param x_offset: the x offset from the top left corner of the map</span>
<span class="sd">		:param y_offset: the y offset from the top left corner of the map</span>
<span class="sd">		:param x_size: the x size of the subset to obtain</span>
<span class="sd">		:param y_size: the y size of the subset to obtain</span>
<span class="sd">		:return: a numpy array containing the subsetted data</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">gdal</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Gdal module not imported correctly: cannot read tif files&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="s2">&quot;.tif&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;tif file not detected - dimensions cannot be read: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
				<span class="s2">&quot;File &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; does not exist or is not accessible. Check read/write access.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_array</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_cached_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(),</span>
										  <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_array</span><span class="p">[</span><span class="n">y_offset</span><span class="p">:(</span><span class="n">y_offset</span> <span class="o">+</span> <span class="n">y_size</span><span class="p">),</span> <span class="n">x_offset</span><span class="p">:(</span><span class="n">x_offset</span> <span class="o">+</span> <span class="n">x_size</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Map.get_subset"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.get_subset">[docs]</a>	<span class="k">def</span> <span class="nf">get_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets a subset of the map file</span>

<span class="sd">		:param x_offset: the x offset from the top left corner of the map</span>
<span class="sd">		:param y_offset: the y offset from the top left corner of the map</span>
<span class="sd">		:param x_size: the x size of the subset to obtain</span>
<span class="sd">		:param y_size: the y size of the subset to obtain</span>
<span class="sd">		:return: a numpy array containing the subsetted data</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">gdal</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Gdal module not imported correctly: cannot read tif files&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="s2">&quot;.tif&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;tif file not detected - dimensions cannot be read: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
				<span class="s2">&quot;File &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; does not exist or is not accessible. Check read/write access.&quot;</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
		<span class="n">to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">))</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">return</span> <span class="n">to_return</span></div>

<div class="viewcode-block" id="Map.calculate_scale"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.calculate_scale">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_scaled</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the scale of map object from the supplied file_scaled.</span>

<span class="sd">		:param str/Map file_scaled: the path to the file to calculate the scale.</span>

<span class="sd">		:return: the scale (of the x dimension)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_scaled</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">scaled</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
			<span class="n">scaled</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="n">file_scaled</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_scaled</span><span class="p">,</span> <span class="n">Map</span><span class="p">):</span>
			<span class="n">scaled</span> <span class="o">=</span> <span class="n">file_scaled</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;supplied argument is not a string or Map type: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_scaled</span><span class="p">))</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_dimensions</span><span class="p">())</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">read_dimensions</span><span class="p">())</span>
		<span class="c1"># Check that each of the dimensions matches</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">/</span> <span class="n">src</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
		<span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Inequal scaling of x and y dimensions. Check map files.&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Map.calculate_offset"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.calculate_offset">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the offset of the map object from the supplied file_offset.</span>

<span class="sd">		:param str/Map file_offset: the path to the file to calculate the offset.</span>
<span class="sd">			Can also be a Map object with the filename contained.</span>

<span class="sd">		:return: the offset x and y (at the resolution of the file_home) in integers</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_offset</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
			<span class="n">offset</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="n">file_offset</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_offset</span><span class="p">,</span> <span class="n">Map</span><span class="p">):</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">file_offset</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;file_offset type must be Map or str. Type provided: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">file_offset</span><span class="p">)))</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_dimensions</span><span class="p">())</span>
		<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">())</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">read_dimensions</span><span class="p">())</span>
		<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
			<span class="n">off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">())</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">off</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="n">src</span><span class="p">[</span><span class="mi">4</span><span class="p">:]]</span>
		<span class="k">return</span> <span class="n">diff</span></div>

<div class="viewcode-block" id="Map.get_x_y"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.get_x_y">[docs]</a>	<span class="k">def</span> <span class="nf">get_x_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Simply returns the x and y dimension of the file.</span>

<span class="sd">		:return: the x and y dimensions</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions_set</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_size</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimensions</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span></div>

	<span class="k">def</span> <span class="nf">_create_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logging_level</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates the logger for use with dispersal tests. Note you can supply your own logger by over-riding</span>
<span class="sd">		self.logger. This function should only be run during self.__init__()</span>

<span class="sd">		:param file: file to write output to. If None, outputs to terminal</span>
<span class="sd">		:param logging_level: the logging level to use (defaults to INFO)</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">logging_level</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">logging_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">logging_level</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_open_database_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Opens the connection to the database, raising the appropriate errors if the database does not exist</span>
<span class="sd">		Should have a matching call to _close_database_connection() for safely destroying the connection to the database</span>
<span class="sd">		file.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_close_database_connection</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span> <span class="o">=</span> <span class="n">database</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dispersal database is not set, run test_average_dispersal() first or set dispersal_db.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Dispersal database does not exist: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span><span class="p">)</span>
		<span class="c1"># Open the SQLite connection</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error opening SQLite database: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">_close_database_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Safely closes the database connection</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span> <span class="o">=</span> <span class="bp">None</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not close database: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">_check_table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;DISPERSAL_DISTANCES&quot;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks that the dispersal distances table exits, and returns true/false.</span>

<span class="sd">		:param database: the database to open</span>
<span class="sd">		:return: true if the DISPERSAL_DISTANCES table exists in the output database</span>
<span class="sd">		:rtype bool</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_open_database_connection</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
		<span class="n">existence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39; AND&quot;</span>
												   <span class="s2">&quot; name=&#39;{}&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_close_database_connection</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">existence</span>

	<span class="k">def</span> <span class="nf">_setup_dispersal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks that the map file makes sense, and the map file exists.</span>

<span class="sd">		:param map_file:</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">map_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No map file set and none supplied to function.&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">map_file</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">map_file</span>
		<span class="c1"># Now calculate dimensions if the map file is not null</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
		<span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions_set</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Null map dimensions must be set manually before attemting to simulate dispersal.&quot;</span><span class="p">)</span>
		<span class="c1"># Check the map file exists and dimensions are correct</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_map</span><span class="p">()</span>

<div class="viewcode-block" id="Map.test_mean_distance_travelled"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.test_mean_distance_travelled">[docs]</a>	<span class="k">def</span> <span class="nf">test_mean_distance_travelled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_repeats</span><span class="p">,</span> <span class="n">number_steps</span><span class="p">,</span> <span class="n">output_database</span><span class="o">=</span><span class="s2">&quot;output.db&quot;</span><span class="p">,</span> <span class="n">map_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
									 <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dispersal_method</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">landscape_type</span><span class="o">=</span><span class="s2">&quot;tiled&quot;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
									 <span class="n">m_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Tests the dispersal kernel on the provided map, producing a database containing the average distance travelled</span>
<span class="sd">		after number_steps have been moved.</span>

<span class="sd">		:param int number_repeats: the number of times to iterate on the map</span>
<span class="sd">		:param int number_steps: the number of steps to take each time before recording the distance travelled</span>
<span class="sd">		:param str output_database: the path to the output database</span>
<span class="sd">		:param str map_file: the path to the map file to iterate on</span>
<span class="sd">		:param int seed: the random seed</span>
<span class="sd">		:param str dispersal_method: the dispersal method to use (&quot;normal&quot;, &quot;fat-tailed&quot; or &quot;norm-uniform&quot;)</span>
<span class="sd">		:param str landscape_type: the landscape type to use (&quot;infinite&quot;, &quot;tiled&quot; or &quot;closed&quot;)</span>
<span class="sd">		:param float sigma: the sigma value to use for normal and norm-uniform dispersal</span>
<span class="sd">		:param float tau: the tau value to use for fat-tailed dispersal</span>
<span class="sd">		:param float m_prob: the m_prob to use for norm-uniform dispersal</span>
<span class="sd">		:param float cutoff: the cutoff value to use for norm-uniform dispersal</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_setup_dispersal</span><span class="p">(</span><span class="n">map_file</span><span class="o">=</span><span class="n">map_file</span><span class="p">)</span>
		<span class="c1"># Delete the file if it exists, and recursively create the folder if it doesn&#39;t</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_database</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_table_exists</span><span class="p">(</span><span class="n">output_database</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;DISTANCES_TRAVELLED&quot;</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Database {} already has a table called DISTANCES_TRAVELLED&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_database</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_database</span><span class="p">))</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_database</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_database</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">necsim_import_success</span><span class="p">:</span>
			<span class="n">Dispersal</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
			<span class="n">Dispersal</span><span class="o">.</span><span class="n">set_log_function</span><span class="p">(</span><span class="n">write_to_log</span><span class="p">)</span>
			<span class="n">Dispersal</span><span class="o">.</span><span class="n">test_mean_distance_travelled</span><span class="p">(</span><span class="n">output_database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="n">dispersal_method</span><span class="p">,</span> <span class="n">landscape_type</span><span class="p">,</span>
												   <span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">m_prob</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">number_repeats</span><span class="p">,</span> <span class="n">number_steps</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span>
												   <span class="bp">self</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span> <span class="o">=</span> <span class="n">output_database</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Successful c++ module import required for testing dispersal functions.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Map.test_mean_dispersal"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.test_mean_dispersal">[docs]</a>	<span class="k">def</span> <span class="nf">test_mean_dispersal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_repeats</span><span class="p">,</span> <span class="n">output_database</span><span class="o">=</span><span class="s2">&quot;output.db&quot;</span><span class="p">,</span> <span class="n">map_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
							<span class="n">dispersal_method</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">landscape_type</span><span class="o">=</span><span class="s2">&quot;tiled&quot;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">m_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
							<span class="n">sequential</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Tests the dispersal kernel on the provided map, producing a database containing each dispersal distance for</span>
<span class="sd">		analysis purposes.</span>

<span class="sd">		:note Will raise an IOError if the output database already has a table called DISPERSAL_DISTANCES</span>

<span class="sd">		:param int number_repeats: the number of times to iterate on the map</span>
<span class="sd">		:param str output_database: the path to the output database</span>
<span class="sd">		:param str map_file: the path to the map file to iterate on</span>
<span class="sd">		:param int seed: the random seed</span>
<span class="sd">		:param str dispersal_method: the dispersal method to use (&quot;normal&quot;, &quot;fat-tailed&quot; or &quot;norm-uniform&quot;)</span>
<span class="sd">		:param str landscape_type: the landscape type to use (&quot;infinite&quot;, &quot;tiled&quot; or &quot;closed&quot;)</span>
<span class="sd">		:param float sigma: the sigma value to use for normal and norm-uniform dispersal</span>
<span class="sd">		:param float tau: the tau value to use for fat-tailed dispersal</span>
<span class="sd">		:param float m_prob: the m_prob to use for norm-uniform dispersal</span>
<span class="sd">		:param float cutoff: the cutoff value to use for norm-uniform dispersal</span>
<span class="sd">		:param bool sequential: if true, end locations of one dispersal event are used as the start for the next. Otherwise,</span>
<span class="sd">		a new random cell is chosen</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_setup_dispersal</span><span class="p">(</span><span class="n">map_file</span><span class="o">=</span><span class="n">map_file</span><span class="p">)</span>
		<span class="c1"># Delete the file if it exists, and recursively create the folder if it doesn&#39;t</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_database</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_table_exists</span><span class="p">(</span><span class="n">output_database</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;DISPERSAL_DISTANCES&quot;</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Database {} already has a table called DISPERSAL_DISTANCES&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_database</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_database</span><span class="p">))</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_database</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_database</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">necsim_import_success</span><span class="p">:</span>
			<span class="n">Dispersal</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
			<span class="n">Dispersal</span><span class="o">.</span><span class="n">set_log_function</span><span class="p">(</span><span class="n">write_to_log</span><span class="p">)</span>
			<span class="n">Dispersal</span><span class="o">.</span><span class="n">test_mean_dispersal</span><span class="p">(</span><span class="n">output_database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="n">dispersal_method</span><span class="p">,</span> <span class="n">landscape_type</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
										  <span class="n">m_prob</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">number_repeats</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span>
										  <span class="nb">int</span><span class="p">(</span><span class="n">sequential</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span> <span class="o">=</span> <span class="n">output_database</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Successful c++ module import required for testing dispersal functions.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Map.get_mean_dispersal"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.get_mean_dispersal">[docs]</a>	<span class="k">def</span> <span class="nf">get_mean_dispersal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the average dispersal for the map if test_mean_dispersal has already been run.</span>

<span class="sd">		:raises: ValueError if dispersal_database is None and so test_average_dispersal() has not been run</span>
<span class="sd">		:raises: IOError if the output database does not exist</span>

<span class="sd">		:param str database: the database to open</span>
<span class="sd">		:return: the average dispersal from the database</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_table_exists</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;DISPERSAL_DISTANCES&quot;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Database {} does not have a DISPERSAL_DISTANCES table&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span><span class="p">))</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_open_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">)</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="n">sql_fetch</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT AVG(distance) FROM DISPERSAL_DISTANCES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not get average distance from database: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_close_database_connection</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">sql_fetch</span></div>

<div class="viewcode-block" id="Map.get_mean_distance_travelled"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.get_mean_distance_travelled">[docs]</a>	<span class="k">def</span> <span class="nf">get_mean_distance_travelled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the mean distance travelled for the map if test_mean_distance_travelled has already been run.</span>

<span class="sd">		:raises: ValueError if dispersal_database is None and so test_average_dispersal() has not been run</span>
<span class="sd">		:raises: IOError if the output database does not exist</span>

<span class="sd">		:param str database: the database to open</span>
<span class="sd">		:return: the average dispersal from the database</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_table_exists</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;DISTANCES_TRAVELLED&quot;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Database {} does not have a DISTANCES_TRAVELLED table&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersal_database</span><span class="p">))</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_open_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">)</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="n">sql_fetch</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT AVG(distance) FROM DISTANCES_TRAVELLED&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not get average distance travelled from database: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_close_database_connection</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">sql_fetch</span></div>

<div class="viewcode-block" id="Map.get_database_parameters"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Map.get_database_parameters">[docs]</a>	<span class="k">def</span> <span class="nf">get_database_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the dispersal simulation parameters from the dispersal_db</span>
<span class="sd">		:return: the dispersal simulation parameters</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_open_database_connection</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, sigma, tau, m_prob, cutoff, dispersal_method, map_file, seed, number_steps,&quot;</span>
						   <span class="s2">&quot; number_repeats FROM PARAMETERS&quot;</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not get dispersal simulation parameters from database: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
		<span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
		<span class="n">main_dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
			<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">each</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
					<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">each</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
						<span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
			<span class="n">main_dict</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">column_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
		<span class="c1"># Now convert it into a dictionary</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_close_database_connection</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">main_dict</span></div></div>


<div class="viewcode-block" id="Coalescence"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence">[docs]</a><span class="k">class</span> <span class="nc">Coalescence</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A class containing routines to set up and run simulations, including detecting map dimensions from tif files.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logging_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
				 <span class="n">log_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Initialise with optional locations of the Coal executable.</span>

<span class="sd">		:param int logging_level: the minimal level of logging to display</span>
<span class="sd">		:param string log_output: a file to output log data to. Use None for writing to console.</span>
<span class="sd">		:param kwargs: additional keyword arguments to supply to logging.basicConfig()</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># All the parameters used for the simulation</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging_level</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;necsimlogger&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_create_logger</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">log_output</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pause_directory</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">map_config</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">coarse_scale</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="mi">100</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># the relative cost of moving through non-matrix</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="c1"># amount of forest change that occurs before pristine state (there will be a jump to pristine at the pristine time</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">forest_change_rate</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">time_since_pristine</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># The number of generations ago a forest was pristine</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="c1"># Deprecated, but here for compability reasons</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="c1"># the optional parameters specifying the location (i.e. where in the world the simulation is of</span>
		<span class="c1"># and the compute node (such as NUS_HPC or LOCAL_MACBOOK)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sim_location</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sim_compute_node</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="c1"># parameters for the application of speciation rates</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_speciation</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">record_spatial</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">record_fragments</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_time_config_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_sample_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_full</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">times_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># this is the times for the maps to change (in generations)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rates_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_time_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># this is the list of temporal sampling points (in generations)</span>
		<span class="c1"># The output database location</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_database</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">m_prob</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="c1"># The protracted variables</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">protracted</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="c1"># This variable stores whether a new config file has been opened or not</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config_open</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="c1"># Stores our necsim object for running the c++ code</span>
		<span class="k">if</span> <span class="n">necsim_import_success</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span> <span class="o">=</span> <span class="n">necsimmodule</span>
		<span class="c1"># Grid dimensions sizing</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="c1"># Dispersal map data</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Overriding the destructor for proper destruction of the logger object</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
			<span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="Coalescence.setup_necsim"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.setup_necsim">[docs]</a>	<span class="k">def</span> <span class="nf">setup_necsim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the logging function and the logger object for the necsim object. Enforcing this function is always called</span>
<span class="sd">		ensures no seg faults occur.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">set_log_function</span><span class="p">(</span><span class="n">write_to_log</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.add_pristine_map"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.add_pristine_map">[docs]</a>	<span class="k">def</span> <span class="nf">add_pristine_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fine_map</span><span class="p">,</span> <span class="n">coarse_map</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Adds an extra map to the list of pristine maps.</span>

<span class="sd">		:param fine_map: the pristine fine map file to add</span>
<span class="sd">		:param coarse_map: the pristine coarse map file to add</span>
<span class="sd">		:param time: the time to add (when the map is accurate)</span>
<span class="sd">		:param rate: the rate to add (the rate of forest change at this time)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fine_map</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coarse_map</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rates_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.add_sample_time"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.add_sample_time">[docs]</a>	<span class="k">def</span> <span class="nf">add_sample_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Adds an extra sample time to the list of times.</span>

<span class="sd">		This allows for multiple temporal sample points from within the same simulation.</span>

<span class="sd">		:param time: the sample time to add</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">add_sample_time</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">time</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_time_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_time_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_time_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.create_temporal_sampling_config"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.create_temporal_sampling_config">[docs]</a>	<span class="k">def</span> <span class="nf">create_temporal_sampling_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates the time-sampling config file</span>

<span class="sd">		:param config_file: the config file to output to</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
									   <span class="s2">&quot;timeconf_{}_{}.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)))</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config_file</span><span class="p">)):</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
				<span class="s1">&#39;Path {} does not exist for writing output to, creating.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config_file</span><span class="p">)))</span>
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_time_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
			<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_time_list</span><span class="p">))):</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="n">config_file</span></div>

<div class="viewcode-block" id="Coalescence.create_map_config"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.create_map_config">[docs]</a>	<span class="k">def</span> <span class="nf">create_map_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Generates the map config file from reading the spatial structure of each of the provided files.</span>

<span class="sd">		:param str output_file: the file to output configuration data to (the map config file)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
									   <span class="s2">&quot;mainconf_{}_{}.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)))</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">config_success</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;ConfigParser import was unsuccessful: cannot create config file.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file</span><span class="p">)):</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
				<span class="s1">&#39;Path {} does not exist for writing output to, creating.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file</span><span class="p">)))</span>
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_open</span><span class="p">:</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
					<span class="n">config</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config_open</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
			<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">get_x_y</span><span class="p">())</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">get_x_y</span><span class="p">())</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fine_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
				<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">get_x_y</span><span class="p">())</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_scale</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;coarse_map&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">):</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">tmp_fine</span> <span class="o">=</span> <span class="s2">&quot;pristine_fine&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
						<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">)</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_fine</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
						<span class="n">tmp_coarse</span> <span class="o">=</span> <span class="s2">&quot;pristine_coarse&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
						<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">)</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
						<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tmp_coarse</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
					<span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
						<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Discrepancy between pristine file list, time list or rate list. Check inputs: &#39;</span> <span class="o">+</span>
									  <span class="n">ie</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
						<span class="k">break</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;grid_map&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;grid_map&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;grid_map&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;x_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sample_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;y_off&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;reproduction&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;reproduction&quot;</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;m_probability&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_prob</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;cutoff&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">):</span>
					<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;restrict_self&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span><span class="p">)))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span> <span class="o">!=</span> <span class="s2">&quot;closed&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">):</span>
					<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;infinite_landscape&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">]:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">):</span>
					<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dispersal&quot;</span><span class="p">,</span> <span class="s2">&quot;dispersal_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">map_config</span> <span class="o">=</span> <span class="n">output_file</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot generate map config file without setting up map variables&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.setup"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.setup">[docs]</a>	<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coalescence_simulator</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mod_directory</span><span class="p">,</span> <span class="s2">&quot;build/default/./NECSim&quot;</span><span class="p">)):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Set the location of the coalescence and speciation executables. Make sure that both programs have been compiled</span>
<span class="sd">		for the operating system running the simulations.</span>

<span class="sd">		:param str coalescence_simulator: the path to the Coal_v1 executable</span>

<span class="sd">		.. deprecated:: 1.2.4</span>
<span class="sd">			No longer required as of 1.2.4 as all components have been migrated to use Python API</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">coalescence_simulator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coalescence_simulator</span> <span class="o">=</span> <span class="n">coalescence_simulator</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">coalescence_simulator</span><span class="p">):</span>
				<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;File not found: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">coalescence_simulator</span><span class="p">)</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Coalescence.run_simple"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.run_simple">[docs]</a>	<span class="k">def</span> <span class="nf">run_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Runs a simple coalescence simulation on a square infinite landscape with the provided parameters.</span>
<span class="sd">		This requires a separate compilation of the inf_land version of the coalescence simulator.</span>

<span class="sd">		Note that this function returns richness=0 for failure to read from the file. It is assumed that there will</span>
<span class="sd">		be at least one species in the simulation.</span>

<span class="sd">		Note that the maximum time for this function is set as 10 hours (36000 seconds) and will raise an exception if</span>
<span class="sd">		the simulation does not complete in this time).</span>

<span class="sd">		:raises RuntimeError: if the simulation didn&#39;t complete in time.</span>

<span class="sd">		:param seed: the simulation seed</span>
<span class="sd">		:param task: the task (for file naming)</span>
<span class="sd">		:param output: the output directory</span>
<span class="sd">		:param alpha: the speciation rate</span>
<span class="sd">		:param sigma: the normal distribution sigma value for dispersal</span>
<span class="sd">		:param size: the size of the world (so there will be size^2 individuals simulated)</span>

<span class="sd">		:return: the species richness in the simulation</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_simulation_params</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">output_directory</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">min_speciation_rate</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
								   <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deme</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_time</span><span class="o">=</span><span class="mi">36000</span><span class="p">,</span>
								   <span class="n">dispersal_relative_cost</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
								   <span class="n">min_num_species</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">forest_change_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pristine_forest_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
								   <span class="n">time_config_file</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_map_parameters</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span>
								<span class="s2">&quot;null&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_speciation_rates</span><span class="p">([</span><span class="n">alpha</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">finalise_setup</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">run_coalescence</span><span class="p">()</span>
		<span class="c1"># Now read the species richness from the database</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">richness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_richness</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">richness</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Richness is 0, error in program. This should never be the case for a complete &quot;</span>
									 <span class="s2">&quot;sim.&quot;</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">richness</span>
		<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation didn&#39;t complete in 10 hours (maximum time for run_simple). Try running a &quot;</span>
							   <span class="s2">&quot;custom simulation instead.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.get_richness"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.get_richness">[docs]</a>	<span class="k">def</span> <span class="nf">get_richness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calls coal_analyse.get_richness() with the supplied variables.</span>

<span class="sd">		Requires successful import of coal_analyse and sqlite3.</span>

<span class="sd">		:param speciation_rate: the speciation rate to extract system richness from.</span>
<span class="sd">		:param time: the time to extract system richness from</span>

<span class="sd">		:return: the species richness.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">sqlite_import</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;sqlite3 module required for obtaining richness from database files.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">db</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
							  <span class="s2">&quot;SQL_data/data_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.db&quot;</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
			<span class="n">t</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">get_richness</span><span class="p">(</span><span class="n">speciation_rate</span><span class="o">=</span><span class="n">speciation_rate</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.get_protracted"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.get_protracted">[docs]</a>	<span class="k">def</span> <span class="nf">get_protracted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets whether the simulation pointed to by this object is a protracted simulation or not.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_database</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">t</span><span class="o">.</span><span class="n">set_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
				<span class="c1"># Catches errors thrown if the simulation is paused</span>
				<span class="k">pass</span>
			<span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">is_protracted</span><span class="p">()</span></div>

<div class="viewcode-block" id="Coalescence.load_config"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.load_config">[docs]</a>	<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Loads the config file by reading the lines in order.</span>

<span class="sd">		:param str config_file: the config file to read in.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># New method using ConfigParser</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">config_success</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Failure to import ConfigParser: cannot load config file&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;job_type&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">map_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;map_config&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;output_directory&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_spec_rate&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;deme&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_size&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;time_config&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_species&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
			<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;spec_rate&quot;</span><span class="p">):</span>
				<span class="n">opts</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s2">&quot;spec_rate&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;spec_rate&quot;</span><span class="p">,</span> <span class="n">each</span><span class="p">))</span></div>

<div class="viewcode-block" id="Coalescence.create_config"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.create_config">[docs]</a>	<span class="k">def</span> <span class="nf">create_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Generates the output config files. This version creates the concise version of the config file.</span>

<span class="sd">		:param str output_file: the file to generate the config option. Must be a path to a .txt file.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
									   <span class="s2">&quot;mainconf_{}_{}.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)))</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">config_success</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;ConfigParser import was unsuccessful: cannot create config file.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file</span><span class="p">)):</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
				<span class="s1">&#39;Path {} does not exist for writing output to, creating.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file</span><span class="p">)))</span>
			<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_open</span><span class="p">:</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
					<span class="n">config</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config_open</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span><span class="p">:</span>
			<span class="c1"># New method using ConfigParser</span>
			<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;job_type&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_config</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot create config without map configuration options set.&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;map_config&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_config</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;output_directory&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_spec_rate&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;deme&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deme</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_size&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;max_time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;dispersal_relative_cost&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span><span class="p">))</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;time_config&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;min_species&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span><span class="p">))</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">)</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">,</span> <span class="s2">&quot;has_protracted&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">)))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">,</span> <span class="s2">&quot;min_speciation_gen&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span><span class="p">))</span>
				<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;protracted&quot;</span><span class="p">,</span> <span class="s2">&quot;max_speciation_gen&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span><span class="p">))</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;spec_rates&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">])):</span>
					<span class="n">spec_rate</span> <span class="o">=</span> <span class="s2">&quot;spec_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
					<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spec_rates&quot;</span><span class="p">,</span> <span class="n">spec_rate</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
				<span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">=</span> <span class="n">output_file</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Setup has not been completed, cannot create config file&quot;</span><span class="p">)</span></div>

	<span class="c1"># TODO remove this functionality as dual-config file usage is now deprecated (there was absolutely no point to it)</span>
<div class="viewcode-block" id="Coalescence.set_map_config"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.set_map_config">[docs]</a>	<span class="k">def</span> <span class="nf">set_map_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets a specific map config and tells the program that full commmand-line parsing is not required.</span>

<span class="sd">		:param str file: the file to read map config options from</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">map_config</span> <span class="o">=</span> <span class="nb">file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_full</span> <span class="o">=</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Coalescence.set_map_files"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.set_map_files">[docs]</a>	<span class="k">def</span> <span class="nf">set_map_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_file</span><span class="p">,</span> <span class="n">fine_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">coarse_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pristine_fine_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
					  <span class="n">pristine_coarse_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dispersal_map</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reproduction_map</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the map files (or to null, if none specified). It then calls detect_map_dimensions() to correctly read in</span>
<span class="sd">		the specified dimensions.</span>
<span class="sd">		Note that if sample_file is &quot;null&quot;, values will remain at 0.</span>
<span class="sd">		If coarse_file is &quot;null&quot;, it will default to the size of fine_file with zero offset.</span>
<span class="sd">		If the coarse file is &quot;none&quot;, it will not be used.</span>
<span class="sd">		If the pristine fine or coarse files are &quot;none&quot;, they will not be used.</span>

<span class="sd">		:param str sample_file: the sample map file. Provide &quot;null&quot; if on samplemask is required</span>
<span class="sd">		:param str fine_file: the fine map file. Defaults to &quot;null&quot; if none provided</span>
<span class="sd">		:param str coarse_file: the coarse map file. Defaults to &quot;none&quot; if none provided</span>
<span class="sd">		:param str pristine_fine_file: the pristine fine map file. Defaults to &quot;none&quot; if none provided</span>
<span class="sd">		:param str pristine_coarse_file: the pristine coarse map file. Defaults to &quot;none&quot; if none provided</span>
<span class="sd">		:param str dispersal_map: the dispersal map for reading dispersal values. Default to &quot;none&quot; if none provided</span>
<span class="sd">		:param str reproduction_map: a map of relative reproduction probabilities, at the scale of the fine map</span>

<span class="sd">		:rtype None</span>

<span class="sd">		:return None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">fine_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fine map file cannot be &#39;none&#39; or &#39;null&#39; for automatic parameter detection.&quot;</span>
							 <span class="s2">&quot;Use set_map_parameters() instead.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">coarse_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">coarse_file</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
		<span class="k">if</span> <span class="n">pristine_fine_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">pristine_fine_file</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
		<span class="k">if</span> <span class="n">pristine_coarse_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">pristine_coarse_file</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
		<span class="k">if</span> <span class="n">dispersal_map</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">dispersal_map</span>
		<span class="k">if</span> <span class="n">reproduction_map</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">reproduction_map</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_map_parameters</span><span class="p">(</span><span class="n">sample_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fine_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">coarse_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								<span class="n">pristine_fine_file</span><span class="p">,</span> <span class="n">pristine_coarse_file</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">detect_map_dimensions</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="o">=</span> <span class="bp">False</span>
			<span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="Coalescence.detect_map_dimensions"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.detect_map_dimensions">[docs]</a>	<span class="k">def</span> <span class="nf">detect_map_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Detects all the map dimensions for the provided files (where possible) and sets the respective values.</span>
<span class="sd">		This is intended to be run after set_map_files()</span>

<span class="sd">		:raises TypeError: if a dispersal map or reproduction map is specified, we must have a fine map specified, but</span>
<span class="sd">		not a coarse map.</span>
<span class="sd">		:raises IOError: if one of the required maps does not exist</span>
<span class="sd">		:raises ValueError: if the dimensions of the dispersal map do not make sense when used with the fine map</span>
<span class="sd">		provided</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="n">x_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span>
										   <span class="n">x_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="n">tmpname</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_scale</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">tmpname</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">calculate_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="p">)</span>
		<span class="c1"># Now do detection for dispersal map</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">}:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="ow">or</span> \
							<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dimensions of dispersal map do not match dimensions of fine map. This is currently&quot;</span>
								 <span class="s2">&quot; unsupported.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">}:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">()</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">or</span> \
							<span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dimensions of the reproduction map do not match the fine map. This is currently &quot;</span>
								 <span class="s2">&quot;unsupported.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_maps</span><span class="p">()</span></div>

<div class="viewcode-block" id="Coalescence.set_map_parameters"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.set_map_parameters">[docs]</a>	<span class="k">def</span> <span class="nf">set_map_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_file</span><span class="p">,</span> <span class="n">sample_x</span><span class="p">,</span> <span class="n">sample_y</span><span class="p">,</span> <span class="n">fine_file</span><span class="p">,</span> <span class="n">fine_x</span><span class="p">,</span> <span class="n">fine_y</span><span class="p">,</span> <span class="n">fine_x_offset</span><span class="p">,</span>
						   <span class="n">fine_y_offset</span><span class="p">,</span> <span class="n">coarse_file</span><span class="p">,</span> <span class="n">coarse_x</span><span class="p">,</span> <span class="n">coarse_y</span><span class="p">,</span>
						   <span class="n">coarse_x_offset</span><span class="p">,</span> <span class="n">coarse_y_offset</span><span class="p">,</span> <span class="n">coarse_scale</span><span class="p">,</span> <span class="n">pristine_fine_map</span><span class="p">,</span> <span class="n">pristine_coarse_map</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">		Set up the map objects with the required parameters. This is required for csv file usage.</span>

<span class="sd">		Note that this function is not recommended for tif file usage, as it is much simpler to call set_map_files() and</span>
<span class="sd">		which should automatically calculate map offsets, scaling and dimensions.</span>

<span class="sd">		:param sample_file: the sample file to use, which should contain a boolean mask of where to sample</span>
<span class="sd">		:param sample_x: the x dimension of the sample file</span>
<span class="sd">		:param sample_y: the y dimension of the sample file</span>
<span class="sd">		:param fine_file: the fine map file to use (must be equal to or larger than the sample file)</span>
<span class="sd">		:param fine_x: the x dimension of the fine map file</span>
<span class="sd">		:param fine_y: the y dimension of the fine map file</span>
<span class="sd">		:param fine_x_offset: the x offset of the fine map file</span>
<span class="sd">		:param fine_y_offset: the y offset of the fine map file</span>
<span class="sd">		:param coarse_file: the coarse map file to use (must be equal to or larger than fine map file)</span>
<span class="sd">		:param coarse_x: the x dimension of the coarse map file</span>
<span class="sd">		:param coarse_y: the y dimension of the coarse map file</span>
<span class="sd">		:param coarse_x_offset: the x offset of the coarse map file at the resolution of the fine map</span>
<span class="sd">		:param coarse_y_offset: the y offset of the coarse map file at the resoultion of the fine map</span>
<span class="sd">		:param coarse_scale: the relative scale of the coarse map compared to the fine map (must match x and y scaling)</span>
<span class="sd">		:param pristine_fine_map: the pristine fine map file to use (must have dimensions equal to fine map)</span>
<span class="sd">		:param pristine_coarse_map: the pristine coarse map file to use (must have dimensions equal to coarse map)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="n">sample_file</span><span class="p">,</span> <span class="n">sample_x</span><span class="p">,</span> <span class="n">sample_y</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="n">fine_file</span><span class="p">,</span> <span class="n">fine_x</span><span class="p">,</span> <span class="n">fine_y</span><span class="p">,</span> <span class="n">fine_x_offset</span><span class="p">,</span> <span class="n">fine_y_offset</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="n">coarse_file</span><span class="p">,</span> <span class="n">coarse_x</span><span class="p">,</span> <span class="n">coarse_y</span><span class="p">,</span> <span class="n">coarse_x_offset</span><span class="p">,</span> <span class="n">coarse_y_offset</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">coarse_scale</span> <span class="o">=</span> <span class="n">coarse_scale</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span> <span class="o">=</span> <span class="n">pristine_fine_map</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span> <span class="o">=</span> <span class="n">pristine_coarse_map</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Map objects are already set up.&quot;</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.set_simulation_params"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.set_simulation_params">[docs]</a>	<span class="k">def</span> <span class="nf">set_simulation_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">,</span> <span class="n">min_speciation_rate</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">deme</span><span class="p">,</span>
							  <span class="n">sample_size</span><span class="p">,</span> <span class="n">max_time</span><span class="p">,</span> <span class="n">dispersal_method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
							  <span class="n">dispersal_relative_cost</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_num_species</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">forest_change_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
							  <span class="n">pristine_forest_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
							  <span class="n">time_config_file</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="n">restrict_self</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">infinite_landscape</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">protracted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
							  <span class="n">min_speciation_gen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_speciation_gen</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Set all the simulation parameters apart from the map objects.</span>

<span class="sd">		:param int seed: the unique job number for this simulation set</span>
<span class="sd">		:param int job_type: the job type (used for easy file identification after simulations are complete)</span>
<span class="sd">		:param str output_directory: the output directory to store the SQL database</span>
<span class="sd">		:param float min_speciation_rate: the minimum speciation rate to simulate</span>
<span class="sd">		:param float sigma: the dispersal sigma value</span>
<span class="sd">		:param float tau: the fat-tailed dispersal tau value</span>
<span class="sd">		:param int deme: the deme size (in individuals per cell)</span>
<span class="sd">		:param float sample_size: the sample size of the deme (decimal 0-1)</span>
<span class="sd">		:param float max_time: the maximum allowed simulation time (in seconds)</span>
<span class="sd">		:param str dispersal_method: the dispersal kernel method. Should be one of [normal, fat-tail, norm-uniform]</span>
<span class="sd">		:param float m_prob: the probability of drawing from the uniform dispersal. Only relevant for uniform dispersals</span>
<span class="sd">		:param float cutoff: the maximum value for the uniform dispersal. Only relevant for uniform dispersals.</span>
<span class="sd">		:param float dispersal_relative_cost: the relative cost of travelling through non-habitat (defaults to 1)</span>
<span class="sd">		:param int min_num_species: the minimum number of species known to exist (defaults to 1</span>
<span class="sd">		:param float forest_change_rate: the rate of forest change over time</span>
<span class="sd">		:param float pristine_forest_time: the time in generations since a pristine state was achieved</span>
<span class="sd">		:param str time_config_file: the path to the time config file (or null)</span>
<span class="sd">		:param bool restrict_self: if true, restricts dispersal from own cell</span>
<span class="sd">		:param bool/str infinite_landscape: if false or &quot;closed&quot;, restricts dispersal to the provided maps, otherwise</span>
<span class="sd">		can be &quot;infinite&quot;, or a tiled landscape using &quot;tiled_coarse&quot; or &quot;tiled_fine&quot;.</span>
<span class="sd">		:param bool protracted: if true, uses protracted speciation application</span>
<span class="sd">		:param float min_speciation_gen: the minimum amount of time a lineage must exist before speciation occurs.</span>
<span class="sd">		:param float max_speciation_gen: the maximum amount of time a lineage can exist before speciating.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">output_directory</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span> <span class="o">=</span> <span class="n">min_speciation_rate</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">=</span> <span class="n">deme</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span> <span class="o">=</span> <span class="n">dispersal_relative_cost</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span> <span class="o">=</span> <span class="n">min_num_species</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">forest_change_rate</span> <span class="o">=</span> <span class="n">forest_change_rate</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">time_since_pristine</span> <span class="o">=</span> <span class="n">pristine_forest_time</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">=</span> <span class="n">time_config_file</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span> <span class="o">=</span> <span class="n">dispersal_method</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">m_prob</span> <span class="o">=</span> <span class="n">m_prob</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">restrict_self</span> <span class="o">=</span> <span class="n">restrict_self</span>
			<span class="k">if</span> <span class="n">infinite_landscape</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">}:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
			<span class="k">elif</span> <span class="n">infinite_landscape</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">True</span><span class="p">,</span> <span class="s2">&quot;infinite&quot;</span><span class="p">}:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span> <span class="o">=</span> <span class="s2">&quot;infinite&quot;</span>
			<span class="k">elif</span> <span class="n">infinite_landscape</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;tiled_coarse&quot;</span><span class="p">,</span> <span class="s2">&quot;tiled_fine&quot;</span><span class="p">}:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span> <span class="o">=</span> <span class="n">infinite_landscape</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supplied landscape type is not recognised: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infinite_landscape</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">protracted</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">protracted</span> <span class="o">=</span> <span class="bp">True</span>
				<span class="k">if</span> <span class="n">max_speciation_gen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using protracted speciation, but no maximum speciation generation supplied.&quot;</span>
									<span class="s2">&quot; Default to 10^100&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">100</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">max_speciation_gen</span> <span class="o">=</span> <span class="n">max_speciation_gen</span>
				<span class="k">if</span> <span class="n">min_speciation_gen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using protracted speciation, but no minimum speciation generation supplied.&quot;</span>
									<span class="s2">&quot; Default to 0.0&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_gen</span> <span class="o">=</span> <span class="n">min_speciation_gen</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Parameters already set up.&quot;</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.check_simulation_params"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.check_simulation_params">[docs]</a>	<span class="k">def</span> <span class="nf">check_simulation_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks that simulation parameters have been correctly set and the program is ready for running.</span>
<span class="sd">		Note that these checks have not been fully tested and are probably unnecessary in a large number of cases.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">:</span>
			<span class="c1"># print(self.output_directory)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">}:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Output directory not set.&#39;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Coalescence and Speciation programs not identified&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.resume_coalescence"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.resume_coalescence">[docs]</a>	<span class="k">def</span> <span class="nf">resume_coalescence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pause_directory</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">max_time</span><span class="p">,</span> <span class="n">out_directory</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Resumes the simulation from the specified directory, looking for the simulation with the specified seed and task</span>
<span class="sd">		referencing.</span>

<span class="sd">		:param pause_directory: the directory to search for the paused simulation</span>
<span class="sd">		:param seed: the seed of the paused simulation</span>
<span class="sd">		:param job_type: the task of the paused simulation</span>
<span class="sd">		:param max_time: the maximum time to run simulations for</span>
<span class="sd">		:param out_directory: optionally provide an alternative output location. Defaults to same location as</span>
<span class="sd">		pause_directory</span>

<span class="sd">		.. note: A max time of 0 uses the previous simulation maximum time.</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">out_directory</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">out_directory</span> <span class="o">=</span> <span class="n">pause_directory</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">out_directory</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pause_directory</span> <span class="o">=</span> <span class="n">pause_directory</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
		<span class="n">file_path</span> <span class="o">=</span> <span class="p">[</span>
			<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pause_directory</span><span class="p">,</span> <span class="s2">&quot;Pause&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;Dump_&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
			<span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">]]</span>
		<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">file_path</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">each</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
					<span class="s2">&quot;Paused file &quot;</span> <span class="o">+</span> <span class="n">each</span> <span class="o">+</span> <span class="s2">&quot; not found. Ensure pause directory is correct and is accessible.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">necsim_import_success</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">setup_necsim</span><span class="p">()</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">protracted_resume</span><span class="p">(</span><span class="n">pause_directory</span><span class="p">,</span> <span class="n">out_directory</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">max_time</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">resume</span><span class="p">(</span><span class="n">pause_directory</span><span class="p">,</span> <span class="n">out_directory</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">max_time</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">NECSimError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using deprecated method.&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span> <span class="o">=</span> <span class="bp">False</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot use deprecated NECSim method for protracted simulations. Ensure install is&quot;</span>
								   <span class="s2">&quot;completed successfully to use protracted speciation.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span><span class="p">:</span>
				<span class="n">call_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coalescence_simulator</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="n">pause_directory</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">max_time</span><span class="p">]</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">execute_log_info</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">call_list</span><span class="p">])</span>
				<span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
					<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error thrown while trying to resume simulation: &quot;</span><span class="p">)</span>
					<span class="k">raise</span> <span class="n">err</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Setup is incomplete. Please run setup() first.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.persistent_ram_usage"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.persistent_ram_usage">[docs]</a>	<span class="k">def</span> <span class="nf">persistent_ram_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		This is the persistent RAM usage which cannot be optimised by the program for a particular set of maps</span>
<span class="sd">		:return: the total persistent RAM usage in bytes</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">total_ram</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="c1"># First add the maps</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">4</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">8</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">*</span> <span class="mi">8</span>
		<span class="c1"># Now add the other large memory objects</span>
		<span class="c1"># The data object</span>
		<span class="n">total_ram</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_individuals</span><span class="p">()</span> <span class="o">*</span> <span class="mi">91</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
		<span class="c1"># The active object</span>
		<span class="n">total_ram</span> <span class="o">+=</span> <span class="mi">72</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_individuals</span><span class="p">()</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">total_ram</span></div>

<div class="viewcode-block" id="Coalescence.estimate_ram_usage"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.estimate_ram_usage">[docs]</a>	<span class="k">def</span> <span class="nf">estimate_ram_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_individuals</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Estimates the RAM usage for the program with the current parameters.</span>

<span class="sd">		Note this estimates the upper bound of memory usage and is likely inaccurate, especially for simulations with</span>
<span class="sd">		multiple time sampling points.</span>

<span class="sd">		:param grid_individuals: the number of individuals existing on the grid</span>

<span class="sd">		:return: the estimated RAM usage in bytes</span>

<span class="sd">		:rtype float</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">total_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent_ram_usage</span><span class="p">()</span>
		<span class="c1"># The grid object</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
			<span class="n">total_ram</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span><span class="p">))</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">grid_individuals</span></div>

<div class="viewcode-block" id="Coalescence.count_individuals"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.count_individuals">[docs]</a>	<span class="k">def</span> <span class="nf">count_individuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Estimates the number of individuals to be simulated. This may be inaccurate if using multiple time points and</span>
<span class="sd">		historical maps.</span>

<span class="sd">		:return: a count of the number of individuals to be simulated</span>

<span class="sd">		:rtype float</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]:</span>
				<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">())</span> <span class="o">*</span> \
							   <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">count_total</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">)</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span></div>

<div class="viewcode-block" id="Coalescence.import_fine_map_array"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.import_fine_map_array">[docs]</a>	<span class="k">def</span> <span class="nf">import_fine_map_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Imports the fine map array to the in-memory object, subsetted to the same size as the sample grid.</span>
<span class="sd">		:rtype None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span>
																  <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span>
																  <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span>
																  <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Coalescence.import_sample_map_array"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.import_sample_map_array">[docs]</a>	<span class="k">def</span> <span class="nf">import_sample_map_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Imports the sample map array to the in-memory object.</span>
<span class="sd">		:rtype None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">ds2</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds2</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
			<span class="n">ds2</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Coalescence.grid_density_estimate"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.grid_density_estimate">[docs]</a>	<span class="k">def</span> <span class="nf">grid_density_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_off</span><span class="p">,</span> <span class="n">y_off</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Counts the density total for a subset of the grid by sampling from the fine map</span>

<span class="sd">		Note that this function is an approximation (based on the average density of the fine map) and does not produce</span>
<span class="sd">		a perfect value. This is done for performance reasons. The actual value can be obtained with</span>
<span class="sd">		grid_density_actual().</span>

<span class="sd">		:param x_off: the x offset of the grid map subset</span>
<span class="sd">		:param y_off: the y offset of the grid map subset</span>
<span class="sd">		:param x_dim: the x dimension of the grid map subset</span>
<span class="sd">		:param y_dim: the y dimension of the grid map subset</span>

<span class="sd">		:return: an estimate of the total individuals that exist in the subset.</span>
<span class="sd">		:rtype int</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">import_fine_map_array</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="ow">and</span> \
						<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">import_sample_map_array</span><span class="p">()</span>
			<span class="c1"># Less accurate, but faster way.</span>
			<span class="n">arr_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">]</span>
			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">arr_subset</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Coalescence.grid_density_actual"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.grid_density_actual">[docs]</a>	<span class="k">def</span> <span class="nf">grid_density_actual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_off</span><span class="p">,</span> <span class="n">y_off</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Counts the density total for a subset of the grid by sampling from the fine map.</span>

<span class="sd">		Note that for large maps this can take a very long time.</span>

<span class="sd">		:param x_off: the x offset of the grid map subset</span>
<span class="sd">		:param y_off: the y offset of the grid map subset</span>
<span class="sd">		:param x_dim: the x dimension of the grid map subset</span>
<span class="sd">		:param y_dim: the y dimension of the grid map subset</span>

<span class="sd">		:return: the total individuals that exist in the subset.</span>
<span class="sd">		:rtype int</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">import_fine_map_array</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="ow">and</span> \
						<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">import_sample_map_array</span><span class="p">()</span>
			<span class="c1"># Less accurate, but faster way.</span>
			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">],</span>
												   <span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">])</span> <span class="o">*</span>
									   <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span><span class="p">[</span><span class="n">x_off</span><span class="p">:</span><span class="n">x_off</span> <span class="o">+</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_off</span><span class="p">:</span><span class="n">y_off</span> <span class="o">+</span> <span class="n">y_dim</span><span class="p">]</span> <span class="o">*</span>
									   <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Coalescence.get_average_density"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.get_average_density">[docs]</a>	<span class="k">def</span> <span class="nf">get_average_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the average density across the fine map, subsetted for the sample grid.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">import_fine_map_array</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map_average</span></div>

<div class="viewcode-block" id="Coalescence.check_sample_map_equals_sample_grid"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.check_sample_map_equals_sample_grid">[docs]</a>	<span class="k">def</span> <span class="nf">check_sample_map_equals_sample_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks if the grid and sample map are the same size and offset (in which case, future operations can be simplified&quot;</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">and</span> \
			   <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">==</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Coalescence.optimise_ram"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.optimise_ram">[docs]</a>	<span class="k">def</span> <span class="nf">optimise_ram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ram_limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Optimises the maps for a specific RAM usage.</span>

<span class="sd">		If ram_limit is None, this function does nothing.</span>

<span class="sd">		:note This function assumes that the c++ compiler has sizeof(long) = 8 bytes for calculating space usage.</span>

<span class="sd">		:param ram_limit: the desired amount of RAM to limit to, in GB</span>

<span class="sd">		:raises MemoryError: if the desired simulation cannot be compressed into available RAM</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sample size is 0, or deme is 0. set_simulation_params() before optimising RAM.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ram_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="p">)</span>
			<span class="c1"># Over-estimate static usage slightly</span>
			<span class="n">static_usage</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent_ram_usage</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span>
			<span class="k">if</span> <span class="n">static_usage</span> <span class="o">&gt;</span> <span class="n">ram_limit</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span>
					<span class="s2">&quot;Cannot achieve RAM limit: minimum requirements are {}GB.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">static_usage</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
			<span class="n">remaining_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">ram_limit</span> <span class="o">-</span> <span class="n">static_usage</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span>
			<span class="c1"># Rough calculation of number of cells we have remaining (aim for 75% to be sure)</span>
			<span class="n">average_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span>
			<span class="c1"># This is the size of the grid object in memory</span>
			<span class="n">tmp_space</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">remaining_space</span> <span class="o">/</span> <span class="p">((</span><span class="mi">8</span> <span class="o">*</span> <span class="n">average_density</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span>
			<span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">tmp_space</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">))</span>
			<span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s2">&quot;Could not find square grid to achieve RAM limit. Please set this manually.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Memory limit high enough for full spatial simulation. No optimisation necessary.&quot;</span><span class="p">)</span>
			<span class="n">max_attained</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="c1"># Now loop over every square of the required size on the grid, until we find one with the maximum density</span>
			<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">:</span>
				<span class="n">printing</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">printing</span> <span class="o">=</span> <span class="bp">False</span>
			<span class="n">end_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Extremely small grid size: {}. Disabling maximum density checking.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
				<span class="n">max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">max_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">max_attained</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)))):</span>
					<span class="k">if</span> <span class="n">printing</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Checking {} / {} : {}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end_x</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">end_x</span><span class="p">)))</span>
					<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)))):</span>
						<span class="c1"># print(&quot;x, y: {}, {}&quot;.format(x, y))</span>
						<span class="n">tmp_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density_actual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">tmp_total</span> <span class="o">&gt;</span> <span class="n">max_attained</span><span class="p">:</span>
							<span class="n">max_x</span> <span class="o">=</span> <span class="n">x</span>
							<span class="n">max_y</span> <span class="o">=</span> <span class="n">y</span>
							<span class="n">max_attained</span> <span class="o">=</span> <span class="n">tmp_total</span>
				<span class="k">if</span> <span class="n">printing</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Checking complete               </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">max_attained</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c1"># Now do one last check for consistency</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_check</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">printing</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shrinking due to high densities in sample zone.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
					<span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deme</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">=</span> <span class="n">size</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span> <span class="o">=</span> <span class="n">size</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">max_x</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">max_y</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;set&quot;</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_sample_map_equals_sample_grid</span><span class="p">():</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
				<span class="c1"># Now remove our in-memory arrays</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_wipe_objects</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s2">&quot;Could not optimise maps for desired memory usage. &quot;</span>
								  <span class="s2">&quot;Attempted grid size of {} and achived max of {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">max_attained</span><span class="p">))</span></div>

<div class="viewcode-block" id="Coalescence.get_optimised_solution"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.get_optimised_solution">[docs]</a>	<span class="k">def</span> <span class="nf">get_optimised_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the optimised solution as a dictionary containing the important optimised variables.</span>
<span class="sd">		This can be read back in with set_optimised_solution</span>

<span class="sd">		:return dict containing the important optimised variables</span>
<span class="sd">		:rtype dict</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="p">{</span><span class="s2">&quot;grid_x_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span>
				<span class="s2">&quot;grid_y_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span>
				<span class="s2">&quot;sample_x_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span>
				<span class="s2">&quot;sample_y_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span>
				<span class="s2">&quot;grid_file_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span><span class="p">}</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="Coalescence.set_optimised_solution"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.set_optimised_solution">[docs]</a>	<span class="k">def</span> <span class="nf">set_optimised_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_in</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the optimised RAM solution from the variables in the provided dictionary.</span>
<span class="sd">		This should contain the grid_x_size, grid_y_size, grid_file_name, sample_x_offset and sample_y_offset.</span>

<span class="sd">		:param dict dict_in: the dictionary containing the optimised RAM solution variables</span>
<span class="sd">		:rtype None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x_size</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;grid_x_size&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">y_size</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;grid_y_size&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;sample_x_offset&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;sample_y_offset&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">dict_in</span><span class="p">[</span><span class="s2">&quot;grid_file_name&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Coalescence.finalise_setup"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.finalise_setup">[docs]</a>	<span class="k">def</span> <span class="nf">finalise_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Runs all setup routines to provide a complete simulation. Should be called immediately before run_coalescence()</span>
<span class="sd">		to ensure the simulation setup is complete.</span>
<span class="sd">		Calls check_simulation_params, generate_command() and run_checks()</span>

<span class="sd">		:param config_default: set to false if want config file to only be created if necessary. Defaults to True</span>
<span class="sd">		:param ignore_errors: if true, any FileNotFoundError and FileExistsError raised by checking the output database</span>
<span class="sd">		are ignored</span>
<span class="sd">		:param expected: set to true if we expect the output file to exist</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_simulation_params</span><span class="p">()</span>
		<span class="c1"># Now check if config files need to be written.</span>
		<span class="n">config_require</span> <span class="o">=</span> <span class="n">config_default</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">:</span>
			<span class="n">config_require</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span><span class="p">:</span>
			<span class="n">config_require</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">if</span> <span class="n">config_require</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_pristine_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span><span class="p">,</span>
									  <span class="bp">self</span><span class="o">.</span><span class="n">time_since_pristine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forest_change_rate</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_config</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config_require</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_map_config</span><span class="p">()</span>
		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config_require</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_temporal_sampling_config</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">config_require</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_full</span> <span class="o">=</span> <span class="bp">False</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_config</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">run_checks</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>
		<span class="k">except</span> <span class="p">(</span><span class="n">FileExistsError</span><span class="p">,</span> <span class="n">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">err</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span></div>

<div class="viewcode-block" id="Coalescence.generate_command"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.generate_command">[docs]</a>	<span class="k">def</span> <span class="nf">generate_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Completes the setup process by creating the list that will be passed to the c++ executable&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span><span class="p">:</span>
				<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Set up already completed&quot;</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">:</span>
					<span class="n">tmp_call_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coalescence_simulator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_config</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">deme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span><span class="p">]</span>
				<span class="c1"># print(tmp_call_list)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">tmp_call_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coalescence_simulator</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_size</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">x_offset</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_scale</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_speciation_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">deme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_relative_cost</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_num_species</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">forest_change_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_since_pristine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span>
									 <span class="bp">self</span><span class="o">.</span><span class="n">time_config_file</span><span class="p">]</span>
				<span class="c1"># print(tmp_call_list)</span>
				<span class="c1"># Make sure that there is no empty list appended if there are no speciation rates supplied.</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">tmp_call_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="p">])</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">call_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_call_list</span><span class="p">]</span>
			<span class="c1"># print self.call_list</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculate_sql_database</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Set up is incomplete: Map/Full: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Param: &quot;</span>
			<span class="n">err</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Setup: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span><span class="p">)</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.set_speciation_rates"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.set_speciation_rates">[docs]</a>	<span class="k">def</span> <span class="nf">set_speciation_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speciation_rates</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Add speciation rates for analysis at the end of the simulation. This is optional</span>

<span class="sd">		:param list speciation_rates: a list of speciation rates to apply at the end of the simulation</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">speciation_rates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">speciation_rates</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.calculate_sql_database"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.calculate_sql_database">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_sql_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Saves the output database location to self.output_database.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
											<span class="s2">&quot;SQL_data&quot;</span><span class="p">,</span> <span class="s2">&quot;data_{}_{}.db&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Coalescence.check_sql_database"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.check_sql_database">[docs]</a>	<span class="k">def</span> <span class="nf">check_sql_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks whether the output database exists. If the existance does not match the expected variable, raises an</span>
<span class="sd">		error.</span>

<span class="sd">		:raises FileExistsError: if the file already exists when it&#39;s not expected to</span>
<span class="sd">		:raises FileNotExistsError: if the file does not exist when we expect it to</span>

<span class="sd">		:param expected: boolean for expected existance of the output file</span>

<span class="sd">		:rtype None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">t</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">)</span>
					<span class="n">t</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
				<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
					<span class="k">pass</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">FileExistsError</span><span class="p">(</span><span class="s2">&quot;Output sql database already exists.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Output sql database {} not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_database</span><span class="p">))</span></div>

<div class="viewcode-block" id="Coalescence.check_maps"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.check_maps">[docs]</a>	<span class="k">def</span> <span class="nf">check_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks that the maps all exist and that the file structure makes sense.</span>

<span class="sd">		:raises TypeError: if a dispersal map or reproduction map is specified, we must have a fine map specified, but</span>
<span class="sd">			not a coarse map.</span>

<span class="sd">		:raises IOError: if one of the required maps does not exist</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">map_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_map</span><span class="p">]:</span>
			<span class="n">map_file</span><span class="o">.</span><span class="n">check_map</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">map_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span><span class="p">]:</span>
			<span class="n">check_file_exists</span><span class="p">(</span><span class="n">map_file</span><span class="p">)</span>
		<span class="c1"># Now check that the rest of the map naming structures make sense.</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_map_file</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
					<span class="s2">&quot;Pristine fine file is &#39;none&#39; but pristine coarse file is not none. Check file names.&quot;</span><span class="p">)</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Defaulting to pristine_coarse_map_file = &#39;none&#39;&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
					<span class="s2">&quot;Set pristine fine map file to &#39;none&#39;, but then added other pristine maps. Changing.&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pristine_fine_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Coarse file is &#39;none&#39; but pristine coarse file is not none. Check file names.&quot;</span><span class="p">)</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Defaulting to pristine_coarse_map_file = &#39;none&#39;&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_map_file</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pristine_coarse_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_map</span><span class="o">.</span><span class="n">file_name</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Fine map file cannot be &#39;none&#39;, changing to &#39;null&#39;.&quot;</span><span class="p">)</span>
		<span class="c1"># Now check our combination of dispersal map, reproduction map and infinite landscape with our fine/coarse maps</span>
		<span class="c1"># makes sense</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersal_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">}:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">}:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot use a coarse map if using a dispersal map. &quot;</span>
								<span class="s2">&quot;This feature is currently unsupported.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reproduction_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">}:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">}:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot use a coarse map if using a reproduction map. &quot;</span>
								<span class="s2">&quot;This feature is currently unsupported.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span> <span class="ow">is</span> <span class="s2">&quot;tiled_fine&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">}:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot use a coarse map with a tiled fine landscape.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite_landscape</span> <span class="ow">is</span> <span class="s2">&quot;tiled_coarse&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_map</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">}:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot use a tiled_coarse landscape without a coarse map.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.run_checks"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.run_checks">[docs]</a>	<span class="k">def</span> <span class="nf">run_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Check that the simulation is correctly set up and that all the required files exist.</span>

<span class="sd">		:param expected: set to true if we expect the output file to already exist</span>

<span class="sd">		:raises RuntimeError: if previous set-up routines are not complete</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_map</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_param</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">check_maps</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Set up is incomplete.&quot;</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_sql_database</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span></div>

	<span class="k">def</span> <span class="nf">_create_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logging_level</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates the logger for use with NECSim simulation. Note you can supply your own logger by over-riding</span>
<span class="sd">		self.logger. This function should only be run during self.__init__()</span>

<span class="sd">		:param file: file to write output to. If None, outputs to terminal</span>
<span class="sd">		:param logging_level: the logging level to use (defaults to INFO)</span>

<span class="sd">		:return: None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">logging_level</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">logging_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">logging_level</span><span class="p">)</span>

<div class="viewcode-block" id="Coalescence.run_from_config"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.run_from_config">[docs]</a>	<span class="k">def</span> <span class="nf">run_from_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calls NECSim to run from config within a new thread</span>

<span class="sd">		:param logger:</span>
<span class="sd">		:param config_file:</span>

<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># TODO correct or remove this function</span>
		<span class="n">necsimmodule</span><span class="o">.</span><span class="n">set_log_function</span><span class="p">(</span><span class="n">write_to_log</span><span class="p">)</span>
		<span class="n">necsimmodule</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
		<span class="n">output</span> <span class="o">=</span> <span class="n">necsimmodule</span><span class="o">.</span><span class="n">run_from_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coalescence.run_coalescence"><a class="viewcode-back" href="../../PyCoalescence.html#PyCoalescence.coalescence.Coalescence.run_coalescence">[docs]</a>	<span class="k">def</span> <span class="nf">run_coalescence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Attempt to run the simulation with the given simulation set-up.</span>
<span class="sd">		This is the main routine performing the actual simulation which will take a considerable amount of time.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup_complete</span><span class="p">:</span>
			<span class="c1"># Make the output directory if it doesn&#39;t yet exist</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">):</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
			<span class="c1"># Call the c++ code and run the simulation</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">necsim_import_success</span><span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;NECSim import unsuccessful: cannot run simulations using c++ API. Attempting system call&quot;</span>
							  <span class="s2">&quot; instead&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">necsim_import_success</span><span class="p">:</span>
				<span class="c1"># Run NECSim</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">setup_necsim</span><span class="p">()</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protracted</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">protracted_run_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">run_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
					<span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">necsim</span><span class="o">.</span><span class="n">NECSimError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># Deprecated method if cannot link to shared objects</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using deprecated os call method.&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">necsim_import_success</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NECSim not successfully imported.&quot;</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Config file was :&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_config_file</span><span class="p">)</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">execute_log_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call_list</span><span class="p">)</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Error raised using deprecated os call method.&quot;</span><span class="p">)</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Call was &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call_list</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Set up is incomplete.&quot;</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

	<span class="k">def</span> <span class="nf">_wipe_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Clears the arrays from memory</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sample_map_array</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">def</span> <span class="nf">_fine_map_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Checks the total number of individuals in a subset from the fine map is less than the average density multiplied</span>
<span class="sd">		by the size of the square.</span>

<span class="sd">		:param max_x: the x value to start subsetting from</span>
<span class="sd">		:param max_y: the y value to start subsetting from</span>
<span class="sd">		:param size: the size of the square</span>
<span class="sd">		:return: bool true if it is smaller</span>
<span class="sd">		:rtype bool</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> \
			   <span class="n">size</span> <span class="o">*</span> <span class="n">size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_density</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">_fine_map_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gets the total of a subset of a subset from the fine map and stores the value</span>

<span class="sd">		:param max_x:</span>
<span class="sd">		:param max_y:</span>
<span class="sd">		:param size:</span>
<span class="sd">		:return:</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_map_array</span><span class="p">[</span><span class="n">max_x</span><span class="p">:</span><span class="n">max_x</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">max_y</span><span class="p">:</span><span class="n">max_y</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span> <span class="o">*</span>
														<span class="bp">self</span><span class="o">.</span><span class="n">deme</span><span class="p">)))</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine_map_sum_res</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/PyCoal_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyCoalescence 1.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Samuel Thompson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.4.
    </div>
  </body>
</html>