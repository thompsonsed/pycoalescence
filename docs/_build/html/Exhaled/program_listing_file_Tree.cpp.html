
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Program Listing for File Tree.cpp &#8212; PyCoalescence 1.2.5 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
    <script type="text/javascript" src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <link rel="shortcut icon" href="../_static/PyCoal_favicon_large.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="File Tree.h" href="file_Tree.h.html" />
    <link rel="prev" title="File Tree.cpp" href="file_Tree.cpp.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="file_Tree.h.html" title="File Tree.h"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="file_Tree.cpp.html" title="File Tree.cpp"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PyCoalescence 1.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="exhaled_library.html" >NECSim</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="file_Tree.cpp.html" accesskey="U">File Tree.cpp</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="program-listing-for-file-tree-cpp">
<span id="program-listing-file-tree-cpp"></span><h1>Program Listing for File Tree.cpp<a class="headerlink" href="#program-listing-for-file-tree-cpp" title="Permalink to this headline">Â¶</a></h1>
<ul class="simple">
<li>Return to documentation for <a class="reference internal" href="file_Tree.cpp.html#file-tree-cpp"><span class="std std-ref">File Tree.cpp</span></a></li>
</ul>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="c1">// This file is part of NECSim project which is released under BSD-3 license.</span>
<span class="c1">// See file **LICENSE.txt** or visit https://opensource.org/licenses/BSD-3-Clause) for full license details.</span>

<span class="c1">//#include &lt;gperftools/profiler.h&gt;</span>
<span class="cp">#include</span> <span class="cpf">&quot;Tree.h&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">importSimulationVariables</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">comargs</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1">// First parse the command line arguments</span>
    <span class="n">parseArgs</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bResume</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bConfig</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">setResumeParameters</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stol</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">stol</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">stol</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="c1">// Import the simulation variables into our SimParameters object.</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">sim_parameters</span><span class="p">.</span><span class="n">import</span><span class="p">(</span><span class="n">comargs</span><span class="p">,</span> <span class="n">bFullmode</span><span class="p">,</span> <span class="n">bConfig</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Now check that our folders exist</span>
    <span class="n">checkFolders</span><span class="p">();</span>
    <span class="c1">// Now check for paused simulations</span>
    <span class="n">checkSims</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">parseArgs</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">comargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// First parse the command line arguments</span>
    <span class="kt">bool</span> <span class="n">bCheckUser</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">comargs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">comargs</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&quot;-e&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MAIN_010: Incorrect command line parsing.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-h&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-H&quot;</span><span class="o">||</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-help&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-e&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="c1">// Sort out piping to terminal if verbose has not been defined.</span>
        <span class="cp">#ifndef verbose</span>
        <span class="n">dup2</span><span class="p">(</span><span class="n">saved_stdout</span><span class="p">,</span> <span class="n">fileno</span><span class="p">(</span><span class="n">stdout</span><span class="p">));</span>
        <span class="c1">//close(saved_stdout);</span>
        <span class="cp">#endif</span>
        <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No arguments supplied: expected 30. These are: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;30 command line arguments are required. These are: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1: the seed for the simulation.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;2: the simulation task (for file reference).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;3: the map config file.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;4: the output directory.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;5: the minimum speciation rate.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;6: the dispersal tau value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;7: the dispersal sigma value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;8: the deme size.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;9: the deme sample size.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;10: the maximum simulation time (in seconds).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;11: the dispersal_relative_cost value for moving through non-habitat.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;12: the temporal sampling file containing tab-separated generation values for sampling points in time (null for only sampling the present).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;13: the minimum number of species known to exist. (Currently has no effect).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;14 onwards: speciation rates to apply after simulation.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;There is also a full-command line mode, (flag -f), which allows for more options to be specified via the command line.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Would you like to see these options? Y/N: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">write_cerr</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">string</span> <span class="n">fullopts</span><span class="p">;</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">fullopts</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">fullopts</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span> <span class="o">||</span> <span class="n">fullopts</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1: the task_iter used for setting the seed.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;2: the sample grid x dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;3: the sample grid y dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;4: the fine map file relative path.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;5: the fine map x dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;6: the fine map y dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;7: the fine map x offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;8 the fine map y offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;9: the coarse map file relative path.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;10: the coarse map x dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;11: the coarse map y dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;12: the coarse map x offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;13: the coarse map y offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;14: the scale of the coarse map compared to the fine (10 means resolution of coarse map = 10 x resolution of fine map).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;15: the output directory.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;16: the speciation rate.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;17: the dispersal distance (tau).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;18: the deme size.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;19: the deme sample size (as a proportion of deme size).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;20: the time to run the simulation (in seconds).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;21: dispersal_relative_cost - the relative cost of moving through non-forest.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;22: the_task - for referencing the specific task later on.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;23: the minimum number of species the system is known to contain.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;24: the pristine fine map file to use.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;25: the pristine coarse map file to use.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;26: the rate of forest change from pristine.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;27: the time (in generations) since the pristine forest was seen.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;28: the dispersal sigma value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;29: the sample mask, with binary 1:0 values for areas that we want to sample from. If this is not provided then this will default to mapping the entire grid.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;30: a file containing a tab-separated list of sample points in time (in generations). If this is null then only the present day will be sampled.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;31-onwards: speciation rates to be applied at the end of the simulation&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Note that using the -f flag prohibits more than one two historic maps being used.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Would you like to run with the default settings? (Y/N)&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">write_cerr</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">string</span> <span class="n">cDef</span><span class="p">;</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">cDef</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cDef</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span><span class="o">||</span><span class="n">cDef</span><span class="o">==</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Possible command line arguments: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-h/-help: Show the help file.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-d/-D: Run with default small parameters.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-dl/-DL: Run with default large parameters.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-dx/-DX: Run with the default very large parameters.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-c/-config: Run with the supplied config file.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">write_cerr</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// exit the program right away as there is no need to continue if there is no simulation to run!</span>
        <span class="p">}</span>
        <span class="cp">#ifndef verbose</span>
        <span class="n">openLogFile</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="cp">#endif</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-r&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-R&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-resume&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;resuming&quot;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Incorrect number of parameters provided for resuming simulation. Expecting:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1: -r flag&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;2: the folder containing the paused simulation (should hold a &#39;Pause&#39; folder)&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;3: the simulation seed&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;4: the simulation task&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;5: the time to run the simulation for&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">bResume</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">bPaused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Import the default parameters if required.</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-d&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-D&quot;</span><span class="o">||</span><span class="n">bCheckUser</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">runAsDefault</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
        <span class="n">bCheckUser</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dl&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-DL&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dL&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-Dl&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">runLarge</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
        <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dx&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dX&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-DX&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-Dx&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">runXL</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
        <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-c&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-C&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-config&quot;</span><span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-Config&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Check that the config file is supplied.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">Main_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_011: FATAL. -c or -config used to attempt import from config file, but no config file provided.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">bConfig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">bFullmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-f&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-f&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;Full command-line mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">bFullmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">removeComOption</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">comargs</span><span class="p">);</span>
    <span class="n">removeComOption</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">comargs</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bFullmode</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">&lt;</span><span class="mi">31</span><span class="o">&amp;&amp;!</span><span class="n">bCheckUser</span> <span class="o">&amp;&amp;!</span><span class="n">bConfig</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">err</span> <span class="o">=</span> <span class="s">&quot;ERROR_MAIN_000: FATAL.  Incorrect arguments supplied (&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; supplied; expected 30).&quot;</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Main_Exception</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
        <span class="c1">// note argc-1 which takes in to account the automatic generation of one command line argument which is the number of arguments.</span>
    <span class="p">}</span>
    <span class="n">argc</span> <span class="o">=</span> <span class="n">comargs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">checkFolders</span><span class="p">()</span>
<span class="p">{</span>

    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Checking folder existance...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">bFineMap</span><span class="p">,</span> <span class="n">bCoarseMap</span><span class="p">,</span> <span class="n">bFineMapPristine</span><span class="p">,</span> <span class="n">bCoarseMapPristine</span><span class="p">,</span> <span class="n">bSampleMask</span><span class="p">,</span> <span class="n">bOutputFolder</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bFineMap</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">finemapfile</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Fatal_Exception</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">bFineMap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bCoarseMap</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarsemapfile</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Fatal_Exception</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">bCoarseMap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bFineMapPristine</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">pristinefinemapfile</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Fatal_Exception</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">bFineMapPristine</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bCoarseMapPristine</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">pristinecoarsemapfile</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Fatal_Exception</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">bCoarseMapPristine</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">outdirectory</span> <span class="o">!=</span> <span class="s">&quot;null&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">bOutputFolder</span> <span class="o">=</span> <span class="n">doesExist</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">outdirectory</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="n">runtime_error</span> <span class="o">&amp;</span><span class="n">re</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Output folder does not exist... creating...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
            <span class="n">bOutputFolder</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">create_directory</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">outdirectory</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">bOutputFolder</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;done!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">re</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_009: FATAL. Output folder cannot be null.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bSampleMask</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">samplemaskfile</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Fatal_Exception</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">bSampleMask</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bFineMap</span> <span class="o">&amp;&amp;</span> <span class="n">bCoarseMap</span> <span class="o">&amp;&amp;</span> <span class="n">bFineMapPristine</span> <span class="o">&amp;&amp;</span> <span class="n">bCoarseMapPristine</span> <span class="o">&amp;&amp;</span> <span class="n">bOutputFolder</span> <span class="o">&amp;&amp;</span> <span class="n">bSampleMask</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Checking folder existance...done!                                                                &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;Required files do not all exist. Check program inputs.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">checkSims</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">checkSims</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">outdirectory</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">the_seed</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">the_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">checkSims</span><span class="p">(</span><span class="n">string</span> <span class="n">output_dir</span><span class="p">,</span> <span class="kt">long</span> <span class="n">seed_in</span><span class="p">,</span> <span class="kt">long</span> <span class="n">task_in</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Checking for unfinished simulations...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">ifstream</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
<span class="c1">//  char file_to_open[100];</span>
<span class="c1">//  sprintf (file_to_open, &quot;%s/Pause/Data_%i.csv&quot;,outdirect,int(the_task));</span>
    <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/Pause/Dump_active_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">task_in</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">to_string</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">seed_in</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
    <span class="n">out</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">good</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;done!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;File found containing unfinished simulations.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bPausedImport</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">setResumeParameters</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">outdirectory</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">outdirectory</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">the_seed</span><span class="p">,</span>
                                <span class="n">sim_parameters</span><span class="p">.</span><span class="n">the_task</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">maxtime</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">bPaused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;done!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No files found containing unfinished simulations.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">bPaused</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setParameters</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">sim_parameters</span><span class="p">.</span><span class="n">printVars</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">varimport</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Set the variables equal to the value from the Mapvars object.</span>
        <span class="n">finemapinput</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">finemapfile</span><span class="p">;</span>
        <span class="n">coarsemapinput</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarsemapfile</span><span class="p">;</span>
        <span class="n">gridxsize</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">vargridxsize</span><span class="p">;</span>
        <span class="n">gridysize</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">vargridysize</span><span class="p">;</span>

        <span class="n">finemapxsize</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapxsize</span><span class="p">;</span>
        <span class="n">finemapysize</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapysize</span><span class="p">;</span>
        <span class="n">finemapxoffset</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapxoffset</span><span class="p">;</span>
        <span class="n">finemapyoffset</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapyoffset</span><span class="p">;</span>

        <span class="n">coarsemapxsize</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varcoarsemapxsize</span><span class="p">;</span>
        <span class="n">coarsemapysize</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varcoarsemapysize</span><span class="p">;</span>
        <span class="n">coarsemapxoffset</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varcoarsemapxoffset</span><span class="p">;</span>
        <span class="n">coarsemapyoffset</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varcoarsemapyoffset</span><span class="p">;</span>
        <span class="n">coarsemapscale</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varcoarsemapscale</span><span class="p">;</span>

        <span class="n">outdirectory</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">outdirectory</span><span class="p">;</span>

        <span class="n">dispersal_relative_cost</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_relative_cost</span><span class="p">;</span>
        <span class="n">the_task</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">the_task</span><span class="p">;</span>
        <span class="n">the_seed</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">the_seed</span><span class="p">;</span>
        <span class="n">desired_specnum</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">desired_specnum</span><span class="p">;</span>

        <span class="c1">// pristine map information</span>
        <span class="n">pristinefinemapinput</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">pristinefinemapfile</span><span class="p">;</span>
        <span class="n">pristinecoarsemapinput</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">pristinecoarsemapfile</span><span class="p">;</span>
        <span class="n">dPristine</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dPristine</span><span class="p">;</span>
        <span class="n">dForestTransform</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dForestChangeRate</span><span class="p">;</span>

        <span class="n">deme</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">deme</span><span class="p">;</span>
        <span class="n">deme_sample</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">deme_sample</span><span class="p">;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">spec</span><span class="p">;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sigma</span><span class="p">;</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">tau</span><span class="p">;</span>
        <span class="n">maxtime</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">maxtime</span><span class="p">;</span>
        <span class="n">autocorrel_file</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">autocorrel_file</span><span class="p">;</span>
        <span class="n">setProtractedVariables</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">min_speciation_gen</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">max_speciation_gen</span><span class="p">);</span>
        <span class="n">varimport</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Main_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_001: Variables already imported.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Tree</span><span class="o">::</span><span class="n">getTemporalSampling</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bAutocorrel</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">autocorrel_times</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="n">tmp</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">importMaps</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">varimport</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Set the dimensions</span>
        <span class="n">forestmap</span><span class="p">.</span><span class="n">setDims</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">);</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// Set the time variables</span>
            <span class="n">forestmap</span><span class="p">.</span><span class="n">checkMapExists</span><span class="p">();</span>
            <span class="c1">// forestmap.setTimeVars(dPristine,dForestTransform);</span>
            <span class="c1">// Import the fine map</span>
            <span class="n">forestmap</span><span class="p">.</span><span class="n">calcFineMap</span><span class="p">();</span>
            <span class="c1">// Import the coarse map</span>
            <span class="n">forestmap</span><span class="p">.</span><span class="n">calcCoarseMap</span><span class="p">();</span>
            <span class="c1">// Calculate the offset for the extremeties of each map</span>
            <span class="n">forestmap</span><span class="p">.</span><span class="n">calcOffset</span><span class="p">();</span>
            <span class="c1">// Import the pristine maps;</span>
            <span class="n">forestmap</span><span class="p">.</span><span class="n">calcPristineFineMap</span><span class="p">();</span>
            <span class="n">forestmap</span><span class="p">.</span><span class="n">calcPristineCoarseMap</span><span class="p">();</span>
            <span class="c1">// Calculate the maximum values</span>
            <span class="n">forestmap</span><span class="p">.</span><span class="n">recalculateForestMax</span><span class="p">();</span>
            <span class="n">rep_map</span><span class="p">.</span><span class="n">import</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">reproduction_file</span><span class="p">,</span>
                           <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapxsize</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapysize</span><span class="p">);</span>
            <span class="n">rep_map</span><span class="p">.</span><span class="n">setOffsets</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">varcoarsemapxoffset</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapyoffset</span><span class="p">,</span>
                               <span class="n">sim_parameters</span><span class="p">.</span><span class="n">vargridxsize</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">vargridysize</span><span class="p">);</span>
            <span class="c1">// Now verify that the reproduction map is always non-zero when the density is non-zero.</span>
            <span class="n">verifyReproductionMap</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="n">Map_Exception</span><span class="o">&amp;</span> <span class="n">me</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;No dimensions set - can&#39;t start simulations&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_002: Variables not imported.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="kt">long</span> <span class="n">Tree</span><span class="o">::</span><span class="n">getSeed</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">the_seed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setSeed</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">theseedin</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">seeded</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">NR</span><span class="p">.</span><span class="n">setSeed</span><span class="p">(</span><span class="n">theseedin</span><span class="p">);</span>
        <span class="n">the_seed</span> <span class="o">=</span> <span class="n">theseedin</span><span class="p">;</span>
        <span class="n">seeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Tree</span><span class="o">::</span><span class="n">getbPaused</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">bPaused</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="kt">long</span><span class="o">&gt;</span> <span class="n">Tree</span><span class="o">::</span><span class="n">randomList</span><span class="p">(</span><span class="kt">long</span> <span class="n">maxnum</span><span class="p">,</span> <span class="kt">long</span> <span class="n">numnum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">long</span><span class="o">&gt;</span> <span class="n">isin</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">long</span><span class="o">&gt;</span> <span class="n">isout</span><span class="p">;</span>
    <span class="n">isin</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">isout</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="kt">long</span> <span class="n">endisout</span> <span class="o">=</span> <span class="n">maxnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">maxnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">isout</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">(</span><span class="n">isin</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&lt;</span> <span class="n">numnum</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="n">chosen</span> <span class="o">=</span> <span class="n">NR</span><span class="p">.</span><span class="n">i0</span><span class="p">(</span><span class="n">endisout</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">isin</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">isout</span><span class="p">[</span><span class="n">chosen</span><span class="p">]);</span>
        <span class="n">isout</span><span class="p">[</span><span class="n">chosen</span><span class="p">]</span> <span class="o">=</span> <span class="n">isout</span><span class="p">[</span><span class="n">endisout</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="n">endisout</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">isin</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setObjectSizes</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">initcount</span><span class="p">;</span>

    <span class="n">samplegrid</span><span class="p">.</span><span class="n">importDatamask</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">);</span>
    <span class="c1">//  os &lt;&lt; &quot;Datamask import complete&quot; &lt;&lt; endl;</span>
    <span class="c1">// Get a count of the number of individuals on the grid.</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">initcount</span> <span class="o">=</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getInitialCount</span><span class="p">(</span><span class="n">deme_sample</span><span class="p">,</span> <span class="n">samplegrid</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">// Set active and data at the correct sizes.</span>
    <span class="k">if</span><span class="p">(</span><span class="n">initcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Initial count is 0. No individuals to simulate. Exiting program.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;Initial count is &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">initcount</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">initcount</span> <span class="o">&gt;</span> <span class="mi">10000000000</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">write_cerr</span><span class="p">(</span><span class="s">&quot;Initial count extremely large, RAM issues likely: &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">initcount</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">active</span><span class="p">.</span><span class="n">SetRowSize</span><span class="p">(</span><span class="n">initcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">data</span><span class="p">.</span><span class="n">SetRowSize</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">initcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="c1">// Make the grid size with 1 entry per deme.</span>
    <span class="c1">// Previous versions used 1 entry per individual for increased spatial movement. However, with percentage cover,</span>
    <span class="c1">// this was now deemed unneccessary.</span>
    <span class="n">grid</span><span class="p">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">gridysize</span><span class="p">,</span> <span class="n">gridxsize</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">initcount</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setupDispersalCoordinator</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setForestMap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">forestmap</span><span class="p">);</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setRandomNumber</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NR</span><span class="p">);</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setGenerationPtr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">generation</span><span class="p">);</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setDispersal</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_method</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_file</span><span class="p">,</span>
                                        <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapxsize</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapysize</span><span class="p">,</span>
                                        <span class="n">sim_parameters</span><span class="p">.</span><span class="n">m_prob</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sigma</span><span class="p">,</span>
                                        <span class="n">sim_parameters</span><span class="p">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">restrict_self</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setup</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*************************************************&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Setting up simulation...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="c1">// deme = square root of Deme size - note deme*deme*number of demes is the total size of the system.  Number of</span>
    <span class="c1">// demes is given by the map scenario</span>
    <span class="c1">// deme_sample = number of individuals to be sampled from each deme (cannot be more than deme^2)</span>
    <span class="c1">// spec = speciation rate required</span>
    <span class="c1">// dispersal = dispersal distance (double)</span>
    <span class="c1">// typeflag = 2 normal</span>
    <span class="c1">// typeflag != 2 fat</span>
    <span class="c1">// sigma = kernel fatness</span>
    <span class="c1">// map_scenario gives the index of the predefined map list vectors that will indicate which habitat map to load</span>
    <span class="c1">// generations_since = number of generations since disturbance at present day of sampling</span>
    <span class="c1">// equilibrium mask = do we ignore the generations_since tag and simply run all the way to equilibrium on the</span>
    <span class="c1">// fragmented landscape?</span>
    <span class="c1">// max time allowed for this simulation (useful for HPC runs)</span>
    <span class="c1">// Set the private variables for the simulation</span>
    <span class="c1">// Start the timer</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bPaused</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bPausedImport</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">setResumeParameters</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">// try to import the resume variables</span>
        <span class="n">simResume</span><span class="p">();</span>
        <span class="n">setupDispersalCoordinator</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// Otherwise, try to read parameters and set up objects.</span>
        <span class="c1">// Use the Mapvars object to import the necessary information</span>
        <span class="n">setParameters</span><span class="p">();</span>
        <span class="c1">// Set the seed</span>
        <span class="n">setSeed</span><span class="p">(</span><span class="n">the_seed</span><span class="p">);</span>
        <span class="c1">// Determine the speciation rates which will be applied after the simulation completes.</span>
        <span class="n">determineSpeciationRates</span><span class="p">();</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">autocorrel_file</span> <span class="o">==</span> <span class="s">&quot;null&quot;</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">bAutocorrel</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// Import the time sample points</span>
                <span class="n">bAutocorrel</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">tmpimport</span><span class="p">;</span>
                <span class="n">ConfigOption</span> <span class="n">tmpconfig</span><span class="p">;</span>
                <span class="n">tmpconfig</span><span class="p">.</span><span class="n">setConfig</span><span class="p">(</span><span class="n">autocorrel_file</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
                <span class="n">tmpconfig</span><span class="p">.</span><span class="n">importConfig</span><span class="p">(</span><span class="n">tmpimport</span><span class="p">);</span>
                <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">i</span> <span class="p">:</span> <span class="n">tmpimport</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">autocorrel_times</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">stod</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                    <span class="c1">//                  os &lt;&lt; &quot;t_i: &quot; &lt;&lt; autocorrel_times[i] &lt;&lt; endl;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="n">Config_Exception</span><span class="o">&amp;</span> <span class="n">ce</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">ce</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Make the mask map with 1 entry in each deme</span>
        <span class="c1">// Previous versions worked with 1 entry per individual.</span>
        <span class="n">importMaps</span><span class="p">();</span>  <span class="c1">// This will import the fine and coarse maps using the routine specified in the Map class.</span>
        <span class="c1">// Set up the dispersal coordinator</span>
        <span class="n">setupDispersalCoordinator</span><span class="p">();</span>
<span class="c1">//      NR.setDispersalMethod(sim_parameters.dispersal_method, sim_parameters.m_prob, sim_parameters.cutoff);</span>
        <span class="n">forestmap</span><span class="p">.</span><span class="n">setLandscape</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">landscape_type</span><span class="p">);</span>
    <span class="cp">#ifdef DEBUG</span>
        <span class="n">forestmap</span><span class="p">.</span><span class="n">validateMaps</span><span class="p">();</span>  <span class="c1">// If you&#39;re having problems with the maps generating errors, run this line to check the</span>
    <span class="cp">#endif</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">initial_count</span> <span class="o">=</span> <span class="n">setObjectSizes</span><span class="p">();</span>
        <span class="c1">// import the grid file</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">number_start</span><span class="p">;</span>
        <span class="n">number_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">endactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">active</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="c1">//      data[0].setSpec(1.0);</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Setting up simulation...filling grid                           &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="c1">// Add the individuals to the grid, and add wrapped individuals to their correct locations.</span>
        <span class="c1">// This loop adds individuals to data and active (for storing the coalescence tree and active lineage tracking)</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsamplexsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsampleysize</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                <span class="kt">long</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">;</span>
                <span class="n">x_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">y_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">samplegrid</span><span class="p">.</span><span class="n">recalculate_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">x_wrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y_wrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stored_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stored_nwrap</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">initialise</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">fillList</span><span class="p">();</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">stored_nwrap</span><span class="p">);</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">stored_next</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="kt">double</span> <span class="n">dSample_amount</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">deme_sample</span> <span class="o">*</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">());</span>
                        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">dSample_amount</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">())</span>
                            <span class="p">{</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">number_start</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">initial_count</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">stringstream</span> <span class="n">msg</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start greater than initial count. Please report this error!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">number_start</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;. Initial count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">initial_count</span>
                                    <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                                <span class="k">throw</span> <span class="nf">out_of_range</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
                            <span class="p">}</span>
                            <span class="k">else</span>
                            <span class="p">{</span>
                                <span class="n">number_start</span><span class="o">++</span><span class="p">;</span>
                                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">listpos</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">number_start</span><span class="p">);</span>
                                <span class="c1">// Add the species to active</span>
                                <span class="n">active</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">number_start</span><span class="p">,</span> <span class="n">listpos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                                <span class="c1">// Add a tip in the Treenode for calculation of the coalescence tree at the</span>
                                <span class="c1">// end of the simulation.</span>
                                <span class="c1">// This also contains the start x and y position of the species.</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
                                <span class="n">endactive</span><span class="o">++</span><span class="p">;</span>
                                <span class="n">enddata</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="kt">double</span> <span class="n">dSample_amount</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">deme_sample</span> <span class="o">*</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">));</span>
                        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">dSample_amount</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">number_start</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">initial_count</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">stringstream</span> <span class="n">msg</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start greater than initial count. Please report this error!&quot;</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">number_start</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;. Initial count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">initial_count</span>
                                    <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                                <span class="k">throw</span> <span class="nf">out_of_range</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
                            <span class="p">}</span>
                            <span class="k">else</span>
                            <span class="p">{</span>
                                <span class="n">number_start</span><span class="o">++</span><span class="p">;</span>
                                <span class="c1">// Add the lineage to the wrapped lineages</span>
                                <span class="n">active</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span>
                                                           <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">y</span><span class="p">,</span>
                                                           <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="n">number_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                                <span class="n">addWrappedLineage</span><span class="p">(</span><span class="n">number_start</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                                <span class="c1">// Add a tip in the Treenode for calculation of the coalescence tree at the</span>
                                <span class="c1">// end of the simulation.</span>
                                <span class="c1">// This also contains the start x and y position of the species.</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">);</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
                                <span class="n">endactive</span><span class="o">++</span><span class="p">;</span>
                                <span class="n">enddata</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">number_start</span> <span class="o">==</span> <span class="n">initial_count</span><span class="p">)</span>  <span class="c1">// Check that the two counting methods match up.</span>
        <span class="p">{</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">initial_count</span> <span class="o">&gt;</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">number_start</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">write_cerr</span><span class="p">(</span><span class="s">&quot;Data usage higher than neccessary - check allocation of individuals to the grid.&quot;</span><span class="p">);</span>
                <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Initial count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">initial_count</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  Number counted: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">number_start</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">write_cerr</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// Now validate all lineages</span>
<span class="cp">#ifdef DEBUG</span>
        <span class="n">validateLineages</span><span class="p">();</span>
<span class="cp">#endif</span>
        <span class="c1">// other variables</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">generation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Setting up simulation...done!                           &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of individuals simulated: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">maxsimsize</span> <span class="o">=</span> <span class="n">enddata</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">endactive</span> <span class="o">||</span> <span class="n">endactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active.size: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;initial_count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">initial_count</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;number_start: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">number_start</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">endactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;No individuals to simulate! Check map set up. Exiting...&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MAIN_007: FATAL. Sizing error - endactive is greater than the size of active.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">startendactive</span> <span class="o">=</span> <span class="n">endactive</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">removeOldPos</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">nwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
    <span class="kt">long</span> <span class="n">oldx</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">();</span>
    <span class="kt">long</span> <span class="n">oldy</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_015: Nwrap not set correctly. Nwrap 0, but x and y wrap not 0. &quot;</span><span class="p">);</span>
        <span class="p">}</span>
<span class="c1">// Then the lineage exists in the main list;</span>
<span class="c1">// debug (can be removed later)</span>
<span class="cp">#ifdef pristine_mode</span>
        <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;grid maxsize: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize. Check move programming function.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="c1">// delete the species from the list</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">deleteSpecies</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">());</span>
        <span class="c1">// clear out the variables.</span>
        <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListpos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>  <span class="c1">// need to loop over the nwrap to check nexts</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">());</span>
            <span class="c1">// Now reduce the nwrap of the lineages that have been effected.</span>
            <span class="kt">long</span> <span class="n">nextpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="c1">// loop over the rest of the list, reducing the nwrap</span>
            <span class="k">while</span><span class="p">(</span><span class="n">nextpos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">active</span><span class="p">[</span><span class="n">nextpos</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
                <span class="n">nextpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">nextpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="c1">// decrease the nwrap</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListpos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">lastpos</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span>
                  <span class="n">chosen</span><span class="p">)</span>  <span class="c1">// loop until we reach the next, then set the next correctly.</span>
            <span class="p">{</span>
                <span class="n">lastpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">lastpos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">());</span>
                <span class="c1">// check</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;lastpos : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">lastpos</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; lastpos nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span>
                         <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; chosen nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span>
                         <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022: nwrap setting of either chosen or the &quot;</span>
                                          <span class="s">&quot;lineage wrapped before chosen. Check move function.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">lastpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">while</span><span class="p">(</span><span class="n">lastpos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
                    <span class="n">lastpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="p">}</span>

            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;lastpos: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">lastpos</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span>
                     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MOVE_024: Last position before chosen is 0 - this is impossible.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListpos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="p">}</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">long</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">iCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">c</span><span class="o">++</span><span class="p">;</span>
                <span class="n">iCount</span><span class="o">++</span><span class="p">;</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//                  os &lt;&lt; pos &lt;&lt; endl;</span>
                    <span class="c1">//                  os &lt;&lt; active[pos].getNext() &lt;&lt; endl;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">iCount</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Counted lineages: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">iCount</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_014: Nwrap not set correctly after move for grid cell&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">calcMove</span><span class="p">(</span><span class="n">Step</span> <span class="o">&amp;</span><span class="n">this_step</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">disperse</span><span class="p">(</span><span class="n">this_step</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">long</span> <span class="kt">double</span> <span class="n">Tree</span><span class="o">::</span><span class="n">calcMinMax</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">current</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// this formula calculates the speciation rate required for speciation to have occured on this branch.</span>
    <span class="c1">// need to allow for the case that the number of gens was 0</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">newminmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">oldminmax</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getMinmax</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">getGenRate</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">newminmax</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">getSpecRate</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// variables need to be defined separately for the decimal division to function properly.</span>
        <span class="kt">long</span> <span class="kt">double</span> <span class="n">tmpdSpec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">getSpecRate</span><span class="p">();</span>
        <span class="kt">long</span> <span class="kt">double</span> <span class="n">tmpiGen</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">getGenRate</span><span class="p">();</span>
        <span class="n">newminmax</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tmpdSpec</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tmpiGen</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">toret</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">newminmax</span><span class="p">,</span> <span class="n">oldminmax</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">toret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">coalescenceEvent</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">coalchosen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// coalescence occured, so we need to adjust the data appropriatedly</span>
    <span class="c1">// our chosen lineage has merged with the coalchosen lineage, so we need to sync up the data.</span>
    <span class="n">enddata</span><span class="o">++</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">(),</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">(),</span>
                        <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">());</span>

    <span class="c1">// First perform the move</span>
    <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setParent</span><span class="p">(</span><span class="n">enddata</span><span class="p">);</span>
    <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setParent</span><span class="p">(</span><span class="n">enddata</span><span class="p">);</span>
    <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">setMinmax</span><span class="p">(</span>
        <span class="n">max</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getMinmax</span><span class="p">(),</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMinmax</span><span class="p">()));</span>  <span class="c1">// set the new minmax to the maximum of the two minimums.</span>
    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setMinmax</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getMinmax</span><span class="p">());</span>
    <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setIGen</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setMpos</span><span class="p">(</span><span class="n">enddata</span><span class="p">);</span>
    <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">setMpos</span><span class="p">(</span><span class="n">enddata</span><span class="p">);</span>
    <span class="c1">//      removeOldPos(chosen);</span>
    <span class="n">switchPositions</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">calcNewPos</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span> <span class="n">coal</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">,</span>
                      <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">coalchosen</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldx</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldy</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldxwrap</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldywrap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Calculate the new position of the move, whilst also calculating the probability of coalescence.</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">oldxwrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">oldywrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Debug check (to remove later)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
                <span class="s">&quot;ERROR_MOVE_006: NON FATAL. Nwrap not set correctly. Check move programming function.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// then the procedure is relatively simple.</span>
        <span class="c1">// check for coalescence</span>
        <span class="c1">// check if the grid needs to be updated.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">!=</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">setMaxsize</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">generation</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">coalchosen</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getRandLineage</span><span class="p">(</span><span class="n">NR</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
        <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldx</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldy</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldxwrap</span> <span class="o">||</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldywrap</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coalchosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen - x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldy</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&quot;x, y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldxwrap</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldywrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;coalchosen - x,y:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; x,y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MOVE_006: NON FATAL. Nwrap not set correctly. Check move programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// then the lineage can be placed in the empty space.</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">tmplistindex</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="c1">// check</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">tmplistindex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">chosen</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_005: Grid index not set correctly for species. Check &quot;</span>
                                      <span class="s">&quot;move programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#ifdef pristine_mode</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getListsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize. Check move programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListpos</span><span class="p">(</span><span class="n">tmplistindex</span><span class="p">);</span>
            <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>  <span class="c1">// then coalescence has occured</span>
        <span class="p">{</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListpos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="c1">// DO THE COALESCENCE STUFF</span>
            <span class="n">coal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>  <span class="c1">// need to check all the possible places the lineage could be.</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">nwrap</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// then coalescence is possible and we need to loop over the nexts to check those that are</span>
        <span class="c1">// in the same position</span>
        <span class="p">{</span>
            <span class="c1">// Count the possible matches of the position.</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// Create an array containing the list of active references for those that match as</span>
            <span class="c1">// this stops us having to loop twice over the same list.</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">matchlist</span><span class="p">[</span><span class="n">nwrap</span><span class="p">];</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_active</span><span class="p">;</span>
            <span class="n">next_active</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="c1">// Count if the first &quot;next&quot; matches</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldxwrap</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldywrap</span><span class="p">)</span>
            <span class="p">{</span>
<span class="c1">// check</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022a: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
                <span class="n">matchlist</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_active</span><span class="p">;</span>  <span class="c1">// add the match to the list of matches.</span>
                <span class="n">matches</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// Now loop over the remaining nexts counting matches</span>
            <span class="c1">//#ifdef DEBUG</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ncount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="c1">//#endif</span>
            <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">next_active</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldxwrap</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldywrap</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">matchlist</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_active</span><span class="p">;</span>
                    <span class="n">matches</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// check</span>
                <span class="c1">//#ifdef DEBUG</span>
                <span class="n">ncount</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ncount</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022d: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="n">ncount</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022c: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Matches now contains the number of lineages at the exact x,y, xwrap and ywrap position.</span>
            <span class="c1">// Check if there were no matches at all</span>
            <span class="k">if</span><span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">coalchosen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
                <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">());</span>
                <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListpos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>  <span class="c1">// if there were matches, generate a random number to see if coalescence occured or not</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">randwrap</span> <span class="o">=</span>
                    <span class="n">floor</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="c1">// Get the random reference from the match list.</span>
<span class="c1">// If the movement is to an empty space, then we can update the chain to include the new</span>
<span class="c1">// lineage.</span>
<span class="cp">#ifdef pristine_mode</span>
                <span class="k">if</span><span class="p">(</span><span class="n">randwrap</span> <span class="o">&gt;</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
                        <span class="s">&quot;ERROR_MOVE_004: Randpos outside maxsize. Check move programming function&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">matches</span> <span class="o">&gt;</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;matches: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">matches</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                         <span class="o">&lt;&lt;</span> <span class="s">&quot;forestmap value: &quot;</span>
                         <span class="o">&lt;&lt;</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">);</span>
                    <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span>
                        <span class="s">&quot;ERROR_MOVE_004: matches outside maxsize. Check move programming function&quot;</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
                <span class="k">if</span><span class="p">(</span><span class="n">randwrap</span> <span class="o">&gt;</span> <span class="n">matches</span><span class="p">)</span>  <span class="c1">// coalescence has not occured</span>
                <span class="p">{</span>
                    <span class="c1">// os &lt;&lt; &quot;This shouldn&#39;t happen&quot; &lt;&lt; endl;</span>
                    <span class="n">coalchosen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">());</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListpos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>  <span class="c1">// coalescence has occured</span>
                <span class="p">{</span>
                    <span class="n">coal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="n">coalchosen</span> <span class="o">=</span> <span class="n">matchlist</span><span class="p">[</span><span class="n">randwrap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setEndpoint</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
                            <span class="s">&quot;ERROR_MOVE_025: Coalescence attempted with lineage of 0.&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
<span class="cp">#ifdef pristine_mode</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize. Check move programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="p">}</span>
        <span class="k">else</span>  <span class="c1">// just add the lineage to next.</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_026: No nwrap recorded, but next is non-zero.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">coalchosen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="c1">//              if(chosen==3893119)</span>
            <span class="c1">//              {</span>
            <span class="c1">//                  validationCheck(31556348,12,chosen);</span>
            <span class="c1">//                  os &lt;&lt; &quot;test1...&quot; &lt;&lt; endl;</span>
            <span class="c1">//              }</span>
            <span class="c1">//              debug_504(chosen,12);</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
<span class="c1">// check</span>
<span class="cp">#ifdef DEBUG</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022b: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="c1">//              debug_504(chosen,11);</span>
            <span class="c1">//              if(chosen==3893119)</span>
            <span class="c1">//              {</span>
            <span class="c1">//                  validationCheck(31556348,13,chosen);</span>
            <span class="c1">//                  os &lt;&lt; &quot;test2...&quot; &lt;&lt; endl;</span>
            <span class="c1">//              }</span>
        <span class="p">}</span>
        <span class="c1">//#ifdef DEBUG</span>
        <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldx</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldy</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldxwrap</span> <span class="o">||</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldywrap</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coalchosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen - x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldy</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&quot;x, y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldxwrap</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">oldywrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;coalchosen - x,y:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; x,y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_006b: NON FATAL. Nwrap not set correctly. Check move &quot;</span>
                                      <span class="s">&quot;programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//#endif</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">switchPositions</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chosen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">chosen</span> <span class="o">&gt;</span> <span class="n">endactive</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_023: Chosen is greater than endactive. Check move function.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">chosen</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// This routine assumes that the previous chosen position has already been deleted.</span>
        <span class="n">Datapoint</span> <span class="n">tmpdatactive</span><span class="p">;</span>
        <span class="n">tmpdatactive</span><span class="p">.</span><span class="n">setup</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">]);</span>
        <span class="c1">// now need to remove the chosen lineage from memory, by replacing it with the lineage that lies in the last</span>
        <span class="c1">// place.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
           <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// if the end lineage is simple, we can just copy it across.</span>
        <span class="p">{</span>
            <span class="c1">// check endactive</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_020: NON FATAL. Nwrap is not set correctly for endactive (nwrap should &quot;</span>
                        <span class="s">&quot;be 0, but is &quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ). Identified during switch of positions.&quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setSpecies</span><span class="p">(</span>
                <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getListpos</span><span class="p">(),</span> <span class="n">chosen</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">]);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">tmpdatactive</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>  <span class="c1">// else the end lineage is wrapped, and needs to be processed including the wrapping routines.</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_021: NON FATAL. Nwrap is not set correctly for endactive (nwrap &quot;</span>
                        <span class="s">&quot;incorrectly 0). Identified during switch of positions.&quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//              os &lt;&lt; &quot;wrap&quot;&lt;&lt;endl;</span>
            <span class="kt">long</span> <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="kt">int</span> <span class="n">tmpnwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>

            <span class="c1">// if the wrapping is just once, we need to set the grid next to the chosen variable.</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmpnwrap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// check</span>
                <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="n">string</span><span class="p">(</span>
                        <span class="s">&quot;ERROR_MOVE_019: FATAL. Nwrap for endactive not set correctly. Nwrap is 1, but &quot;</span>
                        <span class="s">&quot;lineage at 1st position is &quot;</span> <span class="o">+</span>
                        <span class="n">to_string</span><span class="p">(</span>
                            <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()]</span>
                                <span class="p">.</span><span class="n">getNext</span><span class="p">())</span> <span class="o">+</span>
                        <span class="s">&quot;. Identified during the move.&quot;</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>  <span class="c1">// otherwise, we just set the next to chosen instead of endactive.</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">tmpcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="c1">// loop over nexts until we reach the right lineage.</span>
                <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                    <span class="n">tmpcount</span><span class="o">++</span><span class="p">;</span>
                    <span class="c1">// debug check</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">tmpcount</span> <span class="o">&gt;</span> <span class="n">tmpnwrap</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_013: NON FATAL. Looping has not encountered a match, &quot;</span>
                                <span class="s">&quot;despite going further than required. Check nwrap counting.&quot;</span>
                             <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">tmpactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;gridnext: &quot;</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">]</span>
                                                                          <span class="p">.</span><span class="n">getXpos</span><span class="p">()]</span>
                                        <span class="p">.</span><span class="n">getNext</span><span class="p">()</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;xwrap,ywrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmpactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmpnwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpnwrap</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; tmpcount: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpcount</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;FATAL!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">]);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">tmpdatactive</span><span class="p">);</span>

            <span class="c1">// check - debugging</span>
            <span class="kt">long</span> <span class="n">testwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">testnext</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">testwrap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">testnext</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">testnext</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="n">testnext</span> <span class="o">!=</span> <span class="n">chosen</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_009: Nwrap position not set correctly after coalescence. &quot;</span>
                                      <span class="s">&quot;Check move process.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">endactive</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">speciation</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// alter the data such that it reflects the speciation event.</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpmpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">();</span>
<span class="c1">// data[tmpmpos].increaseGen();</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="c1">// Store debug information in DEBUG mode</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">location</span> <span class="o">=</span> <span class="s">&quot;speciation&quot;</span><span class="p">;</span>
    <span class="n">logfile</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SPECIATION&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">tmpmpos</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_028: Attempting to speciate a speciated species.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="n">data</span><span class="p">[</span><span class="n">tmpmpos</span><span class="p">].</span><span class="n">speciate</span><span class="p">();</span>
    <span class="c1">// TEST REMOVE THIS WHEN TESTING COMPLETE!! done</span>
    <span class="c1">//      data[tmpmpos].setPosition(active[chosen].getXpos(),active[chosen].getYpos(),active[chosen].getXwrap(),active[chosen].getYwrap());</span>
    <span class="c1">// Now remove the old chosen lineage from the active directory.</span>
    <span class="n">removeOldPos</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
    <span class="n">switchPositions</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Tree</span><span class="o">::</span><span class="n">calcSpeciation</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">random_number</span><span class="p">,</span>
                          <span class="k">const</span> <span class="kt">long</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">speciation_rate</span><span class="p">,</span>
                          <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">no_generations</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">checkSpeciation</span><span class="p">(</span><span class="n">random_number</span><span class="p">,</span> <span class="n">speciation_rate</span><span class="p">,</span> <span class="n">no_generations</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Tree</span><span class="o">::</span><span class="n">estSpecnum</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// This bit has been removed as it has a very significant performance hit and is not required for most simulations.</span>
    <span class="c1">// As of version 3.2 it was fully compatible with the rest of the simulation, however. See estSpecnum for commented</span>
    <span class="c1">// code</span>
    <span class="c1">// (removed from here to make things tidier).</span>
    <span class="c1">// This bit was moved from runSimulation() to make things tidier there.</span>
    <span class="cm">/*</span>
<span class="cm">    if(steps%1000000==0)</span>
<span class="cm">{</span>
<span class="cm">            time(&amp;now);</span>
<span class="cm">            if(now - time_taken&gt;200&amp;&amp;dPercentComplete&gt;95)</span>
<span class="cm">            {</span>
<span class="cm">                            time(&amp;time_taken);</span>
<span class="cm">                            unsigned long specnum = est_specnum();</span>
<span class="cm">                            os &lt;&lt; &quot;Estimated number of species: &quot; &lt;&lt; specnum &lt;&lt;</span>
<span class="cm">                            flush;</span>
<span class="cm">                            if(specnum&lt;desired_specnum)</span>
<span class="cm">                            {</span>
<span class="cm">                                            os &lt;&lt; &quot; - desired</span>
<span class="cm">                                            number of species reached.&quot; &lt;&lt; endl &lt;&lt; &quot;Halting</span>
<span class="cm">                                            simulations...&quot; &lt;&lt; endl;</span>
<span class="cm">                                            bContinueSim = false;</span>
<span class="cm">                            }</span>
<span class="cm">                            else</span>
<span class="cm">                            {</span>
<span class="cm">                                            os &lt;&lt; endl;</span>
<span class="cm">                            }</span>
<span class="cm">            }</span>
<span class="cm">}</span>
<span class="cm">//*/</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">dMinmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// first loop to find the maximum speciation rate required</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="kt">double</span> <span class="n">tmpminmax</span> <span class="o">=</span> <span class="n">calcMinMax</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setMinmax</span><span class="p">(</span><span class="n">tmpminmax</span><span class="p">);</span>
        <span class="n">dMinmax</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">max</span><span class="p">(</span><span class="n">dMinmax</span><span class="p">,</span> <span class="n">tmpminmax</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isTip</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setExistance</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">maxret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getGenRate</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">maxret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">maxret</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getGenRate</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">// This is the line that compares the individual random numbers against the speciation rate.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getSpecRate</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pow</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dMinmax</span><span class="p">),</span> <span class="n">maxret</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speciate</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">loop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getExistance</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getParent</span><span class="p">()].</span><span class="n">getExistance</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getParent</span><span class="p">()].</span><span class="n">setExistance</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iSpecies</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getExistance</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">iSpecies</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qReset</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//      os &lt;&lt; &quot;Estimated species number is: &quot; &lt;&lt; iSpecies &lt;&lt; endl;</span>
    <span class="k">return</span> <span class="n">iSpecies</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">runChecks</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">coalchosen</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">// final checks</span>
<span class="cp">#ifdef pristine_mode</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
       <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//              usleep(1);</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;listpos: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span>
             <span class="o">&lt;&lt;</span> <span class="s">&quot; maxsize: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span> <span class="o">&gt;</span>
           <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
       <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">coalchosen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//              usleep(1);</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_002: Coalchosen listpos outside maxsize.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">lastactive</span> <span class="o">=</span> <span class="n">tmpactive</span><span class="p">;</span>
            <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmpactive</span> <span class="o">!=</span> <span class="n">chosen</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;gridnwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">()</span>
                 <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active x,y&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;wrap x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmpactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpactive</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span>
                 <span class="o">&lt;&lt;</span> <span class="s">&quot; chosennext: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;lastactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">lastactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_003: Nwrap not set correctly.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_10: Nwrap set to non-zero, but x and y wrap 0.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lineage at 1st position: &quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span>
                     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_016: Nwrap for endactive not set correctly. Nwrap is 1, &quot;</span>
                                      <span class="s">&quot;but the lineage at 1st position is not endactive.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpcheck</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpnwrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="n">tmpcheck</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">tmpnwrap</span><span class="o">++</span><span class="p">;</span>
                <span class="n">tmpcheck</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmpcheck</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">tmpnwrap</span> <span class="o">&gt;</span> <span class="n">nwrap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_017: NON FATAL. Nrap for endactive not set correctly; looped &quot;</span>
                            <span class="s">&quot;beyond nwrap and not yet found enactive.&quot;</span>
                         <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                         <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                         <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span>
                         <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmpnwrap</span> <span class="o">!=</span> <span class="n">nwrap</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_018: NON FATAL. Nwrap for endactive not set correctly. Nwrap is &quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; but endactive is at position &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpnwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span>
                     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">validationCheck</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">o</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">current</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span><span class="o">&amp;</span> <span class="n">coal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// if(active[chosen].getNwrap()!=0||chosen&gt;endactive)</span>
    <span class="c1">//{</span>
    <span class="c1">//  return;</span>
    <span class="c1">//}</span>
    <span class="c1">//      os &lt;&lt; &quot;check...&quot; &lt;&lt; endl;</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
       <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//              usleep(1);</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;listpos: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span>
           <span class="o">&lt;&lt;</span> <span class="s">&quot; maxsize: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;VALIDATION_001: Listpos outside maxsize.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;VALIDATION_001: Listpos outside maxsize.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">coal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">hasSpeciated</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
       <span class="n">chosen</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()))</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;gridnwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;wrap x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; chosennext: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;listpos: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;lineage at pos &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">())</span>
           <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;o: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">o</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;current chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">current</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;VALIDATION_003: Listpos not set correctly.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//              os &lt;&lt; &quot;nwrap1: &quot; &lt;&lt; active[chosen].getNwrap() &lt;&lt; endl;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">lastactive</span> <span class="o">=</span> <span class="n">tmpactive</span><span class="p">;</span>
            <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmpactive</span> <span class="o">!=</span> <span class="n">chosen</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;gridnwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="c1">//              os &lt;&lt; &quot;speccounter: &quot; &lt;&lt; spec_counter &lt;&lt; endl;</span>
            <span class="c1">//              os &lt;&lt; &quot;startnwrap: &quot; &lt;&lt; startnwrap &lt;&lt; endl;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="c1">//              os &lt;&lt; &quot;start x,y: &quot; &lt;&lt; startx &lt;&lt; &quot;,&quot; &lt;&lt; starty &lt;&lt; endl;</span>
            <span class="c1">//              os &lt;&lt; &quot;end x,y: &quot; &lt;&lt; oldx &lt;&lt; &quot;,&quot; &lt;&lt; oldy &lt;&lt; endl;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;wrap x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmpactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpactive</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span>
               <span class="o">&lt;&lt;</span> <span class="s">&quot; chosennext: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;lastactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">lastactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;VALIDATION_002: Nwrap not set correctly.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;o: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">o</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;current chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">current</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;VALIDATION_001: Listpos outside maxsize.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">checkSimSize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_active</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//      os &lt;&lt; &quot;Started change size&quot; &lt;&lt; endl;</span>
    <span class="c1">// need to be triple the size of the maximum number of individuals plus enddata</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">req_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">enddata</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_active</span> <span class="o">=</span> <span class="n">endactive</span> <span class="o">+</span> <span class="n">req_active</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">min_data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// change the size of data</span>
        <span class="n">data</span><span class="p">.</span><span class="n">changeSize</span><span class="p">(</span><span class="n">min_data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">min_active</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// change the size of active.</span>
        <span class="n">active</span><span class="p">.</span><span class="n">changeSize</span><span class="p">(</span><span class="n">min_active</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//      os &lt;&lt; &quot;finished change size&quot; &lt;&lt; endl;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">writeSimStartToConsole</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// now do the calculations required to build the tree</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*************************************************&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning simulations...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

    <span class="c1">//      double current_gen =0;</span>
    <span class="c1">// check time</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_start</span><span class="p">);</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_end</span><span class="p">);</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setSimStartVariables</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">bContinueSim</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bAutocorrel</span> <span class="o">&amp;&amp;</span> <span class="n">generation</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">autocorrel_times</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">autocorrel_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">generation</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef verbose</span>
<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">writeStepToConsole</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">steps</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_end</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sim_end</span> <span class="o">-</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="o">&amp;&amp;</span> <span class="n">log_all</span><span class="p">)</span>  <span class="c1">// output every 0.2 seconds</span>
        <span class="p">{</span>
            <span class="kt">double</span> <span class="n">dPercentComplete</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="kt">double</span><span class="p">(</span><span class="n">endactive</span><span class="p">)</span> <span class="o">/</span> <span class="kt">double</span><span class="p">(</span><span class="n">startendactive</span><span class="p">)));</span>
            <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">number_printed</span> <span class="o">&lt;</span> <span class="n">dPercentComplete</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Beginning simulations...&quot;</span><span class="p">;</span>
                <span class="n">this_step</span><span class="p">.</span><span class="n">number_printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">while</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">number_printed</span> <span class="o">&lt;</span> <span class="n">dPercentComplete</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span><span class="p">;</span>

                    <span class="n">this_step</span><span class="p">.</span><span class="n">number_printed</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
                <span class="c1">//                  cout &lt;&lt; os.str() &lt;&lt; endl;</span>
                <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">logfile</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;STEP &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">steps</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">logfile</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">logfile</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;STARTPOS: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef pristine_mode</span>
<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">pristineStepChecks</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; xwrap, ywrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;listsize: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">][</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">].</span><span class="n">getListsize</span><span class="p">()</span>
             <span class="o">&lt;&lt;</span> <span class="s">&quot;maxsize: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">][</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span>
            <span class="n">string</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_008: Dispersal attempted from non-forest. Check dispersal function. Forest &quot;</span>
                   <span class="s">&quot;cover: &quot;</span> <span class="o">+</span>
                   <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span>
                                                         <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">checkMapUpdate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bAutocorrel</span> <span class="o">&amp;&amp;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span> <span class="o">&lt;</span> <span class="n">autocorrel_times</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">// check if we need to update</span>
        <span class="k">if</span><span class="p">(</span><span class="n">autocorrel_times</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">generation</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//                  os &lt;&lt; &quot;check2&quot; &lt;&lt; endl;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">autocorrel_times</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;expanding map at generation &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">generation</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">expandMap</span><span class="p">(</span><span class="n">autocorrel_times</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span><span class="p">]);</span>
                <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">chooseRandomLineage</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">steps</span><span class="o">++</span><span class="p">;</span>
    <span class="c1">// increment generation counter</span>
    <span class="n">generation</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">(</span><span class="n">endactive</span><span class="p">));</span>
    <span class="n">forestmap</span><span class="p">.</span><span class="n">updateMap</span><span class="p">(</span><span class="n">generation</span><span class="p">);</span>
    <span class="n">checkMapUpdate</span><span class="p">();</span>
    <span class="c1">// check if the map is pristine yet</span>
    <span class="n">forestmap</span><span class="p">.</span><span class="n">checkPristine</span><span class="p">(</span><span class="n">generation</span><span class="p">);</span>
    <span class="c1">// choose a random lineage to die and be reborn out of those currently active</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span> <span class="o">=</span> <span class="n">NR</span><span class="p">.</span><span class="n">i0</span><span class="p">(</span><span class="n">endactive</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// cannot be 0</span>
    <span class="c1">// Rejection sample based on reproductive potential</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">rep_map</span><span class="p">.</span><span class="n">hasReproduced</span><span class="p">(</span><span class="n">NR</span><span class="p">,</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">(),</span>
                                 <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">(),</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()))</span>
    <span class="p">{</span>
        <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span> <span class="o">=</span> <span class="n">NR</span><span class="p">.</span><span class="n">i0</span><span class="p">(</span><span class="n">endactive</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// cannot be 0</span>
    <span class="p">}</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// record old position of lineage</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">();</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">();</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">();</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">();</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">debugCoalescence</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">logfile</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;COALESCENCE&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">location</span> <span class="o">=</span> <span class="s">&quot;coalescence: coalchosen - &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">!=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">||</span>
       <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">!=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">||</span>
       <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">||</span>
       <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen - x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span>
             <span class="o">&lt;&lt;</span> <span class="n">endl</span>
             <span class="o">&lt;&lt;</span> <span class="s">&quot;x, y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">();</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;coalchosen - x,y:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; x,y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_006: NON FATAL. Nwrap not set &quot;</span>
                              <span class="s">&quot;correctly. Check move programming &quot;</span>
                              <span class="s">&quot;function.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span> <span class="o">||</span>
       <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span> <span class="o">||</span>
       <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span> <span class="o">||</span>
       <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen - x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
             <span class="o">&lt;&lt;</span> <span class="s">&quot;x, y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;coalchosen - x,y:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; x,y wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_006: NON FATAL. Nwrap not set &quot;</span>
                              <span class="s">&quot;correctly. Check move programming &quot;</span>
                              <span class="s">&quot;function.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">debugDispersal</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
            <span class="n">string</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_007: Dispersal attempted to non-forest. &quot;</span>
                   <span class="s">&quot;Check dispersal function. Forest cover: &quot;</span> <span class="o">+</span>
                   <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span>
                                                         <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">debugEndStep</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">logfile</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ENDPOS: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">logfile</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;mpos: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">validationCheck</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">coal</span><span class="p">);</span>  <span class="c1">// this can probably be removed now</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Fatal_Exception</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Location tag: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">runChecks</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">);</span>
        <span class="c1">// runs the debug every 10,000 time steps</span>
        <span class="k">if</span><span class="p">(</span><span class="n">steps</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">runChecks</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Fatal_Exception</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dumping data file...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">sqlCreate</span><span class="p">();</span>
<span class="cp">#ifdef sql_ram</span>
        <span class="n">sqlOutput</span><span class="p">();</span>
<span class="cp">#endif</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;done!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">bool</span> <span class="n">Tree</span><span class="o">::</span><span class="n">runSimulation</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">writeSimStartToConsole</span><span class="p">();</span>

<span class="cp">#ifdef DEBUG</span>
    <span class="n">string</span> <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">outdirectory</span> <span class="o">+</span> <span class="s">&quot;/Logfile_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.log&quot;</span><span class="p">;</span>
    <span class="n">logfile</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="cp">#endif</span>
    <span class="c1">// Main while loop to process while there is still time left and the simulation is not complete.</span>
    <span class="c1">// Ensure that the step object contains no data.</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">wipeData</span><span class="p">();</span>
    <span class="c1">// Create the move object</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">chooseRandomLineage</span><span class="p">();</span>
<span class="cp">#ifdef verbose</span>
        <span class="n">writeStepToConsole</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef pristine_mode</span>
        <span class="n">pristineStepChecks</span><span class="p">();</span>
<span class="cp">#endif</span>
        <span class="c1">// See estSpecnum for removed code.</span>
        <span class="c1">// Check that we still want to continue the simulation.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">bContinueSim</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// os &lt;&lt; &quot;check1&quot; &lt;&lt; endl;</span>
            <span class="n">this_step</span><span class="p">.</span><span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="c1">// increase the counter of the number of moves (or generations) the lineage has undergone.</span>
            <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">increaseGen</span><span class="p">();</span>
            <span class="c1">// Check if speciation happens</span>
            <span class="k">if</span><span class="p">(</span><span class="n">checkSpeciation</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">getSpecRate</span><span class="p">(),</span> <span class="mf">0.99999</span><span class="o">*</span><span class="n">spec</span><span class="p">,</span>
                               <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">getGenRate</span><span class="p">()))</span>
            <span class="p">{</span>
                <span class="n">speciation</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="n">this_step</span><span class="p">.</span><span class="n">location</span> <span class="o">=</span> <span class="s">&quot;standard: oldpos &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">);</span>
<span class="cp">#endif</span>
                <span class="c1">// remove the species data from the species list to be placed somewhere new.</span>
                <span class="n">removeOldPos</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">);</span>
                <span class="n">calcMove</span><span class="p">(</span><span class="n">this_step</span><span class="p">);</span>
                <span class="c1">// Calculate the new position, perform the move if coalescence doesn&#39;t occur or</span>
                <span class="c1">// return the variables for the coalescence event if coalescence does occur.</span>
                <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">setEndpoint</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span>
                                                     <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span>
                                                     <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">);</span>  <span class="c1">// the &quot;old&quot; variables</span>
                <span class="c1">// have been updated, so we can just input them back in to the function.</span>
                <span class="n">calcNewPos</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">coal</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span>
                           <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">);</span>
                <span class="c1">// coalescence occured, so we need to adjust the data appropriatedly</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">coal</span><span class="p">)</span>
                <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
                    <span class="c1">// This is only required if we are running in debug mode.</span>
                    <span class="n">debugCoalescence</span><span class="p">();</span>
<span class="cp">#endif</span>
                    <span class="n">coalescenceEvent</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="k">else</span>  <span class="c1">// debugging only now as the move process has been incorportated into</span>
                <span class="p">{</span>
                    <span class="c1">// for debugging only</span>
                    <span class="n">debugDispersal</span><span class="p">();</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="p">}</span>
        <span class="p">}</span>


<span class="cp">#ifdef DEBUG</span>
        <span class="n">debugEndStep</span><span class="p">();</span>
<span class="cp">#endif</span>
        <span class="k">if</span><span class="p">(</span><span class="n">bAutocorrel</span> <span class="o">&amp;&amp;</span> <span class="n">endactive</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Check whether we need to continue simulating at a later time.</span>
            <span class="k">if</span><span class="p">(</span><span class="n">autocorrel_times</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">generation</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Then we need to expand the map</span>
                <span class="c1">// This is a hack, I know it&#39;s a hack and is wrong, and I aint gonna change it :)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setSpec</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
                <span class="c1">// First speciate the remaining lineage</span>
                <span class="n">speciation</span><span class="p">(</span><span class="n">endactive</span><span class="p">);</span>
                <span class="n">generation</span> <span class="o">=</span> <span class="n">autocorrel_times</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">iAutoComplete</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.000000000001</span><span class="p">;</span>
                <span class="n">checkMapUpdate</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">endactive</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// TODO fix this to account for potential speciation of the remaining lineage!</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">||</span> <span class="p">((</span><span class="n">endactive</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">difftime</span><span class="p">(</span><span class="n">sim_end</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxtime</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">bContinueSim</span><span class="p">));</span>
<span class="c1">// If the simulations finish correctly, output the completed data.</span>
<span class="c1">// Otherwise, pause the simulation and save objects to file.</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">logfile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="nf">stopSimulation</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Tree</span><span class="o">::</span><span class="n">stopSimulation</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">endactive</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_finish</span><span class="p">);</span>
        <span class="n">time_taken</span> <span class="o">+=</span> <span class="n">sim_finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
        <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;........out of time!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="c1">//          os &lt;&lt; &quot;Time taken: &quot; &lt;&lt; time_taken &lt;&lt; endl;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Pausing simulation: add extra time or re-run to ensure simulation completion.&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lineages remaining: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">simPause</span><span class="p">();</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">speciate</span><span class="p">();</span>
            <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setSpec</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">sim_complete</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_finish</span><span class="p">);</span>
        <span class="n">time_taken</span> <span class="o">+=</span> <span class="n">sim_finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">this_step</span><span class="p">.</span><span class="n">bContinueSim</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;done - desired number of species achieved!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">expandMap</span><span class="p">(</span><span class="kt">double</span> <span class="n">generationin</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// First loop over the grid to check for the number that needs to be added to active</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">added_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">added_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsamplexsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsampleysize</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="kt">long</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">;</span>
            <span class="n">xwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ywrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">samplegrid</span><span class="p">.</span><span class="n">recalculate_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span> <span class="o">=</span> <span class="n">countCellExpansion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generationin</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
                <span class="n">added_data</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">deme_sample</span> <span class="o">*</span>
                        <span class="kt">double</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generationin</span><span class="p">)))</span> <span class="o">-</span> <span class="n">num_to_add</span><span class="p">;</span>
                <span class="n">added_active</span> <span class="o">+=</span> <span class="n">num_to_add</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">added_data</span> <span class="o">+=</span> <span class="n">added_active</span><span class="p">;</span>
    <span class="c1">// now resize data and active if necessary</span>
    <span class="n">checkSimSize</span><span class="p">(</span><span class="n">added_data</span><span class="p">,</span> <span class="n">added_active</span><span class="p">);</span>
    <span class="c1">// Add the new lineages and modify the existing lineages within our sample area</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsamplexsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsampleysize</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="kt">long</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">;</span>
            <span class="n">xwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ywrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">samplegrid</span><span class="p">.</span><span class="n">recalculate_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">// Count the number of new cells that we need to add (after making those that already exist into tips)</span>
                <span class="c1">// Note that this function won&#39;t make more tips than the proportion we are sampling</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span> <span class="o">=</span> <span class="n">countCellExpansion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generationin</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
                <span class="n">expandCell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generationin</span><span class="p">,</span> <span class="n">num_to_add</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// double check sizes</span>
    <span class="k">if</span><span class="p">(</span><span class="n">enddata</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="n">endactive</span> <span class="o">&gt;=</span> <span class="n">active</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_012: FATAL. Enddata or endactive is greater than the size of the &quot;</span>
                              <span class="s">&quot;relevant object. Programming error likely.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">endactive</span> <span class="o">&gt;</span> <span class="n">startendactive</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">startendactive</span> <span class="o">=</span> <span class="n">endactive</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">validateLineages</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Tree</span><span class="o">::</span><span class="n">sortData</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Sort and process the species list so that the useful information can be extracted from it.</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Finalising data...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="c1">// coalescence finished - process speciation</span>
    <span class="c1">// check the data structure</span>
    <span class="k">if</span><span class="p">(</span><span class="n">enddata</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;enddata: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">enddata</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;data.size(): &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;Enddata greater than data size. Programming error likely.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Now make sure those left in endactive will definitely speciate.</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check</span>
        <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setSpec</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Double check speciation events have been counted.</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spec_up_to</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">checkSpeciation</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getSpecRate</span><span class="p">(),</span> <span class="n">spec</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getGenRate</span><span class="p">()))</span>
        <span class="p">{</span>
            <span class="n">spec_up_to</span><span class="o">++</span><span class="p">;</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speciate</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// os &lt;&lt; &quot;Precount1: &quot; &lt;&lt; lineages.countSpecies() &lt;&lt; endl;</span>
    <span class="c1">// lineages.resetTree();</span>
    <span class="c1">// Calculates the lineage data for the minimum speciation rate. // removed this process as output data is not</span>
    <span class="c1">// required to be as a calculated tree.</span>
    <span class="c1">// unsigned long spec_up_to = 1;</span>
    <span class="c1">// disabled checks...</span>
    <span class="c1">// here we check the data is valid - only required for debugging</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">()))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getParent</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getExistance</span><span class="p">()))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Main_Exception</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_004: &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span>
                                            <span class="s">&quot; has not speciated and parent is 0.&quot;</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isTip</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">(),</span>
                                                     <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()))</span>
            <span class="p">{</span>
                <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MAIN_014: Tip assignment error. Samplemask is not correctly assigning tips. &quot;</span>
                        <span class="s">&quot;Check samplemask programming.&quot;</span>
                     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// here we check the data is valid - alternative validity check.</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getExistance</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">()))</span>
                <span class="p">{</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">getParent</span><span class="p">();</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">throw</span> <span class="n">Main_Exception</span><span class="p">(</span>
                            <span class="s">&quot;ERROR_MAIN_005:0 found in parent while following speciation trail.&quot;</span><span class="p">);</span>
                        <span class="c1">// string james;</span>
                        <span class="c1">// cin &gt;&gt; james;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Main_Exception</span><span class="o">&amp;</span> <span class="n">me</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">me</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Returning max possible size (may cause RAM issues).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">spec_up_to</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">outputData</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">species_richness</span> <span class="o">=</span> <span class="n">sortData</span><span class="p">();</span>
    <span class="n">outputData</span><span class="p">(</span><span class="n">species_richness</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">outputData</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">species_richness</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Run the data sorting functions and output the data into the correct format.</span>
    <span class="c1">// sort the data</span>
    <span class="c1">//          bool loopon;</span>
    <span class="c1">// Write the data to the first file</span>
    <span class="c1">// species richness data</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Writing results to file...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">ofstream</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">out</span><span class="p">.</span><span class="n">precision</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">string</span> <span class="n">filename_ab</span><span class="p">;</span>
    <span class="c1">// sprintf (filename_ab, &quot;%s/Data_%i.csv&quot;,outdirectory, int(the_task)); // altered in v3.0</span>
    <span class="n">filename_ab</span> <span class="o">=</span> <span class="n">outdirectory</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/Data_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                  <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
    <span class="n">out</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename_ab</span><span class="p">);</span>
    <span class="c1">// Simulation fixed variables</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;random_seed=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">the_seed</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;fine map=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">finemapinput</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;fine map x y,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">finemapxsize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">finemapysize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;coarse map=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapinput</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;coarse map x y,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapxsize</span> <span class="o">*</span> <span class="n">deme</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapysize</span> <span class="o">*</span> <span class="n">deme</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;deme=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">deme</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;deme_sample=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">deme_sample</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;spec=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">spec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sigma=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sigma</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;maxtime=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">maxtime</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;species_richness=,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">species_richness</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">out</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;done!              &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_finish</span><span class="p">);</span>
<span class="cp">#ifdef sql_ram</span>
    <span class="n">sqlOutput</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_end</span><span class="p">);</span>
    <span class="n">writeTimes</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">writeTimes</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Total generations simulated (steps): &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">generation</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">steps</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Count dispersal, density fails: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">count_dispersal_fails</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">count_density_fails</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Setup time was &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">floor</span><span class="p">((</span><span class="n">sim_start</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; minutes &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sim_start</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; seconds&quot;</span>
       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Simulation time was &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">floor</span><span class="p">((</span><span class="n">sim_finish</span> <span class="o">-</span> <span class="n">sim_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; hours &quot;</span>
       <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">floor</span><span class="p">((</span><span class="n">sim_finish</span> <span class="o">-</span> <span class="n">sim_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">floor</span><span class="p">((</span><span class="n">sim_finish</span> <span class="o">-</span> <span class="n">sim_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; minutes &quot;</span>
       <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sim_finish</span> <span class="o">-</span> <span class="n">sim_start</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; seconds&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;File output and species calculation time was &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">floor</span><span class="p">((</span><span class="n">out_finish</span> <span class="o">-</span> <span class="n">sim_finish</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; minutes &quot;</span>
       <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">out_finish</span> <span class="o">-</span> <span class="n">sim_finish</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; seconds&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SQL output time was &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">floor</span><span class="p">((</span><span class="n">sim_end</span> <span class="o">-</span> <span class="n">out_finish</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; minutes &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sim_end</span> <span class="o">-</span> <span class="n">out_finish</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span>
       <span class="o">&lt;&lt;</span> <span class="s">&quot; seconds&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">time_taken</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sim_end</span> <span class="o">-</span> <span class="n">out_finish</span><span class="p">);</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Total time taken was &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">floor</span><span class="p">((</span><span class="n">time_taken</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; hours &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">floor</span><span class="p">((</span><span class="n">time_taken</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">floor</span><span class="p">((</span><span class="n">time_taken</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; minutes &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">time_taken</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; seconds&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setProtractedVariables</span><span class="p">(</span><span class="kt">double</span> <span class="n">speciation_gen_min</span><span class="p">,</span> <span class="kt">double</span> <span class="n">speciation_gen_max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">string</span> <span class="n">Tree</span><span class="o">::</span><span class="n">getProtractedVariables</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;0.0</span><span class="se">\n</span><span class="s">0.0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Tree</span><span class="o">::</span><span class="n">getProtractedGenerationMin</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Tree</span><span class="o">::</span><span class="n">getProtractedGenerationMax</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">simPause</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Completely changed how this sections works - it won&#39;t currently allow restarting of the simulations, but will</span>
    <span class="c1">// dump the data file to memory. - simply calls sqlCreate and sqlOutput.</span>
    <span class="c1">// sqlCreate();</span>
    <span class="c1">// sqlOutput();</span>

    <span class="c1">// This function saves the data to 4 files. One contains the main simulation parameters, the other 3 contain the</span>
    <span class="c1">// simulation results thus far</span>
    <span class="c1">// including the grid object, data object and active object.</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Pausing simulation...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Saving data to temp file in &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">outdirectory</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/Pause/ ...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">ofstream</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">out</span><span class="p">.</span><span class="n">precision</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="c1">// Create the pause directory</span>
    <span class="n">string</span> <span class="n">pause_folder</span> <span class="o">=</span> <span class="n">outdirectory</span> <span class="o">+</span> <span class="s">&quot;/Pause/&quot;</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">path</span> <span class="n">pause_dir</span><span class="p">(</span><span class="n">pause_folder</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span><span class="n">pause_dir</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">create_directory</span><span class="p">(</span><span class="n">pause_dir</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failure to create &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">outdirectory</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/Pause/&quot;</span>
                 <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Writing directly to output directory.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">pause_folder</span> <span class="o">=</span> <span class="n">outdirectory</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_folder</span> <span class="o">+</span> <span class="s">&quot;Dump_main_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span><span class="p">;</span>
        <span class="n">out</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">setprecision</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
        <span class="c1">// Save that this simulation was not a protracted speciation sim</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">bIsProtracted</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="c1">// Saving the initial data to one file.</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">enddata</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">seeded</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">the_seed</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">the_task</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">autocorrel_file</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="o">&lt;&lt;</span> <span class="n">bAutocorrel</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">finemapinput</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapinput</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">outdirectory</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pristinefinemapinput</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pristinecoarsemapinput</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">dPristine</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dForestTransform</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">gridxsize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">gridysize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="o">&lt;&lt;</span> <span class="n">finemapxsize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">finemapysize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">finemapxoffset</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">finemapyoffset</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapxsize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapysize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="o">&lt;&lt;</span> <span class="n">coarsemapxoffset</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapyoffset</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">coarsemapscale</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">varimport</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sim_start</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sim_end</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">now</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">time_taken</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sim_finish</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">out_finish</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">startendactive</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">maxsimsize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">steps</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">generation</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sigma</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tau</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">maxtime</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">deme_sample</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">spec</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dispersal_relative_cost</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">deme</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">desired_specnum</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sqloutname</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">NR</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sim_parameters</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="c1">// now output the protracted speciation variables (there should be two of these).</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">getProtractedVariables</span><span class="p">();</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">rep_map</span><span class="p">;</span>
        <span class="n">out</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to perform main dump to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pause_folder</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// This part is no longer required (for saving of disk space)</span>
    <span class="c1">//  try</span>
    <span class="c1">//  {</span>
    <span class="c1">//      // Saving the larger data in single files for simpler reading in.</span>
    <span class="c1">//      // Output the grid object</span>
    <span class="c1">//      ofstream out2;</span>
    <span class="c1">//      file_to_open = pause_folder + &quot;Dump_grid_&quot; + to_string(the_task) + &quot;_&quot; + to_string(the_seed) + &quot;.csv&quot;;</span>
    <span class="c1">//      out2 &lt;&lt; setprecision(64);</span>
    <span class="c1">//      out2.open(file_to_open.c_str());</span>
    <span class="c1">//      out2 &lt;&lt; grid;</span>
    <span class="c1">//      out2.close();</span>
    <span class="c1">//  }</span>
    <span class="c1">//  catch(exception&amp; e)</span>
    <span class="c1">//  {</span>
    <span class="c1">//      cerr &lt;&lt; e.what() &lt;&lt; endl;</span>
    <span class="c1">//      cerr &lt;&lt; &quot;Failed to perform grid dump to &quot; &lt;&lt; pause_folder &lt;&lt; endl;</span>
    <span class="c1">//  }</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// Output the active object</span>
        <span class="n">ofstream</span> <span class="n">out3</span><span class="p">;</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_folder</span> <span class="o">+</span> <span class="s">&quot;Dump_active_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span><span class="p">;</span>
        <span class="n">out3</span> <span class="o">&lt;&lt;</span> <span class="n">setprecision</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
        <span class="n">out3</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">out3</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">;</span>
        <span class="n">out3</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to perform active dump to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pause_folder</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// Output the data object</span>
        <span class="n">ofstream</span> <span class="n">out4</span><span class="p">;</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_folder</span> <span class="o">+</span> <span class="s">&quot;Dump_data_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span><span class="p">;</span>
        <span class="n">out4</span> <span class="o">&lt;&lt;</span> <span class="n">setprecision</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
        <span class="n">out4</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">out4</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">out4</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to perform data dump to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pause_folder</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// Output the data object</span>
        <span class="n">ofstream</span> <span class="n">out4</span><span class="p">;</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_folder</span> <span class="o">+</span> <span class="s">&quot;Dump_map_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span><span class="p">;</span>
        <span class="n">out4</span> <span class="o">&lt;&lt;</span> <span class="n">setprecision</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
        <span class="n">out4</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">out4</span> <span class="o">&lt;&lt;</span> <span class="n">forestmap</span><span class="p">;</span>
        <span class="n">out4</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to perform map dump to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pause_folder</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;done!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SQL dump started&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_finish</span><span class="p">);</span>
    <span class="n">sqlCreate</span><span class="p">();</span>
<span class="cp">#ifdef sql_ram</span>
    <span class="n">sqlOutput</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Data dump complete&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_end</span><span class="p">);</span>
    <span class="n">writeTimes</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setResumeParameters</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bPausedImport</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pause_sim_directory</span> <span class="o">=</span> <span class="n">outdirectory</span><span class="p">;</span>
        <span class="n">bPausedImport</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">setResumeParameters</span><span class="p">(</span>
    <span class="n">string</span> <span class="n">pausedir</span><span class="p">,</span> <span class="n">string</span> <span class="n">outdir</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seed</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_max_time</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bPausedImport</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pause_sim_directory</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">pausedir</span><span class="p">);</span>
        <span class="n">outdirectory</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">outdir</span><span class="p">);</span>
        <span class="n">the_seed</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>
        <span class="n">the_task</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
        <span class="n">maxtime</span> <span class="o">=</span> <span class="n">new_max_time</span><span class="p">;</span>
        <span class="n">bPausedImport</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">loadMainSave</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...main...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">ifstream</span> <span class="n">in1</span><span class="p">;</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_sim_directory</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/Pause/Dump_main_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                       <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
        <span class="c1">//      os &lt;&lt; file_to_open &lt;&lt; endl;</span>
        <span class="n">in1</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">);</span>
        <span class="c1">// Reading the initial data</span>
        <span class="n">string</span> <span class="n">string1</span><span class="p">;</span>
        <span class="c1">// First read our boolean which just determines whether the simulation is a protracted simulation or not.</span>
        <span class="c1">// For these simulations, it should not be.</span>
        <span class="kt">bool</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">bIsProtracted</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">bIsProtracted</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;Paused simulated is not a protracted speciation simulation. &quot;</span>
                                  <span class="s">&quot;Cannot be resumed by this program. Please report this bug&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;Paused simulated is a protracted speciation simulation. &quot;</span>
                                      <span class="s">&quot;Cannot be resumed by this program. Please report this bug&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">enddata</span> <span class="o">&gt;&gt;</span> <span class="n">seeded</span> <span class="o">&gt;&gt;</span> <span class="n">the_seed</span> <span class="o">&gt;&gt;</span> <span class="n">the_task</span><span class="p">;</span>
        <span class="n">in1</span><span class="p">.</span><span class="n">ignore</span><span class="p">();</span> <span class="c1">// Ignore the endline character</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">autocorrel_file</span><span class="p">);</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">bAutocorrel</span><span class="p">;</span>
        <span class="n">in1</span><span class="p">.</span><span class="n">ignore</span><span class="p">();</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">finemapinput</span><span class="p">);</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">coarsemapinput</span><span class="p">);</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">string1</span><span class="p">);</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">pristinefinemapinput</span><span class="p">);</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">pristinecoarsemapinput</span><span class="p">);</span>
<span class="c1">//      in1 &gt;&gt; finemapinput &gt;&gt; coarsemapinput &gt;&gt; string1 &gt;&gt; pristinefinemapinput &gt;&gt; pristinecoarsemapinput;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">dPristine</span> <span class="o">&gt;&gt;</span> <span class="n">dForestTransform</span> <span class="o">&gt;&gt;</span> <span class="n">gridxsize</span> <span class="o">&gt;&gt;</span> <span class="n">gridysize</span> <span class="o">&gt;&gt;</span> <span class="n">finemapxsize</span> <span class="o">&gt;&gt;</span> <span class="n">finemapysize</span><span class="p">;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">finemapxoffset</span> <span class="o">&gt;&gt;</span> <span class="n">finemapyoffset</span> <span class="o">&gt;&gt;</span> <span class="n">coarsemapxsize</span> <span class="o">&gt;&gt;</span> <span class="n">coarsemapysize</span> <span class="o">&gt;&gt;</span> <span class="n">coarsemapxoffset</span><span class="p">;</span>
        <span class="kt">time_t</span> <span class="n">tmp_time</span><span class="p">;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">coarsemapyoffset</span> <span class="o">&gt;&gt;</span> <span class="n">coarsemapscale</span> <span class="o">&gt;&gt;</span> <span class="n">varimport</span> <span class="o">&gt;&gt;</span> <span class="n">tmp_time</span> <span class="o">&gt;&gt;</span> <span class="n">sim_start</span> <span class="o">&gt;&gt;</span> <span class="n">sim_end</span> <span class="o">&gt;&gt;</span> <span class="n">now</span><span class="p">;</span>
        <span class="c1">//          os &lt;&lt; &quot;sim_start: &quot; &lt;&lt; sim_start &lt;&lt; endl;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">time_taken</span> <span class="o">&gt;&gt;</span> <span class="n">sim_finish</span> <span class="o">&gt;&gt;</span> <span class="n">out_finish</span> <span class="o">&gt;&gt;</span> <span class="n">endactive</span> <span class="o">&gt;&gt;</span> <span class="n">startendactive</span> <span class="o">&gt;&gt;</span> <span class="n">maxsimsize</span> <span class="o">&gt;&gt;</span> <span class="n">steps</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tempmaxtime</span> <span class="o">=</span> <span class="n">maxtime</span><span class="p">;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">generation</span> <span class="o">&gt;&gt;</span> <span class="n">sigma</span> <span class="o">&gt;&gt;</span> <span class="n">tau</span> <span class="o">&gt;&gt;</span> <span class="n">maxtime</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">maxtime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">maxtime</span> <span class="o">=</span> <span class="n">tempmaxtime</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">deme_sample</span> <span class="o">&gt;&gt;</span> <span class="n">spec</span> <span class="o">&gt;&gt;</span> <span class="n">dispersal_relative_cost</span> <span class="o">&gt;&gt;</span> <span class="n">deme</span><span class="p">;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">desired_specnum</span><span class="p">;</span>
        <span class="n">in1</span><span class="p">.</span><span class="n">ignore</span><span class="p">();</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">sqloutname</span><span class="p">);</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">NR</span><span class="p">;</span>
        <span class="n">in1</span><span class="p">.</span><span class="n">ignore</span><span class="p">();</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">sim_parameters</span><span class="p">;</span>
        <span class="n">NR</span><span class="p">.</span><span class="n">setDispersalMethod</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_method</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">m_prob</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">cutoff</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">tmp1</span> <span class="o">&gt;&gt;</span> <span class="n">tmp2</span><span class="p">;</span>
        <span class="n">setProtractedVariables</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">);</span>
        <span class="n">in1</span> <span class="o">&gt;&gt;</span> <span class="n">rep_map</span><span class="p">;</span>
        <span class="n">in1</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">autocorrel_file</span> <span class="o">==</span> <span class="s">&quot;null&quot;</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">bAutocorrel</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;bAutocorrel should not be true&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bAutocorrel</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;bAutocorrel should not be false&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">tmpimport</span><span class="p">;</span>
                <span class="n">ConfigOption</span> <span class="n">tmpconfig</span><span class="p">;</span>
                <span class="n">tmpconfig</span><span class="p">.</span><span class="n">setConfig</span><span class="p">(</span><span class="n">autocorrel_file</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
                <span class="n">tmpconfig</span><span class="p">.</span><span class="n">importConfig</span><span class="p">(</span><span class="n">tmpimport</span><span class="p">);</span>
                <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tmpimport</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">autocorrel_times</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">stod</span><span class="p">(</span><span class="n">tmpimport</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
                    <span class="c1">//                  os &lt;&lt; &quot;t_i: &quot; &lt;&lt; autocorrel_times[i] &lt;&lt; endl;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="n">Config_Exception</span><span class="o">&amp;</span> <span class="n">ce</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">ce</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">msg</span><span class="p">;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;Failure to import from &quot;</span> <span class="o">+</span> <span class="n">file_to_open</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">loadDataSave</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="c1">// Input the data object</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...data...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">ifstream</span> <span class="n">in4</span><span class="p">;</span>
        <span class="c1">//      sprintf(file_to_open,&quot;%s/Pause/Data_%i_data.csv&quot;,outdirectory,int(the_task));</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_sim_directory</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/Pause/Dump_data_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                       <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
        <span class="n">in4</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">);</span>
        <span class="n">in4</span> <span class="o">&gt;&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="c1">//          os &lt;&lt; data[0] &lt;&lt; endl;</span>
        <span class="c1">//          os &lt;&lt; data[1] &lt;&lt; endl;</span>
        <span class="n">in4</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">msg</span><span class="p">;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;Failure to import from &quot;</span> <span class="o">+</span> <span class="n">file_to_open</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">loadActiveSave</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...active...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="c1">// Input the active object</span>
        <span class="n">ifstream</span> <span class="n">in3</span><span class="p">;</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_sim_directory</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/Pause/Dump_active_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                       <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
        <span class="n">in3</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">);</span>
        <span class="n">in3</span> <span class="o">&gt;&gt;</span> <span class="n">active</span><span class="p">;</span>
        <span class="n">in3</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">msg</span><span class="p">;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;Failure to import from &quot;</span> <span class="o">+</span> <span class="n">file_to_open</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">loadGridSave</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...grid...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="c1">// New method for re-creating grid data from active lineages</span>
        <span class="c1">// First initialise the empty grid object</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gridysize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">gridxsize</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">initialise</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">generation</span><span class="p">));</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">fillList</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// Now fill the grid object with lineages from active. Only need to loop once.</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setSpeciesEmpty</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getListpos</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">increaseListSize</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">runtime_error</span><span class="p">(</span>
                        <span class="s">&quot;Nwrap should not be 0 if x and y wrap are not 0. Programming error likely.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setNext</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">increaseNwrap</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">msg</span><span class="p">;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;Failure to import from &quot;</span> <span class="o">+</span> <span class="n">file_to_open</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">loadMapSave</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="c1">// Input the map object</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...map...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">ifstream</span> <span class="n">in5</span><span class="p">;</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_sim_directory</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/Pause/Dump_map_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                       <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
        <span class="n">in5</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">);</span>
        <span class="n">in5</span> <span class="o">&gt;&gt;</span> <span class="n">forestmap</span><span class="p">;</span>
        <span class="c1">//      forestmap.setPristine(false);</span>
        <span class="c1">//      forestmap.updateMap(generation); This has been removed, because I&#39;m not sure about it</span>
        <span class="n">in5</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">msg</span><span class="p">;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;Failure to import from &quot;</span> <span class="o">+</span> <span class="n">file_to_open</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">simResume</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Start the timer</span>
    <span class="c1">// Only resume the simulation if there is a simulation to resume from.</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bPaused</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
    <span class="c1">// Loads the data from the files into the relevant objects.</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Resuming simulation...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Loading data from temp file...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="c1">// now load the objects</span>
    <span class="n">loadMainSave</span><span class="p">();</span>
    <span class="n">loadMapSave</span><span class="p">();</span>
    <span class="n">setObjectSizes</span><span class="p">();</span>
    <span class="n">loadActiveSave</span><span class="p">();</span>
    <span class="n">loadDataSave</span><span class="p">();</span>
    <span class="n">loadGridSave</span><span class="p">();</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_start</span><span class="p">);</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">sqlCreate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_finish</span><span class="p">);</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Creating SQL database file...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;    Checking for existing folders....&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="c1">// Create the folder if it doesn&#39;t exist</span>
    <span class="n">sqloutname</span> <span class="o">=</span> <span class="n">outdirectory</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">sqlfolder</span> <span class="o">=</span> <span class="n">outdirectory</span> <span class="o">+</span> <span class="s">&quot;/SQL_data/&quot;</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">path</span> <span class="n">dir</span><span class="p">(</span><span class="n">sqlfolder</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    SQL_data folder not found....creating...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">create_directory</span><span class="p">(</span><span class="n">sqlfolder</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    SQL_data folder created successfully                             &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    SQL_data folder not created successfully                             &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nf">Main_Exception</span><span class="p">(</span><span class="s">&quot;ERROR_SQL_012: SQL folder could not be created. Check write &quot;</span>
                                     <span class="s">&quot;permissions and that the parent folder is accessible.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    Checking for existing folders....done!        &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
            <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="c1">// create the empty file, deleting if it exists.</span>
        <span class="n">sqloutname</span> <span class="o">+=</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/SQL_data/data_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">Main_Exception</span><span class="o">&amp;</span> <span class="n">me</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">me</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">sqloutname</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;data_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    Generating species list....              &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="c1">// for outputting the full data from the simulation in to a SQL file.</span>
    <span class="n">sqlite3_stmt</span><span class="o">*</span> <span class="n">stmt</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">sErrMsg</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// Open a SQL database in memory. This will be written to disk later.</span>
<span class="c1">// A check here can be done to write to disc directly instead to massively reduce RAM consumption</span>
<span class="cp">#ifdef sql_ram</span>
    <span class="n">sqlite3_open</span><span class="p">(</span><span class="s">&quot;:memory:&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">database</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef sql_ram</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open_v2</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">database</span><span class="p">,</span> <span class="n">SQLITE_OPEN_READWRITE</span> <span class="o">|</span> <span class="n">SQLITE_OPEN_CREATE</span><span class="p">,</span> <span class="s">&quot;unix-dotfile&quot;</span><span class="p">);</span>

<span class="cp">#endif</span>
    <span class="c1">// Create the command to be executed by adding to the string.</span>
    <span class="n">string</span> <span class="n">all_commands</span><span class="p">;</span>
    <span class="n">all_commands</span> <span class="o">=</span>
        <span class="s">&quot;CREATE TABLE SPECIES_LIST (ID int PRIMARY KEY NOT NULL, unique_spec INT NOT NULL, xval INT NOT NULL,&quot;</span><span class="p">;</span>
    <span class="n">all_commands</span> <span class="o">+=</span> <span class="s">&quot;yval INT NOT NULL, xwrap INT NOT NULL, ywrap INT NOT NULL, tip INT NOT NULL, speciated INT NOT &quot;</span>
                    <span class="s">&quot;NULL, parent INT NOT NULL,existance INT NOT NULL,randnum DOUBLE NOT NULL, gen_alive INT NOT &quot;</span>
                    <span class="s">&quot;NULL, gen_added DOUBLE NOT NULL);&quot;</span><span class="p">;</span>

    <span class="c1">// Create the table within the SQL database</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">all_commands</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
<span class="cp">#ifndef sql_ram</span>
        <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">database</span><span class="p">);</span>
        <span class="c1">//          cerr &lt;&lt; &quot;unix-dotfile not working - attempting default SQL VFS method...&quot; &lt;&lt; flush;</span>
        <span class="c1">// delete any old database files - this is risky, but there isn&#39;t a better way of ensuring that the file</span>
        <span class="c1">// actually gets created.</span>
        <span class="n">remove</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">database</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">all_commands</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//              cerr &lt;&lt; &quot;done! Default unix VFS method functional.&quot; &lt;&lt; endl;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Database file creation failed. Check file system.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error code: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_007: Cannot generate in-memory table. Check memory database assignment and SQL &quot;</span>
                    <span class="s">&quot;commands.&quot;</span>
                 <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error code: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Now create the prepared statement into which we shall insert the values from the table</span>
    <span class="n">all_commands</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO SPECIES_LIST &quot;</span>
                   <span class="s">&quot;(ID,unique_spec,xval,yval,xwrap,ywrap,tip,speciated,parent,existance,randnum,gen_alive,gen_added) &quot;</span>
                   <span class="s">&quot;VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">;</span>
    <span class="n">sqlite3_prepare_v2</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">all_commands</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">strlen</span><span class="p">(</span><span class="n">all_commands</span><span class="p">.</span><span class="n">c_str</span><span class="p">()),</span> <span class="o">&amp;</span><span class="n">stmt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Start the transaction</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;BEGIN TRANSACTION;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_008: Cannot start SQL transaction. Check memory database assignment and SQL commands.&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getSpeciesID</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isTip</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getParent</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getExistance</span><span class="p">());</span>
        <span class="n">sqlite3_bind_double</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getSpecRate</span><span class="p">());</span>
        <span class="n">sqlite3_bind_int</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getGenRate</span><span class="p">());</span>
        <span class="n">sqlite3_bind_double</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getGeneration</span><span class="p">());</span>
        <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>
        <span class="n">sqlite3_clear_bindings</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>
        <span class="n">sqlite3_reset</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    Executing SQL commands....&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="c1">// execute the command and close the connection to the database</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;END TRANSACTION;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_008: Cannot complete SQL transaction. Check memory database assignment and SQL &quot;</span>
                <span class="s">&quot;commands. Ensure SQL statements are properly cleared.&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error code: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="c1">// try again</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">((</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;END TRANSACTION;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Attempt &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; failed...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_008: Cannot complete SQL transaction. Check memory database assignment and SQL &quot;</span>
                    <span class="s">&quot;commands. Ensure SQL statements are properly cleared.&quot;</span>
                 <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Need to finalise the statement</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_008: Cannot complete SQL transaction. Check memory database assignment and SQL &quot;</span>
                <span class="s">&quot;commands. Ensure SQL statements are properly cleared.&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error code: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Vacuum the file so that the file size is reduced (reduces by around 3%)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;VACUUM;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_014: Cannot vacuum the database. Error message: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sErrMsg</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Now additionally store the simulation parameters (extremely useful data)</span>
    <span class="n">string</span> <span class="n">to_execute</span> <span class="o">=</span> <span class="s">&quot;CREATE TABLE SIMULATION_PARAMETERS (seed INT PRIMARY KEY not null, job_type INT NOT NULL,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;output_dir TEXT NOT NULL, spec_rate DOUBLE NOT NULL, sigma DOUBLE NOT NULL,tau DOUBLE NOT &quot;</span>
                  <span class="s">&quot;NULL, deme INT NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;sample_size DOUBLE NOT NULL, max_time INT NOT NULL, dispersal_relative_cost DOUBLE NOT NULL, &quot;</span>
                  <span class="s">&quot;min_num_species &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;INT NOT NULL, forest_change_rate DOUBLE NOT NULL, time_since_pristine DOUBLE NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;time_config_file TEXT NOT NULL, coarse_map_file TEXT NOT NULL, coarse_map_x INT NOT NULL, &quot;</span>
                  <span class="s">&quot;coarse_map_y INT NOT NULL,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;coarse_map_x_offset INT NOT NULL, coarse_map_y_offset INT NOT NULL, coarse_map_scale DOUBLE NOT &quot;</span>
                  <span class="s">&quot;NULL, fine_map_file TEXT NOT NULL, fine_map_x INT NOT NULL,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;fine_map_y INT NOT NULL, fine_map_x_offset INT NOT NULL, fine_map_y_offset INT NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;sample_file TEXT NOT NULL, grid_x INT NOT NULL, grid_y INT NOT NULL, sample_x INT NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;sample_y INT NOT NULL, sample_x_offset INT NOT NULL, sample_y_offset INT NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;pristine_coarse_map TEXT NOT NULL, pristine_fine_map TEXT NOT NULL, sim_complete INT NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;dispersal_method TEXT NOT NULL, m_probability DOUBLE NOT NULL, cutoff DOUBLE NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;restrict_self INT NOT NULL, infinite_landscape TEXT NOT NULL, protracted INT NOT NULL, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;min_speciation_gen DOUBLE NOT NULL, max_speciation_gen DOUBLE NOT NULL, dispersal_map TEXT NOT NULL);&quot;</span><span class="p">;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">to_execute</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_008: Cannot start SQL transaction. Check memory database assignment and SQL commands.&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error code: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">to_execute</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO SIMULATION_PARAMETERS VALUES(&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span>
                 <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">the_task</span><span class="p">);</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;,&#39;&quot;</span> <span class="o">+</span> <span class="n">outdirectory</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">boost</span><span class="o">::</span><span class="n">lexical_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">spec</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span>
                  <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">deme</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">deme_sample</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">maxtime</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">dispersal_relative_cost</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">desired_specnum</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">dForestChangeRate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">dPristine</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&#39;&quot;</span> <span class="o">+</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">autocorrel_file</span> <span class="o">+</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">coarsemapinput</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">coarsemapxsize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">coarsemapysize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">coarsemapxoffset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">coarsemapyoffset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">coarsemapscale</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">finemapinput</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">finemapxsize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">finemapysize</span><span class="p">);</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">finemapxoffset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">finemapyoffset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">samplemaskfile</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gridxsize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span>
                  <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">gridysize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsamplexsize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsampleysize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsamplexoffset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varsampleyoffset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">pristinecoarsemapinput</span> <span class="o">+</span> <span class="s">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="n">pristinefinemapinput</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">sim_complete</span><span class="p">);</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;, &#39;&quot;</span> <span class="o">+</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_method</span> <span class="o">+</span> <span class="s">&quot;&#39;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">boost</span><span class="o">::</span><span class="n">lexical_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">m_prob</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">restrict_self</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">landscape_type</span> <span class="o">+</span> <span class="s">&quot;&#39;, &quot;</span><span class="p">;</span>
    <span class="c1">// Now save the protracted speciation variables (not relevant in this simulation scenario)</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">protractedVarsToString</span><span class="p">();</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;, &#39;&quot;</span> <span class="o">+</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_file</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;);&quot;</span><span class="p">;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">to_execute</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">to_execute</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">lexical_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">spec</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">spec</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_008: Cannot start SQL transaction. Check memory database assignment and SQL commands.&quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error code: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">Tree</span><span class="o">::</span><span class="n">protractedVarsToString</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">to_string</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">sqlOutput</span><span class="p">()</span>
<span class="p">{</span>
<span class="cp">#ifdef sql_ram</span>
    <span class="c1">// open connection to the database file</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    Writing to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sqloutname</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ....     &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span>
        <span class="n">sqlite3_open_v2</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">outdatabase</span><span class="p">,</span> <span class="n">SQLITE_OPEN_READWRITE</span> <span class="o">|</span> <span class="n">SQLITE_OPEN_CREATE</span><span class="p">,</span> <span class="s">&quot;unix-dotfile&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">((</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open_v2</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">outdatabase</span><span class="p">,</span> <span class="n">SQLITE_OPEN_READWRITE</span> <span class="o">|</span> <span class="n">SQLITE_OPEN_CREATE</span><span class="p">,</span>
                                 <span class="s">&quot;unix-dotfile&quot;</span><span class="p">);</span>
            <span class="c1">//              cerr &lt;&lt; &quot;Attempt &quot; &lt;&lt; i &lt;&lt; &quot; failed...&quot; &lt;&lt; endl;</span>
        <span class="p">}</span>
        <span class="c1">// Attempt different opening method if the first fails.</span>
        <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">((</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">j</span><span class="o">++</span><span class="p">;</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">sqloutname</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">outdatabase</span><span class="p">);</span>
            <span class="c1">//              cerr &lt;&lt; &quot;Attempt &quot; &lt;&lt; i &lt;&lt; &quot; failed...&quot; &lt;&lt; endl;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_010: SQLite database file could not be opened. Check the folder exists and you &quot;</span>
                    <span class="s">&quot;have write permissions. (REF1) Error code: &quot;</span>
                 <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Attempted call &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; times&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// create the backup object to write data to the file from memory.</span>
    <span class="n">sqlite3_backup</span><span class="o">*</span> <span class="n">backupdb</span><span class="p">;</span>
    <span class="n">backupdb</span> <span class="o">=</span> <span class="n">sqlite3_backup_init</span><span class="p">(</span><span class="n">outdatabase</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">backupdb</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_011: Could not write to the backup database. Check the file exists.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Perform the backup</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_backup_step</span><span class="p">(</span><span class="n">backupdb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//          cerr &lt;&lt;  &quot;ERROR_SQL_010: SQLite database file could not be opened. Check the folder</span>
        <span class="c1">// exists</span>
        <span class="c1">// and</span>
        <span class="c1">// you</span>
        <span class="c1">// have write permissions. (REF2) Error code: &quot; &lt;&lt; rc &lt;&lt; endl;</span>
        <span class="c1">// try again</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">((</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlite3_backup_step</span><span class="p">(</span><span class="n">backupdb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="c1">//              cerr &lt;&lt; &quot;Attempt &quot; &lt;&lt; i &lt;&lt; &quot; failed...&quot; &lt;&lt; endl;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">SQLITE_DONE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_SQL_010: SQLite database file could not be opened. Check the folder exists and you &quot;</span>
                    <span class="s">&quot;have write permissions. (REF3) Error code: &quot;</span>
                 <span class="o">&lt;&lt;</span> <span class="n">rc</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Attempted call &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; times&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sqlite3_backup_finish</span><span class="p">(</span><span class="n">backupdb</span><span class="p">);</span>
    <span class="c1">//      sqlite3_exec(database,&quot;VACUUM;&quot;,NULL,NULL,&amp;sErrMsg);</span>
    <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">    Writing to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sqloutname</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ....  done!              &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">applySpecRate</span><span class="p">(</span><span class="kt">double</span> <span class="n">sr</span><span class="p">,</span> <span class="kt">double</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tl</span><span class="p">.</span><span class="n">hasImportedData</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">tl</span><span class="p">.</span><span class="n">setDatabase</span><span class="p">(</span><span class="n">database</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// os &lt;&lt; &quot;Precount: &quot; &lt;&lt; tl.countSpecies() &lt;&lt; endl;</span>
    <span class="n">tl</span><span class="p">.</span><span class="n">setGeneration</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">tl</span><span class="p">.</span><span class="n">resetTree</span><span class="p">();</span>
    <span class="n">tl</span><span class="p">.</span><span class="n">internalOption</span><span class="p">();</span>
    <span class="n">tl</span><span class="p">.</span><span class="n">setProtractedParameters</span><span class="p">(</span><span class="n">getProtractedGenerationMin</span><span class="p">(),</span> <span class="n">getProtractedGenerationMax</span><span class="p">());</span>
    <span class="n">tl</span><span class="p">.</span><span class="n">setProtracted</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="n">tl</span><span class="p">.</span><span class="n">createDatabase</span><span class="p">(</span><span class="n">sr</span><span class="p">);</span>
<span class="cp">#ifdef record_space</span>
    <span class="n">tl</span><span class="p">.</span><span class="n">recordSpatial</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">applySpecRate</span><span class="p">(</span><span class="kt">double</span> <span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">applySpecRate</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">applyMultipleRates</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iMultiNumber</span> <span class="o">=</span> <span class="n">speciation_rates</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">iMultiNumber</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No additional speciation rates to apply.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">iMultiNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">speciation_rates</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Speciation rate&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">speciation_rates</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;s are: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; is: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iMultiNumber</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">speciation_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">iMultiNumber</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="c1">// Now check to make sure repeat speciation rates aren&#39;t done twice (this is done to avoid the huge number of errors</span>
    <span class="c1">// SQL throws if you try to add identical data</span>
    <span class="kt">double</span> <span class="n">dUniqueSpec</span><span class="p">[</span><span class="n">iMultiNumber</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spec_upto</span> <span class="o">=</span> <span class="n">sortData</span><span class="p">();</span>
    <span class="n">sqlCreate</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iMultiNumber</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">bool</span> <span class="n">bCont</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">iMultiNumber</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">dUniqueSpec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">speciation_rates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="p">{</span>
                <span class="n">bCont</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">bCont</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">dUniqueSpec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">speciation_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">temp_sampling</span> <span class="o">=</span> <span class="n">getTemporalSampling</span><span class="p">();</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">temp_sampling</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="n">write_cout</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Calculating generation &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">temp_sampling</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">speciation_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">spec</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">applySpecRate</span><span class="p">(</span><span class="n">speciation_rates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temp_sampling</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">speciation_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">spec</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// Use the run spec if the rates are very close to equal</span>
                        <span class="n">applySpecRate</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">temp_sampling</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">write_cerr</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">write_cerr</span><span class="p">(</span><span class="s">&quot;Repeat speciation rate... ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">outputData</span><span class="p">(</span><span class="n">spec_upto</span><span class="p">);</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">determineSpeciationRates</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bConfig</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">configs</span><span class="p">.</span><span class="n">hasSection</span><span class="p">(</span><span class="s">&quot;spec_rates&quot;</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">spec_rates</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">configs</span><span class="p">.</span><span class="n">getSectionValues</span><span class="p">(</span><span class="s">&quot;spec_rates&quot;</span><span class="p">);</span>
            <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">spec_rate</span> <span class="p">:</span> <span class="n">spec_rates</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">speciation_rates</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">stod</span><span class="p">(</span><span class="n">spec_rate</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">speciation_rates</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">verifyReproductionMap</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">reproduction_file</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span> <span class="o">||</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">reproduction_file</span> <span class="o">==</span> <span class="s">&quot;null&quot;</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapysize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">varfinemapxsize</span><span class="p">;</span> <span class="n">j</span> <span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">rep_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getValFine</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;Reproduction map is zero where density is non-zero.&quot;</span>
                                          <span class="s">&quot; This will cause an infinite loop.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getValFine</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rep_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">write_error</span><span class="p">(</span><span class="s">&quot;Density is zero where reproduction map is non-zero. This is likely incorrect.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">addWrappedLineage</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numstart</span><span class="p">,</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">numstart</span><span class="p">);</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">numstart</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_last</span> <span class="o">=</span> <span class="n">tmp_next</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">tmp_nwrap</span> <span class="o">++</span><span class="p">;</span>
            <span class="n">tmp_last</span> <span class="o">=</span> <span class="n">tmp_next</span><span class="p">;</span>
            <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
        <span class="n">active</span><span class="p">[</span><span class="n">tmp_last</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">numstart</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">numstart</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">tmp_nwrap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">debugAddingLineage</span><span class="p">(</span><span class="n">numstart</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">convertTip</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="kt">double</span> <span class="n">generationin</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">enddata</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">enddata</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span>
                <span class="s">&quot;Cannot add tip - no space in data. Check size calculations.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">(),</span>
                        <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">(),</span>
                        <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">(),</span> <span class="n">generationin</span><span class="p">);</span>
    <span class="c1">// Now link the old tip to the new tip</span>
    <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setParent</span><span class="p">(</span><span class="n">enddata</span><span class="p">);</span>
    <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setIGen</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
    <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setMpos</span><span class="p">(</span><span class="n">enddata</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Tree</span><span class="o">::</span><span class="n">countCellExpansion</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">xwrap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">ywrap</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">generation_in</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span><span class="o">&amp;</span> <span class="n">make_tips</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mapcover</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">floor</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span>
                                                                               <span class="n">ywrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">)</span> <span class="o">*</span> <span class="n">deme_sample</span><span class="p">));</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span> <span class="o">=</span> <span class="n">mapcover</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xwrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ywrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mapcover</span> <span class="o">&gt;=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">changePercentCover</span><span class="p">(</span><span class="n">mapcover</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="n">ref</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">num_to_add</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_active</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmp_active</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">make_tips</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">makeTip</span><span class="p">(</span><span class="n">tmp_active</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">num_to_add</span> <span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ref</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="k">while</span><span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">num_to_add</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">xwrap</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">ywrap</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">num_to_add</span><span class="o">--</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">make_tips</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">makeTip</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">num_to_add</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">expandCell</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="n">y</span><span class="p">,</span> <span class="kt">long</span> <span class="n">xwrap</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ywrap</span><span class="p">,</span> <span class="kt">double</span> <span class="n">generation_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">num_to_add</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_to_add</span><span class="p">;</span> <span class="n">k</span> <span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">endactive</span> <span class="o">++</span><span class="p">;</span>
            <span class="n">enddata</span> <span class="o">++</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">listpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// Add the species to active</span>
            <span class="k">if</span><span class="p">(</span><span class="n">xwrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ywrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">listpos</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">endactive</span><span class="p">);</span>
                <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">enddata</span><span class="p">,</span> <span class="n">listpos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">enddata</span><span class="p">,</span> <span class="n">listpos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">addWrappedLineage</span><span class="p">(</span><span class="n">endactive</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">enddata</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;Cannot add lineage - no space in data. &quot;</span>
                                              <span class="s">&quot;Check size calculations.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">endactive</span> <span class="o">&gt;=</span> <span class="n">active</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="s">&quot;Cannot add lineage - no space in active. &quot;</span>
                                              <span class="s">&quot;Check size calculations.&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Add a tip in the Treenode for calculation of the coalescence tree at the</span>
            <span class="c1">// end of the simulation.</span>
            <span class="c1">// This also contains the start x and y position of the species.</span>
            <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span>
            <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">makeTip</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">tmp_active</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">generationin</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">m_pos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_active</span><span class="p">].</span><span class="n">getMpos</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">m_pos</span><span class="p">].</span><span class="n">isTip</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">convertTip</span><span class="p">(</span><span class="n">tmp_active</span><span class="p">,</span> <span class="n">generationin</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">tmp_active</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setGeneration</span><span class="p">(</span><span class="n">generationin</span><span class="p">);</span>
        <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">tmp_active</span><span class="p">].</span><span class="n">getMpos</span><span class="p">()].</span><span class="n">setTip</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">validateLineages</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">fail</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Starting lineage validation...&quot;</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">Datapoint</span> <span class="n">tmp_datapoint</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="c1">// Validate the location exists</span>
            <span class="k">if</span><span class="p">(</span><span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">(),</span>
                                <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXwrap</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYwrap</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">printed</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">printed</span> <span class="o">++</span><span class="p">;</span>
                    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;forestmapval: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">forestmap</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">(),</span>
                                                               <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXwrap</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYwrap</span><span class="p">(),</span>
                                                               <span class="mf">0.0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span>
                       <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getListpos</span><span class="p">()))</span>
                    <span class="p">{</span>
                        <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">count</span><span class="o">++</span><span class="p">;</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
                        <span class="p">{</span>
                            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;problem in wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; != &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Failure in map expansion. Please report this bug.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active reference: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;x, y position: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;wrapping: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Grid wrapping: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nf">out_of_range</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="n">out_of_range</span> <span class="o">&amp;</span><span class="n">oe</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">write_cout</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="k">throw</span> <span class="n">oe</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="kt">void</span> <span class="n">Tree</span><span class="o">::</span><span class="n">debugAddingLineage</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numstart</span><span class="p">,</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tmp_nwrap</span> <span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">tmp_nwrap</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Incorrect setting of nwrap in wrapped lineage, please report this bug.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;next nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmp_nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;next = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_next</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;numstart: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numstart</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">Fatal_Exception</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">tmp_nwrap</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Grid wrapping value not set correctly&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Grid nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Counted wrapping: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numstart</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="n">tmp_nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">tmp_nwrap</span> <span class="o">++</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmp_next: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_next</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmp_nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="n">Fatal_Exception</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">runMain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Create our SimSetup object</span>
    <span class="c1">// This performs some basic checks to make sure that our simulation parameters make sense</span>
    <span class="c1">// It also outputs the information if the user requests help or runs with incorrect options.</span>
<span class="cp">#ifndef verbose</span>
    <span class="c1">// Open our file for logging outputs</span>
    <span class="n">openLogFile</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="c1">// Parse our arguments</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">comargs</span><span class="p">;</span>
    <span class="n">comargs</span> <span class="o">=</span> <span class="n">argv</span><span class="p">;</span>
    <span class="c1">// Create our tree object that contains the simulation</span>
    <span class="n">Tree</span> <span class="n">tree</span><span class="p">;</span>
    <span class="n">tree</span><span class="p">.</span><span class="n">importSimulationVariables</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
    <span class="c1">// Setup the sim</span>
    <span class="n">tree</span><span class="p">.</span><span class="n">setup</span><span class="p">();</span>
    <span class="c1">// Detect speciation rates to apply</span>
    <span class="kt">bool</span> <span class="n">isComplete</span> <span class="o">=</span> <span class="n">tree</span><span class="p">.</span><span class="n">runSimulation</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">isComplete</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tree</span><span class="p">.</span><span class="n">applyMultipleRates</span><span class="p">();</span>
    <span class="p">}</span>
<span class="cp">#ifndef verbose</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="n">write_cout</span><span class="p">(</span><span class="s">&quot;*************************************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/PyCoal_logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="file_Tree.cpp.html"
                        title="previous chapter">File Tree.cpp</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="file_Tree.h.html"
                        title="next chapter">File Tree.h</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Exhaled/program_listing_file_Tree.cpp.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="file_Tree.h.html" title="File Tree.h"
             >next</a> |</li>
        <li class="right" >
          <a href="file_Tree.cpp.html" title="File Tree.cpp"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PyCoalescence 1.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="exhaled_library.html" >NECSim</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="file_Tree.cpp.html" >File Tree.cpp</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Samuel Thompson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.4.
    </div>
  </body>
</html>