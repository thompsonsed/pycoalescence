<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Program Listing for File SpatialTree.cpp &#8212; pycoalescence 1.2.6 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
    <script type="text/javascript" src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <link rel="shortcut icon" href="../_static/PyCoal_favicon_large.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="File SpatialTree.h" href="file_necsim_SpatialTree.h.html" />
    <link rel="prev" title="File SpatialTree.cpp" href="file_necsim_SpatialTree.cpp.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="file_necsim_SpatialTree.h.html" title="File SpatialTree.h"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="file_necsim_SpatialTree.cpp.html" title="File SpatialTree.cpp"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pycoalescence 1.2.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="necsim_library.html" >necim</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="file_necsim_SpatialTree.cpp.html" accesskey="U">File SpatialTree.cpp</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="program-listing-for-file-spatialtree-cpp">
<span id="program-listing-file-necsim-spatialtree-cpp"></span><h1>Program Listing for File SpatialTree.cpp<a class="headerlink" href="#program-listing-for-file-spatialtree-cpp" title="Permalink to this headline">Â¶</a></h1>
<ul class="simple">
<li>Return to documentation for <a class="reference internal" href="file_necsim_SpatialTree.cpp.html#file-necsim-spatialtree-cpp"><span class="std std-ref">File SpatialTree.cpp</span></a></li>
</ul>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="c1">// This file is part of NECSim project which is released under MIT license.</span>
<span class="c1">// See file **LICENSE.txt** or visit https://opensource.org/licenses/MIT) for full license details.</span>

<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;SpatialTree.h&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">importSimulationVariables</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">configfile</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sim_parameters</span><span class="p">.</span><span class="n">importParameters</span><span class="p">(</span><span class="n">configfile</span><span class="p">);</span>
    <span class="c1">// Now check that our folders exist</span>
    <span class="n">checkFolders</span><span class="p">();</span>
    <span class="c1">// Now check for paused simulations</span>
    <span class="n">checkSims</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">parseArgs</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">comargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// First parse the command line arguments</span>
    <span class="kt">bool</span> <span class="n">bCheckUser</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">comargs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">comargs</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&quot;-e&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MAIN_010: Incorrect command line parsing.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-h&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-H&quot;</span><span class="o">||</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-help&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-e&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="c1">// Sort out piping to terminal if verbose has not been defined.</span>
        <span class="cp">#ifndef verbose</span>
        <span class="n">dup2</span><span class="p">(</span><span class="n">saved_stdout</span><span class="p">,</span> <span class="n">fileno</span><span class="p">(</span><span class="n">stdout</span><span class="p">));</span>
        <span class="c1">//close(saved_stdout);</span>
        <span class="cp">#endif</span>
        <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No arguments supplied: expected 30. These are: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;30 command line arguments are required. These are: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1: the seed for the simulation.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;2: the simulation task (for file reference).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;3: the map config file.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;4: the output directory.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;5: the minimum speciation rate.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;6: the dispersal tau value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;7: the dispersal sigma value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;8: the deme size.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;9: the deme sample size.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;10: the maximum simulation time (in seconds).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;11: the dispersal_relative_cost value for moving through non-habitat.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;12: the temporal sampling file containing tab-separated generation values for sampling points in time (null for only sampling the present).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;13: the minimum number of species known to exist. (Currently has no effect).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;14 onwards: speciation rates to apply after simulation.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;There is also a full-command line mode, (flag -f), which allows for more options to be specified via the command line.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Would you like to see these options? Y/N: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">writeWarning</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">string</span> <span class="n">fullopts</span><span class="p">;</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">fullopts</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">fullopts</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span> <span class="o">||</span> <span class="n">fullopts</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1: the task_iter used for setting the seed.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;2: the sample grid x dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;3: the sample grid y dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;4: the fine map file relative path.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;5: the fine map x dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;6: the fine map y dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;7: the fine map x offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;8 the fine map y offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;9: the coarse map file relative path.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;10: the coarse map x dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;11: the coarse map y dimension.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;12: the coarse map x offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;13: the coarse map y offset.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;14: the scale of the coarse map compared to the fine (10 means resolution of coarse map = 10 x resolution of fine map).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;15: the output directory.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;16: the speciation rate.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;17: the dispersal distance (tau).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;18: the deme size.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;19: the deme sample size (as a proportion of deme size).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;20: the time to run the simulation (in seconds).&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;21: dispersal_relative_cost - the relative cost of moving through non-forest.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;22: the_task - for referencing the specific task later on.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;23: the minimum number of species the system is known to contain.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;24: the historical fine map file to use.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;25: the historical coarse map file to use.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;26: the rate of forest change from historical.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;27: the time (in generations) since the historical forest was seen.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;28: the dispersal sigma value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;29: the sample mask, with binary 1:0 values for areas that we want to sample from. If this is not provided then this will default to mapping the entire grid.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;30: a file containing a tab-separated list of sample points in time (in generations). If this is null then only the present day will be sampled.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;31-onwards: speciation rates to be applied at the end of the simulation&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Note that using the -f flag prohibits more than one two historic maps being used.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Would you like to run with the default settings? (Y/N)&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">writeWarning</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="n">string</span> <span class="n">cDef</span><span class="p">;</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">cDef</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cDef</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span><span class="o">||</span><span class="n">cDef</span><span class="o">==</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Possible command line arguments: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-h/-help: Show the help file.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-d/-D: Run with default small parameters.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-dl/-DL: Run with default large parameters.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-dx/-DX: Run with the default very large parameters.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-c/-config: Run with the supplied config file.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span> <span class="c1">// exit the program right away as there is no need to continue if there is no simulation to run!</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-r&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-R&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-resume&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;resuming&quot;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Incorrect number of parameters provided for resuming simulation. Expecting:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;1: -r flag&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;2: the folder containing the paused simulation (should hold a &#39;Pause&#39; folder)&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;3: the simulation seed&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;4: the simulation task&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;5: the time to run the simulation for&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="n">bResume</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">has_paused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Import the default parameters if required.</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-d&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-D&quot;</span><span class="o">||</span><span class="n">bCheckUser</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">runAsDefault</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
        <span class="n">bCheckUser</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dl&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-DL&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dL&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-Dl&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">runLarge</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
        <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dx&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-dX&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-DX&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-Dx&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">runXL</span><span class="p">(</span><span class="n">comargs</span><span class="p">);</span>
        <span class="n">bCheckUser</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-c&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-C&quot;</span><span class="o">||</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-config&quot;</span><span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-Config&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Check that the config file is supplied.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_011: FATAL. -c or -config used to attempt import from &quot;</span>
                                         <span class="s">&quot;config file, but no config file provided.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">bConfig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">bFullmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-f&quot;</span> <span class="o">||</span> <span class="n">comargs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-f&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">writeInfo</span><span class="p">(</span><span class="s">&quot;Full command-line mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">bFullmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">removeComOption</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">comargs</span><span class="p">);</span>
    <span class="n">removeComOption</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">comargs</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bFullmode</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">&lt;</span><span class="mi">31</span><span class="o">&amp;&amp;!</span><span class="n">bCheckUser</span> <span class="o">&amp;&amp;!</span><span class="n">bConfig</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">err</span> <span class="o">=</span> <span class="s">&quot;ERROR_MAIN_000: FATAL.  Incorrect arguments supplied (&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; supplied; expected 30).&quot;</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
        <span class="c1">// note argc-1 which takes in to account the automatic generation of one command line argument which is the number of arguments.</span>
    <span class="p">}</span>
    <span class="n">argc</span> <span class="o">=</span> <span class="n">comargs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">checkFolders</span><span class="p">()</span>
<span class="p">{</span>

    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Checking folder existance...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">bFineMap</span><span class="p">,</span> <span class="n">bCoarseMap</span><span class="p">,</span> <span class="n">bFineMapHistorical</span><span class="p">,</span> <span class="n">bCoarseMapHistorical</span><span class="p">,</span> <span class="n">bSampleMask</span><span class="p">,</span> <span class="n">bOutputFolder</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bFineMap</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_file</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">FatalException</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">writeError</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="n">bFineMap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bCoarseMap</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_file</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">FatalException</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">writeError</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="n">bCoarseMap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bFineMapHistorical</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">historical_fine_map_file</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">FatalException</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">writeError</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="n">bFineMapHistorical</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bCoarseMapHistorical</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">historical_coarse_map_file</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">FatalException</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">writeError</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="n">bCoarseMapHistorical</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">bOutputFolder</span> <span class="o">=</span> <span class="n">checkOutputDirectory</span><span class="p">();</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">bSampleMask</span> <span class="o">=</span> <span class="n">doesExistNull</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_mask_file</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">FatalException</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">writeError</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="n">bSampleMask</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bFineMap</span> <span class="o">&amp;&amp;</span> <span class="n">bCoarseMap</span> <span class="o">&amp;&amp;</span> <span class="n">bFineMapHistorical</span> <span class="o">&amp;&amp;</span> <span class="n">bCoarseMapHistorical</span> <span class="o">&amp;&amp;</span> <span class="n">bOutputFolder</span> <span class="o">&amp;&amp;</span> <span class="n">bSampleMask</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Checking folder existance...done!                                                                &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">writeInfo</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;Required files do not all exist. Check program inputs.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">setParameters</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">has_imported_vars</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Tree</span><span class="o">::</span><span class="n">setParameters</span><span class="p">();</span>
        <span class="c1">// Set the variables equal to the value from the Mapvars object.</span>
        <span class="n">fine_map_input</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_file</span><span class="p">;</span>
        <span class="n">coarse_map_input</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_file</span><span class="p">;</span>
        <span class="c1">// historical map information</span>
        <span class="n">historical_fine_map_input</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">historical_fine_map_file</span><span class="p">;</span>
        <span class="n">historical_coarse_map_input</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">historical_coarse_map_file</span><span class="p">;</span>
        <span class="n">desired_specnum</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">desired_specnum</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">landscape_type</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sim_parameters</span><span class="p">.</span><span class="n">landscape_type</span> <span class="o">=</span> <span class="s">&quot;closed&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_method</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_method</span> <span class="o">=</span> <span class="s">&quot;normal&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_001: Variables already imported.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">importMaps</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">has_imported_vars</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Set the dimensions</span>
        <span class="n">landscape</span><span class="p">.</span><span class="n">setDims</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_parameters</span><span class="p">);</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// Set the time variables</span>
            <span class="n">landscape</span><span class="p">.</span><span class="n">checkMapExists</span><span class="p">();</span>
            <span class="c1">// landscape.setTimeVars(gen_since_historical,habitat_change_rate);</span>
            <span class="c1">// Import the fine map</span>
            <span class="n">landscape</span><span class="p">.</span><span class="n">calcFineMap</span><span class="p">();</span>
            <span class="c1">// Import the coarse map</span>
            <span class="n">landscape</span><span class="p">.</span><span class="n">calcCoarseMap</span><span class="p">();</span>
            <span class="c1">// Calculate the offset for the extremeties of each map</span>
            <span class="n">landscape</span><span class="p">.</span><span class="n">calcOffset</span><span class="p">();</span>
            <span class="c1">// Import the historical maps;</span>
            <span class="n">landscape</span><span class="p">.</span><span class="n">calcHistoricalFineMap</span><span class="p">();</span>
            <span class="n">landscape</span><span class="p">.</span><span class="n">calcHistoricalCoarseMap</span><span class="p">();</span>
            <span class="c1">// Calculate the maximum values</span>
            <span class="n">landscape</span><span class="p">.</span><span class="n">recalculateHabitatMax</span><span class="p">();</span>
            <span class="n">importReproductionMap</span><span class="p">();</span>
            <span class="n">samplegrid</span><span class="p">.</span><span class="n">importSampleMask</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="n">FatalException</span><span class="o">&amp;</span> <span class="n">fe</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span><span class="s">&quot;Problem setting up map files: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_002: Variables not imported.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">importReproductionMap</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">rep_map</span><span class="p">.</span><span class="n">import</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">reproduction_file</span><span class="p">,</span>
                   <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_x_size</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_y_size</span><span class="p">);</span>
    <span class="n">rep_map</span><span class="p">.</span><span class="n">setOffsets</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_x_offset</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_y_offset</span><span class="p">,</span>
                       <span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_x_size</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_y_size</span><span class="p">);</span>
    <span class="c1">// Now verify that the reproduction map is always non-zero when the density is non-zero.</span>
    <span class="n">verifyReproductionMap</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">getInitialCount</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">initcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// Get a count of the number of individuals on the grid.</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getDefault</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">max_x</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_x_size</span><span class="p">;</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_y_size</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">uses_spatial_sampling</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">max_x</span> <span class="o">=</span> <span class="n">samplegrid</span><span class="p">.</span><span class="n">sample_mask_exact</span><span class="p">.</span><span class="n">getCols</span><span class="p">();</span>
                <span class="n">max_y</span> <span class="o">=</span> <span class="n">samplegrid</span><span class="p">.</span><span class="n">sample_mask_exact</span><span class="p">.</span><span class="n">getRows</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">max_x</span> <span class="o">=</span> <span class="n">samplegrid</span><span class="p">.</span><span class="n">sample_mask</span><span class="p">.</span><span class="n">getCols</span><span class="p">();</span>
                <span class="n">max_y</span> <span class="o">=</span> <span class="n">samplegrid</span><span class="p">.</span><span class="n">sample_mask</span><span class="p">.</span><span class="n">getRows</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_y</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_x</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">xwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">ywrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">samplegrid</span><span class="p">.</span><span class="n">recalculate_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">);</span>
                <span class="n">initcount</span> <span class="o">+=</span> <span class="n">getIndividualsSampled</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">// Set active and data at the correct sizes.</span>
    <span class="k">if</span><span class="p">(</span><span class="n">initcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Initial count is 0. No individuals to simulate. Exiting program.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">writeInfo</span><span class="p">(</span><span class="s">&quot;Initial count is &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">initcount</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">initcount</span> <span class="o">&gt;</span> <span class="mi">10000000000</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">writeWarning</span><span class="p">(</span><span class="s">&quot;Initial count extremely large, RAM issues likely: &quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">initcount</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">initcount</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">setupDispersalCoordinator</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setHabitatMap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">landscape</span><span class="p">);</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setRandomNumber</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NR</span><span class="p">);</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setGenerationPtr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">generation</span><span class="p">);</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">setDispersal</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_method</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_file</span><span class="p">,</span>
                                        <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_x_size</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_y_size</span><span class="p">,</span>
                                        <span class="n">sim_parameters</span><span class="p">.</span><span class="n">m_prob</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sigma</span><span class="p">,</span>
                                        <span class="n">sim_parameters</span><span class="p">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">restrict_self</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">setup</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printSetup</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">has_paused</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">has_imported_pause</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">setResumeParameters</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">simResume</span><span class="p">();</span>
        <span class="n">setupDispersalCoordinator</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">setParameters</span><span class="p">();</span>
        <span class="n">setInitialValues</span><span class="p">();</span>
        <span class="n">importMaps</span><span class="p">();</span>
        <span class="n">setupDispersalCoordinator</span><span class="p">();</span>
        <span class="n">landscape</span><span class="p">.</span><span class="n">setLandscape</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">landscape_type</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
        <span class="n">landscape</span><span class="p">.</span><span class="n">validateMaps</span><span class="p">();</span>
<span class="cp">#endif</span>
        <span class="n">generateObjects</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">fillObjects</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">initial_count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">active</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">grid</span><span class="p">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_y_size</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_x_size</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">number_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Setting up simulation...filling grid                           &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
    <span class="n">writeInfo</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="c1">// Add the individuals to the grid, and add wrapped individuals to their correct locations.</span>
    <span class="c1">// This loop adds individuals to data and active (for storing the coalescence tree and active lineage tracking)</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
        <span class="kt">long</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_x_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_y_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>

                <span class="n">x</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

                <span class="n">x_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">y_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">samplegrid</span><span class="p">.</span><span class="n">recalculate_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">x_wrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y_wrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stored_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stored_nwrap</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">initialise</span><span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">fillList</span><span class="p">();</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">stored_nwrap</span><span class="p">);</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">stored_next</span><span class="p">);</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sample_amount</span> <span class="o">=</span> <span class="n">getIndividualsSampled</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">sample_amount</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">sample_amount</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">())</span>
                            <span class="p">{</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">number_start</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">initial_count</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">stringstream</span> <span class="n">msg</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start greater than initial count. Please report this error!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">number_start</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;. Initial count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">initial_count</span>
                                    <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                                <span class="k">throw</span> <span class="nf">out_of_range</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
                            <span class="p">}</span>
                            <span class="k">else</span>
                            <span class="p">{</span>
                                <span class="n">number_start</span><span class="o">++</span><span class="p">;</span>
                                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">list_position_in</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">number_start</span><span class="p">);</span>
                                <span class="c1">// Add the species to active</span>
                                <span class="n">active</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">number_start</span><span class="p">,</span> <span class="n">list_position_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                                <span class="c1">// Add a tip in the TreeNode for calculation of the coalescence tree at the</span>
                                <span class="c1">// end of the simulation.</span>
                                <span class="c1">// This also contains the start x and y position of the species.</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
                                <span class="n">endactive</span><span class="o">++</span><span class="p">;</span>
                                <span class="n">enddata</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sample_amount</span> <span class="o">=</span> <span class="n">getIndividualsSampled</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">sample_amount</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">sample_amount</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">number_start</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">initial_count</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">stringstream</span> <span class="n">msg</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start greater than initial count. Please report this error!&quot;</span><span class="p">;</span>
                                <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number start: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">number_start</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;. Initial count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">initial_count</span>
                                    <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                                <span class="k">throw</span> <span class="nf">out_of_range</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
                            <span class="p">}</span>
                            <span class="k">else</span>
                            <span class="p">{</span>
                                <span class="n">number_start</span><span class="o">++</span><span class="p">;</span>
                                <span class="c1">// Add the lineage to the wrapped lineages</span>
                                <span class="n">active</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span>
                                                           <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">y</span><span class="p">,</span>
                                                           <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="n">number_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                                <span class="n">addWrappedLineage</span><span class="p">(</span><span class="n">number_start</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                                <span class="c1">// Add a tip in the TreeNode for calculation of the coalescence tree at the</span>
                                <span class="c1">// end of the simulation.</span>
                                <span class="c1">// This also contains the start x and y position of the species.</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">);</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">number_start</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
                                <span class="n">endactive</span><span class="o">++</span><span class="p">;</span>
                                <span class="n">enddata</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">uses_spatial_sampling</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="n">samplegrid</span><span class="p">.</span><span class="n">convertBoolean</span><span class="p">(</span><span class="n">landscape</span><span class="p">,</span> <span class="n">deme_sample</span><span class="p">,</span> <span class="n">generation</span><span class="p">);</span>
            <span class="c1">// if there are no additional time points to sample at, we can remove the sample mask from memory.</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">uses_temporal_sampling</span> <span class="o">&amp;&amp;</span> <span class="n">this_step</span><span class="p">.</span><span class="n">time_reference</span> <span class="o">&lt;</span> <span class="n">reference_times</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span>
            <span class="p">{</span>
                <span class="n">samplegrid</span><span class="p">.</span><span class="n">clearSpatialMask</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">out_of_range</span> <span class="o">&amp;</span><span class="n">out_of_range1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Fatal exception thrown when filling grid (out_of_range): &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">out_of_range1</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">fe</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;Fatal exception thrown when filling grid (other) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">number_start</span> <span class="o">==</span> <span class="n">initial_count</span><span class="p">)</span>  <span class="c1">// Check that the two counting methods match up.</span>
    <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">initial_count</span> <span class="o">&gt;</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">number_start</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">writeWarning</span><span class="p">(</span><span class="s">&quot;Data usage higher than neccessary - check allocation of individuals to the grid.&quot;</span><span class="p">);</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Initial count: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">initial_count</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  Number counted: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">number_start</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">writeWarning</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">validateLineages</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">number_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">getIndividualsSampled</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">x_wrap</span><span class="p">,</span>
                                          <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">y_wrap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">current_gen</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">//  if(sim_parameters.uses_spatial_sampling)</span>
<span class="c1">//  {</span>
        <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">deme_sample</span> <span class="o">*</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                         <span class="o">*</span> <span class="n">samplegrid</span><span class="p">.</span><span class="n">getExactValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">));</span>
<span class="c1">//  }</span>
<span class="c1">//  else</span>
<span class="c1">//  {</span>
<span class="c1">//      return static_cast&lt;unsigned long&gt;(max(floor(deme_sample * landscape.getVal(x, y, x_wrap, y_wrap, 0.0)), 0.0));</span>
<span class="c1">//  }</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">removeOldPosition</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">chosen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="n">nwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
    <span class="kt">long</span> <span class="n">oldx</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">();</span>
    <span class="kt">long</span> <span class="n">oldy</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>

        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_015: Nwrap not set correctly. Nwrap 0, but x and y wrap not 0. &quot;</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DEBUG</span>
<span class="c1">// Then the lineage exists in the main list;</span>
<span class="c1">// debug (can be removed later)</span>
<span class="cp">#ifdef historical_mode</span>
        <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;grid maxsize: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">writeCritical</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize. Check move programming function.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="c1">// delete the species from the list</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">deleteSpecies</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">());</span>
        <span class="c1">// clear out the variables.</span>
        <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>  <span class="c1">// need to loop over the nwrap to check nexts</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">());</span>
            <span class="c1">// Now reduce the nwrap of the lineages that have been effected.</span>
            <span class="kt">long</span> <span class="n">nextpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="c1">// loop over the rest of the list, reducing the nwrap</span>
            <span class="k">while</span><span class="p">(</span><span class="n">nextpos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">active</span><span class="p">[</span><span class="n">nextpos</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
                <span class="n">nextpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">nextpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="c1">// decrease the nwrap</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">lastpos</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span>
                  <span class="n">chosen</span><span class="p">)</span>  <span class="c1">// loop until we reach the next, then set the next correctly.</span>
            <span class="p">{</span>
                <span class="n">lastpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">lastpos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNext</span><span class="p">());</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging last position: &quot;</span><span class="p">);</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
                    <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging chosen position: &quot;</span><span class="p">);</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
                    <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022: nwrap setting of either chosen or the &quot;</span>
                                          <span class="s">&quot;lineage wrapped before chosen. Check move function.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DEBUG</span>
                <span class="n">lastpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">while</span><span class="p">(</span><span class="n">lastpos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
                    <span class="n">lastpos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">lastpos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging chosen&quot;</span><span class="p">);</span>
                <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="cp">#endif </span><span class="c1">// DEBUG</span>
                <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MOVE_024: Last position before chosen is 0 - this is impossible.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">decreaseNwrap</span><span class="p">();</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">long</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">iCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">c</span><span class="o">++</span><span class="p">;</span>
                <span class="n">iCount</span><span class="o">++</span><span class="p">;</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_014: Wrapping exceeds numeric limits.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">iCount</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; Counted lineages: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">iCount</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_014: Nwrap not set correctly after move for grid cell&quot;</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DEBUG</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">calcMove</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dispersal_coordinator</span><span class="p">.</span><span class="n">disperse</span><span class="p">(</span><span class="n">this_step</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">long</span> <span class="kt">double</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">calcMinMax</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">current</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// this formula calculates the speciation rate required for speciation to have occured on this branch.</span>
    <span class="c1">// need to allow for the case that the number of gens was 0</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">newminmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">oldminmax</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getMinmax</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getReference</span><span class="p">()].</span><span class="n">getGenRate</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">newminmax</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getReference</span><span class="p">()].</span><span class="n">getSpecRate</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// variables need to be defined separately for the decimal division to function properly.</span>
        <span class="kt">long</span> <span class="kt">double</span> <span class="n">tmpdSpec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getReference</span><span class="p">()].</span><span class="n">getSpecRate</span><span class="p">();</span>
        <span class="kt">long</span> <span class="kt">double</span> <span class="n">tmpiGen</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">current</span><span class="p">].</span><span class="n">getReference</span><span class="p">()].</span><span class="n">getGenRate</span><span class="p">();</span>
        <span class="n">newminmax</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tmpdSpec</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tmpiGen</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">toret</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">newminmax</span><span class="p">,</span> <span class="n">oldminmax</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">toret</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">calcNewPos</span><span class="p">(</span><span class="kt">bool</span><span class="o">&amp;</span> <span class="n">coal</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">,</span>
                      <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">coalchosen</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldx</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldy</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldxwrap</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">oldywrap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Calculate the new position of the move, whilst also calculating the probability of coalescence.</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">oldxwrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">oldywrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Debug check (to remove later)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span>
                <span class="s">&quot;ERROR_MOVE_006: NON FATAL. Nwrap not set correctly. Check move programming function.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// then the procedure is relatively simple.</span>
        <span class="c1">// check for coalescence</span>
        <span class="c1">// check if the grid needs to be updated.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">!=</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">setMaxsize</span><span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">generation</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">coalchosen</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getRandLineage</span><span class="p">(</span><span class="n">NR</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
        <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldx</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldy</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldxwrap</span> <span class="o">||</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldywrap</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging chosen:&quot;</span><span class="p">);</span>
                <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging coalchosen: &quot;</span><span class="p">);</span>
                <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
                <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_006: NON FATAL. Nwrap not set correctly. Please report this bug.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// then the lineage can be placed in the empty space.</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">tmplistindex</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="c1">// check</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">tmplistindex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">chosen</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_005: Grid index not set correctly for species. Check &quot;</span>
                                      <span class="s">&quot;move programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#ifdef historical_mode</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getListsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize. Check move programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListPosition</span><span class="p">(</span><span class="n">tmplistindex</span><span class="p">);</span>
            <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>  <span class="c1">// then coalescence has occured</span>
        <span class="p">{</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="c1">// DO THE COALESCENCE STUFF</span>
            <span class="n">coal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>  <span class="c1">// need to check all the possible places the lineage could be.</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">nwrap</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// then coalescence is possible and we need to loop over the nexts to check those that are</span>
        <span class="c1">// in the same position</span>
        <span class="p">{</span>
            <span class="c1">// Count the possible matches of the position.</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// Create an array containing the list of active references for those that match as</span>
            <span class="c1">// this stops us having to loop twice over the same list.</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">matchlist</span><span class="p">[</span><span class="n">nwrap</span><span class="p">];</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_active</span><span class="p">;</span>
            <span class="n">next_active</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="c1">// Count if the first &quot;next&quot; matches</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldxwrap</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldywrap</span><span class="p">)</span>
            <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022a: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
                <span class="n">matchlist</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_active</span><span class="p">;</span>  <span class="c1">// add the match to the list of matches.</span>
                <span class="n">matches</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// Now loop over the remaining nexts counting matches</span>
            <span class="c1">//#ifdef DEBUG</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ncount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="c1">//#endif</span>
            <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">next_active</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldxwrap</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldywrap</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">matchlist</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_active</span><span class="p">;</span>
                    <span class="n">matches</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// check</span>
                <span class="c1">//#ifdef DEBUG</span>
                <span class="n">ncount</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ncount</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022d: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">!=</span> <span class="n">ncount</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022c: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Matches now contains the number of lineages at the exact x,y, xwrap and ywrap position.</span>
            <span class="c1">// Check if there were no matches at all</span>
            <span class="k">if</span><span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">coalchosen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
                <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">());</span>
                <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>  <span class="c1">// if there were matches, generate a random number to see if coalescence occured or not</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">randwrap</span> <span class="o">=</span>
                    <span class="n">floor</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="c1">// Get the random reference from the match list.</span>
<span class="c1">// If the movement is to an empty space, then we can update the chain to include the new</span>
<span class="c1">// lineage.</span>
<span class="cp">#ifdef historical_mode</span>
                <span class="k">if</span><span class="p">(</span><span class="n">randwrap</span> <span class="o">&gt;</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span>
                        <span class="s">&quot;ERROR_MOVE_004: Randpos outside maxsize. Check move programming function&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">matches</span> <span class="o">&gt;</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_004: matches outside maxsize. Please report this bug.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;matches: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">matches</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                         <span class="o">&lt;&lt;</span> <span class="s">&quot;landscape value: &quot;</span>
                         <span class="o">&lt;&lt;</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
                <span class="k">if</span><span class="p">(</span><span class="n">randwrap</span> <span class="o">&gt;</span> <span class="n">matches</span><span class="p">)</span>  <span class="c1">// coalescence has not occured</span>
                <span class="p">{</span>
                    <span class="c1">// os &lt;&lt; &quot;This shouldn&#39;t happen&quot; &lt;&lt; endl;</span>
                    <span class="n">coalchosen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">next_active</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">());</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setListPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>  <span class="c1">// coalescence has occured</span>
                <span class="p">{</span>
                    <span class="n">coal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="n">coalchosen</span> <span class="o">=</span> <span class="n">matchlist</span><span class="p">[</span><span class="n">randwrap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                    <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setEndpoint</span><span class="p">(</span><span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldxwrap</span><span class="p">,</span> <span class="n">oldywrap</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span>
                            <span class="s">&quot;ERROR_MOVE_025: Coalescence attempted with lineage of 0.&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
<span class="cp">#ifdef historical_mode</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span>
                    <span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize. Check move programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="p">}</span>
        <span class="k">else</span>  <span class="c1">// just add the lineage to next.</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_026: No nwrap recorded, but next is non-zero.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">coalchosen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">coal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
<span class="c1">// check</span>
<span class="cp">#ifdef DEBUG</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">oldy</span><span class="p">][</span><span class="n">oldx</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_022b: Nwrap not set correctly in move.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">coalchosen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldx</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oldy</span> <span class="o">||</span>
               <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldxwrap</span> <span class="o">||</span> <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">oldywrap</span><span class="p">)</span>
            <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging chosen:&quot;</span><span class="p">);</span>
                <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging coalchosen: &quot;</span><span class="p">);</span>
                <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="cp">#endif </span><span class="c1">// DEBUG</span>
                <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_006b: NON FATAL. Nwrap not set correctly. Check move &quot;</span>
                                      <span class="s">&quot;programming function.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//#endif</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">switchPositions</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">chosen</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="k">if</span><span class="p">(</span><span class="n">chosen</span> <span class="o">&gt;</span> <span class="n">endactive</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_023: Chosen is greater than endactive. Check move function.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DEBUG</span>
    <span class="k">if</span><span class="p">(</span><span class="n">chosen</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// This routine assumes that the previous chosen position has already been deleted.</span>
        <span class="n">DataPoint</span> <span class="n">tmpdatactive</span><span class="p">;</span>
        <span class="n">tmpdatactive</span><span class="p">.</span><span class="n">setup</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">]);</span>
        <span class="c1">// now need to remove the chosen lineage from memory, by replacing it with the lineage that lies in the last</span>
        <span class="c1">// place.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
           <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// if the end lineage is simple, we can just copy it across.</span>
        <span class="p">{</span>
            <span class="c1">// check endactive</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span><span class="s">&quot;Nwrap is not set correctly for endactive (nwrap should be 0, but is &quot;</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ). Identified during switch of positions.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">writeError</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setSpecies</span><span class="p">(</span>
                <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getListpos</span><span class="p">(),</span> <span class="n">chosen</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">]);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">tmpdatactive</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>  <span class="c1">// else the end lineage is wrapped, and needs to be processed including the wrapping routines.</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span><span class="s">&quot;Nwrap is not set correctly for endactive (nwrap incorrectly 0).&quot;</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Identified during switch of positions.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">writeError</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="c1">//              os &lt;&lt; &quot;wrap&quot;&lt;&lt;endl;</span>
            <span class="kt">long</span> <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpnwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>

            <span class="c1">// if the wrapping is just once, we need to set the grid next to the chosen variable.</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmpnwrap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// check</span>
                <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="n">string</span><span class="p">(</span>
                        <span class="s">&quot;ERROR_MOVE_019: FATAL. Nwrap for endactive not set correctly. Nwrap is 1, but &quot;</span>
                        <span class="s">&quot;lineage at 1st position is &quot;</span> <span class="o">+</span>
                        <span class="n">to_string</span><span class="p">(</span>
                            <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()]</span>
                                <span class="p">.</span><span class="n">getNext</span><span class="p">())</span> <span class="o">+</span>
                        <span class="s">&quot;. Identified during the move.&quot;</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>  <span class="c1">// otherwise, we just set the next to chosen instead of endactive.</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="c1">// loop over nexts until we reach the right lineage.</span>
                <span class="k">while</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                    <span class="n">tmpcount</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">tmpcount</span> <span class="o">&gt;</span> <span class="n">tmpnwrap</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">writeLog</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s">&quot;ERROR_MOVE_013: NON FATAL. Looping has not encountered a match, &quot;</span>
                                <span class="s">&quot;despite going further than required. Check nwrap counting.&quot;</span><span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">tmpactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;gridnext: &quot;</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">]</span>
                                                                          <span class="p">.</span><span class="n">getXpos</span><span class="p">()]</span>
                                        <span class="p">.</span><span class="n">getNext</span><span class="p">()</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmpactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmpnwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpnwrap</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; tmpcount: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpcount</span>
                                 <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                            <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
                            <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s">&quot;Logging chosen:&quot;</span><span class="p">);</span>
                            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
                            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;No match found, please report this bug.&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DEBUG</span>
                <span class="p">}</span>
                <span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">chosen</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">]);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">tmpdatactive</span><span class="p">);</span>

            <span class="c1">// check - debugging</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">testwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">testnext</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">testwrap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">testnext</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">testnext</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="n">testnext</span> <span class="o">!=</span> <span class="n">chosen</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_009: Nwrap position not set correctly after coalescence. &quot;</span>
                                      <span class="s">&quot;Check move process.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">endactive</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">calcNextStep</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">calcMove</span><span class="p">();</span>
    <span class="c1">// Calculate the new position, perform the move if coalescence doesn&#39;t occur or</span>
    <span class="c1">// return the variables for the coalescence event if coalescence does occur.</span>
    <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">setEndpoint</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span>
                                         <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span>
                                         <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">);</span>
    <span class="n">calcNewPos</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">coal</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">coalchosen</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span>
               <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">estSpecnum</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// This bit has been removed as it has a very significant performance hit and is not required for most simulations.</span>
    <span class="c1">// As of version 3.2 it was fully compatible with the rest of the simulation, however. See estSpecnum for commented</span>
    <span class="c1">// code</span>
    <span class="c1">// (removed from here to make things tidier).</span>
    <span class="c1">// This bit was moved from runSimulation() to make things tidier there.</span>
    <span class="cm">/*</span>
<span class="cm">    if(steps%1000000==0)</span>
<span class="cm">{</span>
<span class="cm">            time(&amp;now);</span>
<span class="cm">            if(now - time_taken&gt;200&amp;&amp;dPercentComplete&gt;95)</span>
<span class="cm">            {</span>
<span class="cm">                            time(&amp;time_taken);</span>
<span class="cm">                            unsigned long specnum = est_specnum();</span>
<span class="cm">                            os &lt;&lt; &quot;Estimated number of species: &quot; &lt;&lt; specnum &lt;&lt;</span>
<span class="cm">                            flush;</span>
<span class="cm">                            if(specnum&lt;desired_specnum)</span>
<span class="cm">                            {</span>
<span class="cm">                                            os &lt;&lt; &quot; - desired</span>
<span class="cm">                                            number of species reached.&quot; &lt;&lt; endl &lt;&lt; &quot;Halting</span>
<span class="cm">                                            simulations...&quot; &lt;&lt; endl;</span>
<span class="cm">                                            bContinueSim = false;</span>
<span class="cm">                            }</span>
<span class="cm">                            else</span>
<span class="cm">                            {</span>
<span class="cm">                                            os &lt;&lt; endl;</span>
<span class="cm">                            }</span>
<span class="cm">            }</span>
<span class="cm">}</span>
<span class="cm">//*/</span>
    <span class="kt">long</span> <span class="kt">double</span> <span class="n">dMinmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// first loop to find the maximum speciation rate required</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="kt">double</span> <span class="n">tmpminmax</span> <span class="o">=</span> <span class="n">calcMinMax</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setMinmax</span><span class="p">(</span><span class="n">tmpminmax</span><span class="p">);</span>
        <span class="n">dMinmax</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">max</span><span class="p">(</span><span class="n">dMinmax</span><span class="p">,</span> <span class="n">tmpminmax</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isTip</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setExistence</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kt">double</span> <span class="n">maxret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getGenRate</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">maxret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">maxret</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getGenRate</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">// This is the line that compares the individual random numbers against the speciation rate.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getSpecRate</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="kt">double</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dMinmax</span><span class="p">),</span> <span class="n">maxret</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speciate</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">loop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getExistence</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getParent</span><span class="p">()].</span><span class="n">getExistence</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getParent</span><span class="p">()].</span><span class="n">setExistence</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iSpecies</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getExistence</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hasSpeciated</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">iSpecies</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">enddata</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qReset</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//      os &lt;&lt; &quot;Estimated species number is: &quot; &lt;&lt; iSpecies &lt;&lt; endl;</span>
    <span class="k">return</span> <span class="n">iSpecies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef historical_mode</span>
<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">historicalStepChecks</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span>
            <span class="n">string</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_008: Dispersal attempted from non-forest. Check dispersal function. Forest &quot;</span>
                   <span class="s">&quot;cover: &quot;</span> <span class="o">+</span>
                   <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span>
                                                         <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))));</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">incrementGeneration</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Tree</span><span class="o">::</span><span class="n">incrementGeneration</span><span class="p">();</span>
    <span class="n">landscape</span><span class="p">.</span><span class="n">updateMap</span><span class="p">(</span><span class="n">generation</span><span class="p">);</span>
    <span class="n">checkTimeUpdate</span><span class="p">();</span>
    <span class="c1">// check if the map is historical yet</span>
    <span class="n">landscape</span><span class="p">.</span><span class="n">checkHistorical</span><span class="p">(</span><span class="n">generation</span><span class="p">);</span>

<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">debugDispersal</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span>
            <span class="n">string</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_007: Dispersal attempted to non-forest. &quot;</span>
                   <span class="s">&quot;Check dispersal function. Forest cover: &quot;</span> <span class="o">+</span>
                   <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span><span class="p">,</span> <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span><span class="p">,</span>
                                                         <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span><span class="p">,</span> <span class="n">generation</span><span class="p">))));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">updateStepCoalescenceVariables</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Tree</span><span class="o">::</span><span class="n">updateStepCoalescenceVariables</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">rep_map</span><span class="p">.</span><span class="n">hasReproduced</span><span class="p">(</span><span class="n">NR</span><span class="p">,</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">(),</span>
                                 <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">(),</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()))</span>
    <span class="p">{</span>
        <span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span> <span class="o">=</span> <span class="n">NR</span><span class="p">.</span><span class="n">i0</span><span class="p">(</span><span class="n">endactive</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// cannot be 0</span>
    <span class="p">}</span>
    <span class="c1">// record old position of lineage</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldx</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">();</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldy</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">();</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldxwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">();</span>
    <span class="n">this_step</span><span class="p">.</span><span class="n">oldywrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">this_step</span><span class="p">.</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">();</span>
<span class="cp">#ifdef historical_mode</span>
    <span class="n">historicalStepChecks</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">addLineages</span><span class="p">(</span><span class="kt">double</span> <span class="n">generation_in</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// First loop over the grid to check for the number that needs to be added to active</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">added_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">added_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// Update the sample grid boolean mask, if required.</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">uses_spatial_sampling</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">samplegrid</span><span class="p">.</span><span class="n">convertBoolean</span><span class="p">(</span><span class="n">landscape</span><span class="p">,</span> <span class="n">deme_sample</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_x_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_y_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="kt">long</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">;</span>
            <span class="n">xwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ywrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">samplegrid</span><span class="p">.</span><span class="n">recalculate_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span> <span class="o">=</span> <span class="n">countCellExpansion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
                <span class="n">added_data</span> <span class="o">+=</span> <span class="n">getIndividualsSampled</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_to_add</span><span class="p">;</span>
                <span class="n">added_active</span> <span class="o">+=</span> <span class="n">num_to_add</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">added_data</span> <span class="o">+=</span> <span class="n">added_active</span><span class="p">;</span>
    <span class="c1">// now resize data and active if necessary</span>
    <span class="n">checkSimSize</span><span class="p">(</span><span class="n">added_data</span><span class="p">,</span> <span class="n">added_active</span><span class="p">);</span>
    <span class="c1">// Add the new lineages and modify the existing lineages within our sample area</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_x_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_y_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="kt">long</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">;</span>
            <span class="n">xwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ywrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">samplegrid</span><span class="p">.</span><span class="n">recalculate_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">samplegrid</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">// Count the number of new cells that we need to add (after making those that already exist into tips)</span>
                <span class="c1">// Note that this function won&#39;t make more tips than the proportion we are sampling</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span> <span class="o">=</span> <span class="n">countCellExpansion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
                <span class="n">expandCell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">,</span> <span class="n">num_to_add</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// double check sizes</span>
    <span class="k">if</span><span class="p">(</span><span class="n">enddata</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="n">endactive</span> <span class="o">&gt;=</span> <span class="n">active</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MAIN_012: FATAL. Enddata or endactive is greater than the size of the &quot;</span>
                              <span class="s">&quot;relevant object. Programming error likely.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">endactive</span> <span class="o">&gt;</span> <span class="n">startendactive</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">startendactive</span> <span class="o">=</span> <span class="n">endactive</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">validateLineages</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">simulationParametersSqlInsertion</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">to_execute</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO SIMULATION_PARAMETERS VALUES(&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span>
                 <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">the_task</span><span class="p">);</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;,&#39;&quot;</span> <span class="o">+</span> <span class="n">out_directory</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">boost</span><span class="o">::</span><span class="n">lexical_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">spec</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span>
                  <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">sigma</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">deme</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">deme_sample</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">maxtime</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_relative_cost</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">desired_specnum</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">habitat_change_rate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">gen_since_historical</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&#39;&quot;</span> <span class="o">+</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">times_file</span> <span class="o">+</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">coarse_map_input</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_x_size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_y_size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_x_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_y_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">coarse_map_scale</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">fine_map_input</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_x_size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_y_size</span><span class="p">);</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_x_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_y_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_mask_file</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_x_size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span>
                  <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_y_size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_x_size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_y_size</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_x_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">sample_y_offset</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">historical_coarse_map_input</span> <span class="o">+</span> <span class="s">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="n">historical_fine_map_input</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">sim_complete</span><span class="p">);</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;, &#39;&quot;</span> <span class="o">+</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_method</span> <span class="o">+</span> <span class="s">&quot;&#39;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">boost</span><span class="o">::</span><span class="n">lexical_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">m_prob</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">((</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">to_string</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">restrict_self</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, &#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">landscape_type</span> <span class="o">+</span> <span class="s">&quot;&#39;, &quot;</span><span class="p">;</span>
    <span class="c1">// Now save the protracted speciation variables (not relevant in this simulation scenario)</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="n">protractedVarsToString</span><span class="p">();</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;, &#39;&quot;</span> <span class="o">+</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">dispersal_file</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
    <span class="n">to_execute</span> <span class="o">+=</span> <span class="s">&quot;);&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">to_execute</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">simPause</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Completely changed how this sections works - it won&#39;t currently allow restarting of the simulations, but will</span>
    <span class="c1">// dump the data file to memory. - simply calls sqlCreate and sqlOutput.</span>
    <span class="c1">// sqlCreate();</span>
    <span class="c1">// sqlOutput();</span>

    <span class="c1">// This function saves the data to 4 files. One contains the main simulation parameters, the other 3 contain the</span>
    <span class="c1">// simulation results thus far</span>
    <span class="c1">// including the grid object, data object and active object.</span>
    <span class="n">string</span> <span class="n">pause_folder</span> <span class="o">=</span> <span class="n">initiatePause</span><span class="p">();</span>
    <span class="n">dumpMain</span><span class="p">(</span><span class="n">pause_folder</span><span class="p">);</span>
    <span class="n">dumpActive</span><span class="p">(</span><span class="n">pause_folder</span><span class="p">);</span>
    <span class="n">dumpData</span><span class="p">(</span><span class="n">pause_folder</span><span class="p">);</span>
    <span class="n">dumpMap</span><span class="p">(</span><span class="n">pause_folder</span><span class="p">);</span>
    <span class="n">completePause</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">dumpMap</span><span class="p">(</span><span class="n">string</span> <span class="n">pause_folder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// Output the data object</span>
        <span class="n">ofstream</span> <span class="n">out4</span><span class="p">;</span>
        <span class="n">string</span> <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_folder</span> <span class="o">+</span> <span class="s">&quot;Dump_map_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span><span class="p">;</span>
        <span class="n">out4</span> <span class="o">&lt;&lt;</span> <span class="n">setprecision</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
        <span class="n">out4</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">out4</span> <span class="o">&lt;&lt;</span> <span class="n">landscape</span><span class="p">;</span>
        <span class="n">out4</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to perform map dump to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pause_folder</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">writeCritical</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">simResume</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">initiateResume</span><span class="p">();</span>
    <span class="c1">// now load the objects</span>
    <span class="n">loadMainSave</span><span class="p">();</span>
    <span class="n">loadMapSave</span><span class="p">();</span>
    <span class="n">setObjectSizes</span><span class="p">();</span>
    <span class="n">loadActiveSave</span><span class="p">();</span>
    <span class="n">loadDataSave</span><span class="p">();</span>
    <span class="n">loadGridSave</span><span class="p">();</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_start</span><span class="p">);</span>
    <span class="n">writeInfo</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">sim_parameters</span><span class="p">.</span><span class="n">printVars</span><span class="p">();</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">loadGridSave</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">grid</span><span class="p">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_y_size</span><span class="p">,</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_x_size</span><span class="p">);</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...grid...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="c1">// New method for re-creating grid data from active lineages</span>
        <span class="c1">// First initialise the empty grid object</span>
        <span class="n">writeInfo</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_y_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">grid_x_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">initialise</span><span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">generation</span><span class="p">));</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">fillList</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// Now fill the grid object with lineages from active. Only need to loop once.</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setSpeciesEmpty</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getListpos</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">increaseListSize</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">runtime_error</span><span class="p">(</span>
                            <span class="s">&quot;Nwrap should not be 0 if x and y wrap are not 0. Programming error likely.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">setNext</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">increaseNwrap</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">msg</span><span class="p">;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;Failure to import grid from &quot;</span> <span class="o">+</span> <span class="n">file_to_open</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">loadMapSave</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">file_to_open</span><span class="p">;</span>
    <span class="c1">// Input the map object</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">os</span><span class="p">;</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">Loading data from temp file...map...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flush</span><span class="p">;</span>
        <span class="n">writeInfo</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
        <span class="n">ifstream</span> <span class="n">in5</span><span class="p">;</span>
        <span class="n">file_to_open</span> <span class="o">=</span> <span class="n">pause_sim_directory</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;/Pause/Dump_map_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_string</span><span class="p">(</span><span class="n">the_task</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span>
                       <span class="n">to_string</span><span class="p">(</span><span class="n">the_seed</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
        <span class="n">in5</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_to_open</span><span class="p">);</span>
        <span class="n">landscape</span><span class="p">.</span><span class="n">setDims</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sim_parameters</span><span class="p">);</span>
        <span class="n">in5</span> <span class="o">&gt;&gt;</span> <span class="n">landscape</span><span class="p">;</span>
        <span class="n">in5</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="n">importReproductionMap</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">string</span> <span class="n">msg</span><span class="p">;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;Failure to import map from &quot;</span> <span class="o">+</span> <span class="n">file_to_open</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">verifyReproductionMap</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sim_parameters</span><span class="p">.</span><span class="n">reproduction_file</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span> <span class="o">||</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">reproduction_file</span> <span class="o">==</span> <span class="s">&quot;null&quot;</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_y_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sim_parameters</span><span class="p">.</span><span class="n">fine_map_x_size</span><span class="p">;</span> <span class="n">j</span> <span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">rep_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getValFine</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;Reproduction map is zero where density is non-zero. &quot;</span>
                                                 <span class="s">&quot;This will cause an infinite loop.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getValFine</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rep_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">writeCritical</span><span class="p">(</span><span class="s">&quot;Density is zero where reproduction map is non-zero. This is likely incorrect.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">addWrappedLineage</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numstart</span><span class="p">,</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">numstart</span><span class="p">);</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">numstart</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_last</span> <span class="o">=</span> <span class="n">tmp_next</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">tmp_nwrap</span> <span class="o">++</span><span class="p">;</span>
            <span class="n">tmp_last</span> <span class="o">=</span> <span class="n">tmp_next</span><span class="p">;</span>
            <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">increaseNwrap</span><span class="p">();</span>
        <span class="n">active</span><span class="p">[</span><span class="n">tmp_last</span><span class="p">].</span><span class="n">setNext</span><span class="p">(</span><span class="n">numstart</span><span class="p">);</span>
        <span class="n">active</span><span class="p">[</span><span class="n">numstart</span><span class="p">].</span><span class="n">setNwrap</span><span class="p">(</span><span class="n">tmp_nwrap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="n">debugAddingLineage</span><span class="p">(</span><span class="n">numstart</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">countCellExpansion</span><span class="p">(</span><span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">xwrap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">ywrap</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">generation_in</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span><span class="o">&amp;</span> <span class="n">make_tips</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map_cover</span> <span class="o">=</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span> <span class="c1">// think I fixed a bug here...</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">map_cover</span> <span class="o">*</span> <span class="n">deme_sample</span> <span class="o">*</span>
                                                                            <span class="n">samplegrid</span><span class="p">.</span><span class="n">getExactValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                                                                                     <span class="n">xwrap</span><span class="p">,</span> <span class="n">ywrap</span><span class="p">)),</span>
                                                              <span class="mf">0.0</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xwrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ywrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">map_cover</span> <span class="o">&gt;=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">changePercentCover</span><span class="p">(</span><span class="n">map_cover</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="n">ref</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">num_to_add</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_active</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmp_active</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">make_tips</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">makeTip</span><span class="p">(</span><span class="n">tmp_active</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">num_to_add</span> <span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ref</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="k">while</span><span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">num_to_add</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">xwrap</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">ywrap</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">num_to_add</span><span class="o">--</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">make_tips</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">makeTip</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">num_to_add</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">expandCell</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="n">y</span><span class="p">,</span> <span class="kt">long</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="kt">long</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="kt">double</span> <span class="n">generation_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_to_add</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">num_to_add</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_to_add</span><span class="p">;</span> <span class="n">k</span> <span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">endactive</span> <span class="o">++</span><span class="p">;</span>
            <span class="n">enddata</span> <span class="o">++</span><span class="p">;</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">listpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// Add the species to active</span>
            <span class="k">if</span><span class="p">(</span><span class="n">x_wrap</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y_wrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">listpos</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">endactive</span><span class="p">);</span>
                <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="n">enddata</span><span class="p">,</span> <span class="n">listpos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="n">enddata</span><span class="p">,</span> <span class="n">listpos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">addWrappedLineage</span><span class="p">(</span><span class="n">endactive</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">enddata</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;Cannot add lineage - no space in data. &quot;</span>
                                              <span class="s">&quot;Check size calculations.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">endactive</span> <span class="o">&gt;=</span> <span class="n">active</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;Cannot add lineage - no space in active. &quot;</span>
                                              <span class="s">&quot;Check size calculations.&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Add a tip in the TreeNode for calculation of the coalescence tree at the</span>
            <span class="c1">// end of the simulation.</span>
            <span class="c1">// This also contains the start x and y position of the species.</span>
            <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setup</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_wrap</span><span class="p">,</span> <span class="n">y_wrap</span><span class="p">,</span> <span class="n">generation_in</span><span class="p">);</span>
            <span class="n">data</span><span class="p">[</span><span class="n">enddata</span><span class="p">].</span><span class="n">setSpec</span><span class="p">(</span><span class="n">NR</span><span class="p">.</span><span class="n">d01</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">validateLineages</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">fail</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">writeInfo</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Starting lineage validation...&quot;</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">endactive</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">DataPoint</span> <span class="n">tmp_datapoint</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="c1">// Validate the location exists</span>
        <span class="k">if</span><span class="p">(</span><span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">(),</span>
                            <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXwrap</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYwrap</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">printed</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">printed</span> <span class="o">++</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Map value: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">landscape</span><span class="p">.</span><span class="n">getVal</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">(),</span>
                                                           <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXwrap</span><span class="p">(),</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYwrap</span><span class="p">(),</span>
                                                           <span class="mf">0.0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span>
                   <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getListpos</span><span class="p">()))</span>
                <span class="p">{</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">count</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;problem in wrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; != &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                        <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active reference: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Grid wrapping: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
            <span class="n">tmp_datapoint</span><span class="p">.</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;Failure in lineage validation. Please report this bug.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">writeInfo</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">debugAddingLineage</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">numstart</span><span class="p">,</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tmp_nwrap</span> <span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="n">tmp_nwrap</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmp_nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;next = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_next</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;numstart: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numstart</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
            <span class="n">active</span><span class="p">[</span><span class="n">tmp_nwrap</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;Incorrect setting of nwrap in wrapped lineage, please report this bug.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">tmp_nwrap</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Grid nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Counted wrapping: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;active: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numstart</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="n">tmp_nwrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">tmp_next</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">tmp_nwrap</span> <span class="o">++</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmp_next: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_next</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;tmp_nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp_nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">tmp_next</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmp_next</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">writeLog</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;Grid wrapping value not set correctly&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SpatialTree</span><span class="o">::</span><span class="n">runChecks</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">chosen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">coalchosen</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">// final checks</span>
<span class="cp">#ifdef historical_mode</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
       <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_001: Listpos outside maxsize.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getListpos</span><span class="p">()</span> <span class="o">&gt;</span>
           <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getMaxsize</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
       <span class="n">active</span><span class="p">[</span><span class="n">coalchosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">coalchosen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_002: Coalchosen list_position outside maxsize.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="n">Tree</span><span class="o">::</span><span class="n">runChecks</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">coalchosen</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">tmpactive</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmpactive</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">tmpactive</span> <span class="o">!=</span> <span class="n">chosen</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">logActive</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
            <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_003: Nwrap not set correctly.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getXwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">active</span><span class="p">[</span><span class="n">chosen</span><span class="p">].</span><span class="n">getYwrap</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_10: Nwrap set to non-zero, but x and y wrap 0.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nwrap</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getNwrap</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nwrap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lineage at 1st position: &quot;</span>
                   <span class="o">&lt;&lt;</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                   <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
                <span class="k">throw</span> <span class="nf">FatalException</span><span class="p">(</span><span class="s">&quot;ERROR_MOVE_016: Nwrap for endactive not set correctly. Nwrap is 1, &quot;</span>
                                              <span class="s">&quot;but the lineage at 1st position is not endactive.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpcheck</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()][</span><span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()].</span><span class="n">getNext</span><span class="p">();</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpnwrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="n">tmpcheck</span> <span class="o">!=</span> <span class="n">endactive</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">tmpnwrap</span><span class="o">++</span><span class="p">;</span>
                <span class="n">tmpcheck</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">tmpcheck</span><span class="p">].</span><span class="n">getNext</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">tmpnwrap</span> <span class="o">&gt;</span> <span class="n">nwrap</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_017: NON FATAL. Nrap for endactive not set correctly; looped &quot;</span>
                            <span class="s">&quot;beyond nwrap and not yet found enactive.&quot;</span>
                       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                       <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                       <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span>
                       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                    <span class="n">writeLog</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmpnwrap</span> <span class="o">!=</span> <span class="n">nwrap</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ERROR_MOVE_018: NON FATAL. Nwrap for endactive not set correctly. Nwrap is &quot;</span>
                   <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; but endactive is at position &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmpnwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;endactive: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endactive</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                   <span class="o">&lt;&lt;</span> <span class="s">&quot;nwrap: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nwrap</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
                   <span class="o">&lt;&lt;</span> <span class="s">&quot;x,y: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getXpos</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">active</span><span class="p">[</span><span class="n">endactive</span><span class="p">].</span><span class="n">getYpos</span><span class="p">()</span>
                   <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;chosen: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chosen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/PyCoal_logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="file_necsim_SpatialTree.cpp.html"
                        title="previous chapter">File SpatialTree.cpp</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="file_necsim_SpatialTree.h.html"
                        title="next chapter">File SpatialTree.h</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/necsim/program_listing_file_necsim_SpatialTree.cpp.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="file_necsim_SpatialTree.h.html" title="File SpatialTree.h"
             >next</a> |</li>
        <li class="right" >
          <a href="file_necsim_SpatialTree.cpp.html" title="File SpatialTree.cpp"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pycoalescence 1.2.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="necsim_library.html" >necim</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="file_necsim_SpatialTree.cpp.html" >File SpatialTree.cpp</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Samuel Thompson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.
    </div>
  </body>
</html>